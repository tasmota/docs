<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation (Wiki) for Tasmota"><link href=https://tasmota.github.io/docs/Berry-Cookbook/ rel=canonical><link rel=icon href=../_media/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.3"><title>Berry Cookbook - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Barlow";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-8J08F8X90S"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-8J08F8X90S",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-8J08F8X90S",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#berry-cookbook class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title=Tasmota class="md-header__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tasmota </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Berry Cookbook </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../Features/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../ESP32/ class=md-tabs__link> ESP32 </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> <li class=md-tabs__item> <a href=http://tasmota.github.io/install class=md-tabs__link> Web Installer </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> News </span> </a> </li> <li class=md-nav__item> <a href=../About/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../Upgrading/ class=md-nav__link> <span class=md-ellipsis> Upgrading </span> </a> </li> <li class=md-nav__item> <a href=../MQTT/ class=md-nav__link> <span class=md-ellipsis> MQTT </span> </a> </li> <li class=md-nav__item> <a href=../Commands/ class=md-nav__link> <span class=md-ellipsis> Commands </span> </a> </li> <li class=md-nav__item> <a href=../Templates/ class=md-nav__link> <span class=md-ellipsis> Templates </span> </a> </li> <li class=md-nav__item> <a href=../Components/ class=md-nav__link> <span class=md-ellipsis> Components </span> </a> </li> <li class=md-nav__item> <a href=../Modules/ class=md-nav__link> <span class=md-ellipsis> Modules </span> </a> </li> <li class=md-nav__item> <a href=../Peripherals/ class=md-nav__link> <span class=md-ellipsis> Peripherals </span> </a> </li> <li class=md-nav__item> <a href=../WebUI/ class=md-nav__link> <span class=md-ellipsis> WebUI </span> </a> </li> <li class=md-nav__item> <a href=../Firmware-Builds/ class=md-nav__link> <span class=md-ellipsis> Firmware Builds </span> </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ class=md-nav__link> <span class=md-ellipsis> Compiling </span> </a> </li> <li class=md-nav__item> <a href=../Contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../Download/ class=md-nav__link> <span class=md-ellipsis> Download </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/discussions/categories/show-and-tell class=md-nav__link> <span class=md-ellipsis> Project Showcase </span> </a> </li> <li class=md-nav__item> <a href=../For-Developers/ class=md-nav__link> <span class=md-ellipsis> For Developers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Features/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../ADC/ class=md-nav__link> <span class=md-ellipsis> Analog Pin </span> </a> </li> <li class=md-nav__item> <a href=../ArtNet/ class=md-nav__link> <span class=md-ellipsis> ArtNet DMX </span> </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ class=md-nav__link> <span class=md-ellipsis> Buttons and Switches </span> </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ class=md-nav__link> <span class=md-ellipsis> DeepSleep </span> </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ class=md-nav__link> <span class=md-ellipsis> Device Groups </span> </a> </li> <li class=md-nav__item> <a href=../Universal-Display-Driver/ class=md-nav__link> <span class=md-ellipsis> Universal Display and Universal Touch drivers (uDisplay/uTouch) </span> </a> </li> <li class=md-nav__item> <a href=../Displays/ class=md-nav__link> <span class=md-ellipsis> Displays </span> </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ class=md-nav__link> <span class=md-ellipsis> Dynamic Sleep </span> </a> </li> <li class=md-nav__item> <a href=../I2CDEVICES/ class=md-nav__link> <span class=md-ellipsis> I2C Devices </span> </a> </li> <li class=md-nav__item> <a href=../I2S-Audio/ class=md-nav__link> <span class=md-ellipsis> I2S Audio </span> </a> </li> <li class=md-nav__item> <a href=../IPv6/ class=md-nav__link> <span class=md-ellipsis> IPv6 </span> </a> </li> <li class=md-nav__item> <a href=../Lights/ class=md-nav__link> <span class=md-ellipsis> Lights </span> </a> </li> <li class=md-nav__item> <a href=../Matter/ class=md-nav__link> <span class=md-ellipsis> Matter </span> </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ class=md-nav__link> <span class=md-ellipsis> PIR Motion Sensors </span> </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ class=md-nav__link> <span class=md-ellipsis> Power Monitoring Calibration </span> </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ class=md-nav__link> <span class=md-ellipsis> PWM Dimmer </span> </a> </li> <li class=md-nav__item> <a href=../Rules/ class=md-nav__link> <span class=md-ellipsis> Rules </span> </a> </li> <li class=md-nav__item> <a href=../Scripting-Language/ class=md-nav__link> <span class=md-ellipsis> Scripting Language </span> </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ class=md-nav__link> <span class=md-ellipsis> Shutters and Blinds </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_21> <label class=md-nav__link for=__nav_2_21 id=__nav_2_21_label tabindex=0> <span class=md-ellipsis> Protocol Bridging </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_21_label aria-expanded=false> <label class=md-nav__title for=__nav_2_21> <span class="md-nav__icon md-icon"></span> Protocol Bridging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../TasmotaClient/ class=md-nav__link> <span class=md-ellipsis> Arduino MCU </span> </a> </li> <li class=md-nav__item> <a href=../Bluetooth/ class=md-nav__link> <span class=md-ellipsis> BLE Gateway </span> </a> </li> <li class=md-nav__item> <a href=../DALI/ class=md-nav__link> <span class=md-ellipsis> DALI </span> </a> </li> <li class=md-nav__item> <a href=../HDMI_CEC/ class=md-nav__link> <span class=md-ellipsis> HDMI CEC </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ class=md-nav__link> <span class=md-ellipsis> IR Communication </span> </a> </li> <li class=md-nav__item> <a href=../Projector/ class=md-nav__link> <span class=md-ellipsis> LCD/DLP Projector Control </span> </a> </li> <li class=md-nav__item> <a href=../LoRa-and-LoRaWan-Bridge/ class=md-nav__link> <span class=md-ellipsis> LoRa and LoRaWan Bridge </span> </a> </li> <li class=md-nav__item> <a href=../Modbus-Bridge/ class=md-nav__link> <span class=md-ellipsis> Modbus Bridge </span> </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> <span class=md-ellipsis> OpenTherm </span> </a> </li> <li class=md-nav__item> <a href=../RF-Protocol/ class=md-nav__link> <span class=md-ellipsis> RF Communication </span> </a> </li> <li class=md-nav__item> <a href=../Serial-to-TCP-Bridge/ class=md-nav__link> <span class=md-ellipsis> Serial to TCP Bridge </span> </a> </li> <li class=md-nav__item> <a href=../TWAI/ class=md-nav__link> <span class=md-ellipsis> TWAI </span> </a> </li> <li class=md-nav__item> <a href=../Telegram/ class=md-nav__link> <span class=md-ellipsis> Telegram </span> </a> </li> <li class=md-nav__item> <a href=../Zigbee/ class=md-nav__link> <span class=md-ellipsis> Zigbee </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ class=md-nav__link> <span class=md-ellipsis> Smart Meter Interface </span> </a> </li> <li class=md-nav__item> <a href=../Thermostat/ class=md-nav__link> <span class=md-ellipsis> Thermostat </span> </a> </li> <li class=md-nav__item> <a href=../Timers/ class=md-nav__link> <span class=md-ellipsis> Timers </span> </a> </li> <li class=md-nav__item> <a href=../TLS/ class=md-nav__link> <span class=md-ellipsis> TLS Secured MQTT </span> </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ class=md-nav__link> <span class=md-ellipsis> TuyaMCU </span> </a> </li> <li class=md-nav__item> <a href=../UFS/ class=md-nav__link> <span class=md-ellipsis> Universal File System </span> </a> </li> <li class=md-nav__item> <a href=../Range-Extender/ class=md-nav__link> <span class=md-ellipsis> Wi-Fi Range Extender </span> </a> </li> <li class=md-nav__item> <a href=../Wireguard/ class=md-nav__link> <span class=md-ellipsis> Wireguard VPN </span> </a> </li> <li class=md-nav__item> <a href=../Tutorials/ class=md-nav__link> <span class=md-ellipsis> Projects and Tutorials </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> ESP32 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> ESP32 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ESP32/ class=md-nav__link> <span class=md-ellipsis> Tasmota32 Features </span> </a> </li> <li class=md-nav__item> <a href=../Berry/ class=md-nav__link> <span class=md-ellipsis> Berry </span> </a> </li> <li class=md-nav__item> <a href=../Bluetooth_ESP32/ class=md-nav__link> <span class=md-ellipsis> Bluetooth Low Energy </span> </a> </li> <li class=md-nav__item> <a href=../LVGL/ class=md-nav__link> <span class=md-ellipsis> LVGL </span> </a> </li> <li class=md-nav__item> <a href=../HASPmota/ class=md-nav__link> <span class=md-ellipsis> HASPmota </span> </a> </li> <li class=md-nav__item> <a href=../Matter/ class=md-nav__link> <span class=md-ellipsis> Matter </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-Extension/ class=md-nav__link> <span class=md-ellipsis> Tasmota Extension </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-Application/ class=md-nav__link> <span class=md-ellipsis> Tasmota Application Files </span> </a> </li> <li class=md-nav__item> <a href=../TFL/ class=md-nav__link> <span class=md-ellipsis> TensorFlow Lite </span> </a> </li> <li class=md-nav__item> <a href=../TouchPin/ class=md-nav__link> <span class=md-ellipsis> Touch GPIOs </span> </a> </li> <li class=md-nav__item> <a href=../Safeboot/ class=md-nav__link> <span class=md-ellipsis> Safeboot Partition Layout </span> </a> </li> <li class=md-nav__item> <a href=https://templates.blakadder.com/esp32 class=md-nav__link> <span class=md-ellipsis> Supported Devices </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Smart Home Integrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../Alexa/ class=md-nav__link> <span class=md-ellipsis> Alexa </span> </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ class=md-nav__link> <span class=md-ellipsis> AWS IoT </span> </a> </li> <li class=md-nav__item> <a href=../Domoticz/ class=md-nav__link> <span class=md-ellipsis> Domoticz </span> </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ class=md-nav__link> <span class=md-ellipsis> Home Assistant </span> </a> </li> <li class=md-nav__item> <a href=../Homebridge/ class=md-nav__link> <span class=md-ellipsis> Homebridge </span> </a> </li> <li class=md-nav__item> <a href=https://homey.app/en-us/app/com.paveld.tasmota/Tasmota-MQTT/ class=md-nav__link> <span class=md-ellipsis> Homey </span> </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ class=md-nav__link> <span class=md-ellipsis> HomeSeer </span> </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ class=md-nav__link> <span class=md-ellipsis> IP Symcon </span> </a> </li> <li class=md-nav__item> <a href=../KNX/ class=md-nav__link> <span class=md-ellipsis> KNX </span> </a> </li> <li class=md-nav__item> <a href=../NodeRed/ class=md-nav__link> <span class=md-ellipsis> NodeRed </span> </a> </li> <li class=md-nav__item> <a href=../nymea/ class=md-nav__link> <span class=md-ellipsis> nymea </span> </a> </li> <li class=md-nav__item> <a href=../Octoprint/ class=md-nav__link> <span class=md-ellipsis> OctoPrint </span> </a> </li> <li class=md-nav__item> <a href=../openHAB/ class=md-nav__link> <span class=md-ellipsis> openHAB </span> </a> </li> <li class=md-nav__item> <a href=../otto/ class=md-nav__link> <span class=md-ellipsis> Otto </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 class=md-nav__link> <span class=md-ellipsis> IOBroker </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter class=md-nav__link> <span class=md-ellipsis> Mozilla WebThings Adapter </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/hongtat/tasmota-connect class=md-nav__link> <span class=md-ellipsis> SmartThings </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/Gifford47/tasmohab/blob/master/README.md class=md-nav__link> <span class=md-ellipsis> Tasmohab </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Supported-Peripherals/ class=md-nav__link> <span class=md-ellipsis> Peripherals </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Supported Devices </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-nav__link> <span class=md-ellipsis> Configure Unknown Device </span> </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' class=md-nav__link> <span class=md-ellipsis> All Supported Devices </span> </a> </li> <li class=md-nav__item> <a href=../Pinouts/ class=md-nav__link> <span class=md-ellipsis> Wi-Fi Module Pinouts </span> </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ class=md-nav__link> <span class=md-ellipsis> Supported Modules </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Help </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ class=md-nav__link> <span class=md-ellipsis> Device Recovery </span> </a> </li> <li class=md-nav__item> <a href="https://discord.gg/Ks2Kzd4 " target='_blank""' class=md-nav__link> <span class=md-ellipsis> Discord Support </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=http://tasmota.github.io/install class=md-nav__link> <span class=md-ellipsis> Web Installer </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#adding-commands-to-tasmota class=md-nav__link> <span class=md-ellipsis> Adding commands to Tasmota </span> </a> <nav class=md-nav aria-label="Adding commands to Tasmota"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#trivial-example class=md-nav__link> <span class=md-ellipsis> Trivial example </span> </a> </li> <li class=md-nav__item> <a href=#general-form-of-the-custom-command-function class=md-nav__link> <span class=md-ellipsis> General form of the custom command function </span> </a> </li> <li class=md-nav__item> <a href=#more-complete-example class=md-nav__link> <span class=md-ellipsis> More complete example </span> </a> </li> <li class=md-nav__item> <a href=#responding-to-commands class=md-nav__link> <span class=md-ellipsis> Responding to commands </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#adding-a-button-to-the-main-menu class=md-nav__link> <span class=md-ellipsis> Adding a button to the Main menu </span> </a> </li> <li class=md-nav__item> <a href=#creating-an-i2c-driver class=md-nav__link> <span class=md-ellipsis> Creating an I2C driver </span> </a> <nav class=md-nav aria-label="Creating an I2C driver"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#step-by-step-approach class=md-nav__link> <span class=md-ellipsis> Step by step approach </span> </a> </li> <li class=md-nav__item> <a href=#full-example class=md-nav__link> <span class=md-ellipsis> Full example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#lvgl-touchscreen-with-3-relays class=md-nav__link> <span class=md-ellipsis> LVGL Touchscreen with 3 Relays </span> </a> </li> <li class=md-nav__item> <a href=#multi-zone-heating-controller class=md-nav__link> <span class=md-ellipsis> Multi-Zone Heating Controller </span> </a> </li> <li class=md-nav__item> <a href=#ethernet-network-flipper class=md-nav__link> <span class=md-ellipsis> Ethernet Network Flipper </span> </a> </li> <li class=md-nav__item> <a href=#tmp117-driver class=md-nav__link> <span class=md-ellipsis> TMP117 Driver </span> </a> </li> <li class=md-nav__item> <a href=#call-function-at-intervals class=md-nav__link> <span class=md-ellipsis> Call function at intervals </span> </a> </li> <li class=md-nav__item> <a href=#h-bridge-control class=md-nav__link> <span class=md-ellipsis> H-bridge control </span> </a> </li> <li class=md-nav__item> <a href=#flash-to-file class=md-nav__link> <span class=md-ellipsis> Flash to file </span> </a> </li> <li class=md-nav__item> <a href=#tank-sensor class=md-nav__link> <span class=md-ellipsis> Tank Sensor </span> </a> </li> <li class=md-nav__item> <a href=#home-assistant-controls-for-tasmota class=md-nav__link> <span class=md-ellipsis> Home Assistant Controls for Tasmota </span> </a> </li> <li class=md-nav__item> <a href=#build-mqtt-topic-string-based-on-fulltopic-configuration class=md-nav__link> <span class=md-ellipsis> Build MQTT topic string based on FullTopic configuration </span> </a> </li> <li class=md-nav__item> <a href=#wake-on-lan class=md-nav__link> <span class=md-ellipsis> Wake-on-LAN </span> </a> </li> <li class=md-nav__item> <a href=#other-resources class=md-nav__link> <span class=md-ellipsis> Other resources </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/Berry-Cookbook.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1 id=berry-cookbook>Berry Cookbook<a class=headerlink href=#berry-cookbook title="Permanent link">~</a></h1> <h2 id=adding-commands-to-tasmota>Adding commands to Tasmota<a class=headerlink href=#adding-commands-to-tasmota title="Permanent link">~</a></h2> <p>It is very easy to dynamically add a command to Tasmota with Berry.</p> <h3 id=trivial-example>Trivial example<a class=headerlink href=#trivial-example title="Permanent link">~</a></h3> <p>Let's start with the most simple command.</p> <p>Let's define a command <code>BrGC</code> that triggers a garbage collection and returns the memory allocated by Berry. We first define the function:</p> <div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>br_gc</span><span class=p>()</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>allocated</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>gc</span><span class=p>()</span><span class=w>    </span><span class=cm>#- trigger gc and return allocated memory -#</span>
<span class=w>  </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=w>  </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;BrGc&quot;:%i}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>allocated</span><span class=p>))</span>
<span class=k>end</span>
</code></pre></div> <p>And register the function:</p> <div class=highlight><pre><span></span><code><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;BrGc&#39;</span><span class=p>,</span><span class=w> </span><span class=n>br_gc</span><span class=p>)</span>
</code></pre></div> <p>Then in Tasmota Console:</p> <div class=highlight><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">brgc</span>

<span class="l l-Scalar l-Scalar-Plain">21:04:30.369 CMD</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">brgc</span>
<span class=nt>21:04:30.376 RSL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stat/tasmota_923B34/RESULT = {&quot;BrGc&quot;:5767}</span>
</code></pre></div> <h3 id=general-form-of-the-custom-command-function>General form of the custom command function<a class=headerlink href=#general-form-of-the-custom-command-function title="Permanent link">~</a></h3> <p>The custom command function have the general form below where parameters are optional:</p> <div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>function_name</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>,</span><span class=w> </span><span class=n>payload_json</span><span class=p>)</span>
<span class=w>  </span><span class=o>..</span><span class=p>.</span>
<span class=k>end</span>
</code></pre></div> <table> <thead> <tr> <th style="text-align: left;">Parameter</th> <th style="text-align: left;">Description</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;"><code>cmd</code></td> <td style="text-align: left;"><code>string</code> name of the command in lower case. Can be used if same function is used for multiple similar commands for example.</td> </tr> <tr> <td style="text-align: left;"><code>idx</code></td> <td style="text-align: left;">Command's index is the unsigned <code>integer</code> (optionally) added at the end of the command name before the parameters (like <code>Demo1</code>). Default to 1 if not specified.</td> </tr> <tr> <td style="text-align: left;"><code>payload</code></td> <td style="text-align: left;"><code>string</code> of the command line as without any parsing.</td> </tr> <tr> <td style="text-align: left;"><code>payload_json</code></td> <td style="text-align: left;">if the payload is a valid JSON, it is converted into a Berry <code>map</code> object.</td> </tr> </tbody> </table> <h3 id=more-complete-example>More complete example<a class=headerlink href=#more-complete-example title="Permanent link">~</a></h3> <p>In this example, we will create a new command called <code>LightGold</code> that turns the light on and sets it to color gold #FFD700. This command accepts an optional JSON payload with the argument <code>Dimmer</code> ranging from 0..100.</p> <p>First we define a new Berry function with the logic. This function takes 4 arguments:</p> <ol> <li><code>cmd</code>: the command name (with same case as it was registered). This is useful if you want to share the same code in multiple commands. Here <code>cmd</code> is <code>LightGold</code></li> <li><code>idx</code>: the command index used, default to 1.</li> <li><code>payload</code>: the raw payload of the command as string</li> <li><code>payload_json</code>: the payload parsed as JSON, or <code>nil</code> if the payload is not JSON</li> </ol> <p>Example:</p> <ul> <li>command <code>lightgold</code>: <code>cmd</code>=<code>LightGold</code>, <code>idx</code>=1, <code>payload</code>=<code>""</code>, <code>payload_json</code>=<code>nil</code></li> <li>command <code>LIGHTGOLD2</code>: <code>cmd</code>=<code>LightGold</code>, <code>idx</code>=2, <code>payload</code>=<code>""</code>, <code>payload_json</code>=<code>nil</code></li> <li>command <code>lightgold not sure</code>: <code>cmd</code>=<code>LightGold</code>, <code>idx</code>=1, <code>payload</code>=<code>'not sure'</code>, <code>payload_json</code>=<code>nil</code></li> <li>command <code>lightgold {"value":"some"}</code>: <code>cmd</code>=<code>LightGold</code>, <code>idx</code>=1, <code>payload</code>=<code>'{"value":"some"}'</code>, <code>payload_json</code>=<code>{'value':'some'}</code></li> </ul> <p>In Berry, arguments are always optional, so you don't need to define them if you don't need them.</p> <div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>light_gold</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>,</span><span class=w> </span><span class=n>payload_json</span><span class=p>)</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>50</span><span class=w>      </span><span class=cm>#- default brightness to 50% -#</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>bri</span>

<span class=w>  </span><span class=c1># parse payload</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=n>payload_json</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>payload_json</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;Dimmer&quot;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w>    </span><span class=c1># does the payload contain a &#39;dimmer&#39; field</span>
<span class=w>    </span><span class=n>dimmer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>payload_json</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;Dimmer&quot;</span><span class=p>))</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># set_light expects a brightness in range 0..255</span>
<span class=w>  </span><span class=n>bri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>scale_uint</span><span class=p>(</span><span class=n>dimmer</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>255</span><span class=p>)</span>

<span class=w>  </span><span class=c1># build the payload for set_light</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>light_payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=s1>&#39;power&#39;</span><span class=o>:</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;rgb&#39;</span><span class=o>:</span><span class=s1>&#39;FFD700&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;bri&#39;</span><span class=o>:</span><span class=n>bri</span><span class=p>}</span>

<span class=w>  </span><span class=cm>#- set the light values -#</span>
<span class=w>  </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>set_light</span><span class=p>(</span><span class=n>light_payload</span><span class=p>)</span>

<span class=w>  </span><span class=c1># report the command as successful</span>
<span class=w>  </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_done</span><span class=p>()</span>
<span class=k>end</span>
</code></pre></div> <p>Finally you need to register the command:</p> <div class=highlight><pre><span></span><code><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;LightGold&#39;</span><span class=p>,</span><span class=w> </span><span class=n>light_gold</span><span class=p>)</span>
</code></pre></div> <p>Example (in Tasmota console, not Berry console):</p> <div class=highlight><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">lightgold</span>

<span class="l l-Scalar l-Scalar-Plain">20:53:28.142 CMD</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">lightgold</span>
<span class=nt>20:53:28.151 RSL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stat/tasmota_923B34/RESULT = {&quot;POWER&quot;:&quot;ON&quot;}</span>
<span class=nt>20:53:28.153 RSL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stat/tasmota_923B34/POWER = ON</span>
<span class=nt>20:53:28.160 RSL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stat/tasmota_923B34/RESULT = {&quot;LightGold&quot;:&quot;Done&quot;}</span>

<span class="l l-Scalar l-Scalar-Plain">lightgold {&quot;Dimmer&quot;:20}</span>

<span class=nt>20:54:16.837 CMD</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">lightgold {&quot;Dimmer&quot;:20}</span>
<span class=nt>20:54:16.848 RSL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">stat/tasmota_923B34/RESULT = {&quot;LightGold&quot;:&quot;Done&quot;}</span>
</code></pre></div> <h3 id=responding-to-commands>Responding to commands<a class=headerlink href=#responding-to-commands title="Permanent link">~</a></h3> <p>Tasmota expects that you send a response to commands. You can use the following methods:</p> <ul> <li><code>tasmota.resp_cmnd_done()</code>: report command as <code>Done</code> (including translated versions)</li> <li><code>tasmota.resp_cmnd_error()</code>: report command as <code>Error</code></li> <li><code>tasmota.resp_cmnd_failed()</code>: report command as <code>Failed</code></li> <li><code>tasmota.resp_cmnd_str(&lt;msg&gt;)</code>: report an arbitrary string</li> <li><code>tasmota.resp_cmnd(&lt;json&gt;)</code>: report a custom JSON message (not prefixed by command name).</li> </ul> <h2 id=adding-a-button-to-the-main-menu>Adding a button to the Main menu<a class=headerlink href=#adding-a-button-to-the-main-menu title="Permanent link">~</a></h2> <p>Adding a button to the e.g. main menu can be achieved by using the message type <code>web_add_main_button()</code>. </p> <p>The method to be performed, when the user clicks the button is achieved by using the <code>web_sensor()</code> method checking for the presence of an argument and a possible value assigned to the argument. The class provides the necessary methods to read the arguments:</p> <ul> <li><code>webserver.has_arg(arg_name:string)</code>: -&gt; boolean, checks if an argument with this name exists</li> <li><code>webserver.arg_size()</code>: -&gt; integer, returns the number of arguments</li> <li><code>webserver.arg(arg_name:string or arg_index:int)</code>: -&gt; string, returns the value of the argument either by name or by position number [0..arg_size()-1]. If an argument has multiple values, you need to iterate using ints to get all values</li> <li><code>webserver.arg_name(arg_index:int)</code> -&gt; string, get the name of argument by index [0..arg_size()-1]</li> </ul> <p>Additionally the webserver class provides a new function of sending information to the Web UI by using the following methods</p> <ul> <li><code>webserver.content_send(content:string)</code></li> <li><code>webserver.content_send_style(content:string)</code></li> </ul> <p>Let's see an example implementation of button methods in a Driver class</p> <div class=highlight><pre><span></span><code><span class=kr>import</span><span class=w> </span><span class=n>webserver</span><span class=w> </span><span class=c1># import webserver class</span>

<span class=kd>class</span><span class=w> </span><span class=nc>MyButtonMethods</span>

<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>myOtherFunction</span><span class=p>(</span><span class=n>myValue</span><span class=p>)</span>
<span class=w>    </span><span class=cm>#- do something -#</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- create a method for adding a button to the main menu -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_add_main_button</span><span class=p>()</span>
<span class=w>    </span><span class=n>webserver</span><span class=p>.</span><span class=nf>content_send</span><span class=p>(</span><span class=s2>&quot;&lt;p&gt;&lt;/p&gt;&lt;button onclick=&#39;la(\&quot;&amp;m_toggle_main=1\&quot;);&#39;&gt;Toggle Main&lt;/button&gt;&quot;</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- create a method for adding a button to the configuration menu-#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_add_config_button</span><span class=p>()</span>
<span class=w>    </span><span class=cm>#- the onclick function &quot;la&quot; takes the function name and the respective value you want to send as an argument -#</span>
<span class=w>    </span><span class=n>webserver</span><span class=p>.</span><span class=nf>content_send</span><span class=p>(</span><span class=s2>&quot;&lt;p&gt;&lt;/p&gt;&lt;button onclick=&#39;la(\&quot;&amp;m_toggle_conf=1\&quot;);&#39;&gt;Toggle Conf&lt;/button&gt;&quot;</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- As we can add only one sensor method we will have to combine them besides all other sensor readings in one method -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_sensor</span><span class=p>()</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_toggle_main&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;button pressed&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_toggle_conf&quot;</span><span class=p>)</span><span class=w> </span><span class=c1># takes a string as argument name and returns a boolean</span>

<span class=w>      </span><span class=c1># we can even call another function and use the value as a parameter</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>myValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>webserver</span><span class=p>.</span><span class=nf>arg</span><span class=p>(</span><span class=s2>&quot;m_toggle_conf&quot;</span><span class=p>))</span><span class=w> </span><span class=c1># takes a string or integer(index of arguments) to get the value of the argument</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=nf>myOtherFunction</span><span class=p>(</span><span class=n>myValue</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>end</span>
<span class=w>  </span><span class=k>end</span>
<span class=n>d1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>MyButtonMethods</span><span class=p>()</span>
<span class=n>tasmota</span><span class=p>.</span><span class=nf>add_driver</span><span class=p>(</span><span class=n>d1</span><span class=p>)</span>
</code></pre></div> <h2 id=creating-an-i2c-driver>Creating an I2C driver<a class=headerlink href=#creating-an-i2c-driver title="Permanent link">~</a></h2> <p>Berry Scripting provides all necessary primitives for a complete I2C driver.</p> <h3 id=step-by-step-approach>Step by step approach<a class=headerlink href=#step-by-step-approach title="Permanent link">~</a></h3> <p>We will explore the different steps to write an I2C driver, and will take the MPU6886 as an example. The native driver already exists, and we'll rewrite it in Berry code.</p> <p><strong>Step 1: detect the device</strong></p> <p>I2C device are identified by address, only one device per address is allowed per I2C physical bus. Tasmota32 supports up to 2 I2C buses, using <code>wire1</code> or <code>wire2</code> objects.</p> <p>To simplify device detection, we provide the convenience method <code>tasmota.scan_wire()</code>. The first argument is the device address (0x68 for MPU6886). The optional second argument is the I2C Tasmota index, allowing to selectively disable some device families. See <code>I2CDevice</code> command and page XXX. The index number for MPU6886 is 58.</p> <div class=highlight><pre><span></span><code><span class=kd>class</span><span class=w> </span><span class=nc>MPU6886</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>wire</span><span class=w>     </span><span class=c1># contains the wire object if the device was detected</span>

<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>init</span><span class=p>()</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>wire_scan</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mi>58</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>
</code></pre></div> <p><code>self.wire</code> contains a reference to <code>wire1</code> if the device was detected on I2C bus 1, a reference to <code>wire2</code> if the device was detected on bus 2, or <code>nil</code> if the device was not detected, or if I2C index 58 was disabled through <code>I2CEnable</code>.</p> <p><strong>Step 2: verify the device</strong></p> <p>To make sure the device is actually an MPU6886, we check its signature by reading register 0x75. It should respond 0x19 (see datasheet for MPU6886).</p> <div class=highlight><pre><span></span><code><span class=p>[</span><span class=o>..</span><span class=p>.]</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>read</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x75</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mh>0x19</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- wrong device -#</span>
<span class=p>[</span><span class=o>..</span><span class=p>.]</span>
</code></pre></div> <p><strong>Step 3: initialize the device</strong></p> <p>We write a series of values in registers to configure the device as expected (see datasheet).</p> <div class=highlight><pre><span></span><code><span class=p>[</span><span class=o>..</span><span class=p>.]</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6B</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6B</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_PWR_MGMT_1</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6B</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_PWR_MGMT_1</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1C</span><span class=p>,</span><span class=w> </span><span class=mh>0x10</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_ACCEL_CONFIG - AFS_8G</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1B</span><span class=p>,</span><span class=w> </span><span class=mh>0x18</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_GYRO_CONFIG - GFS_2000DPS</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1A</span><span class=p>,</span><span class=w> </span><span class=mh>0x01</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_CONFIG</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x19</span><span class=p>,</span><span class=w> </span><span class=mh>0x05</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_SMPLRT_DIV</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x38</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_INT_ENABLE</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1D</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_ACCEL_CONFIG2</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6A</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_USER_CTRL</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x23</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_FIFO_EN</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x37</span><span class=p>,</span><span class=w> </span><span class=mh>0x22</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_INT_PIN_CFG</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x38</span><span class=p>,</span><span class=w> </span><span class=mh>0x01</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_INT_ENABLE</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
<span class=p>[</span><span class=o>..</span><span class=p>.]</span>
</code></pre></div> <p>We also pre-compute multiplier to convert raw values to actual values:</p> <div class=highlight><pre><span></span><code><span class=p>[</span><span class=o>..</span><span class=p>.]</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>gres</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2000</span><span class=mf>.0</span><span class=o>/</span><span class=mi>32768</span><span class=mf>.0</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=mf>.0</span><span class=o>/</span><span class=mi>32678</span><span class=mf>.0</span>
<span class=w>      </span><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;I2C: MPU6886 detected on bus &quot;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=na>bus</span><span class=p>))</span>
<span class=p>[</span><span class=o>..</span><span class=p>.]</span>
</code></pre></div> <p><strong>Step 4: read sensor value</strong></p> <p>We will detail here the acceleration senor; gyroscope works similarly and is not further detailed.</p> <p>Reading the x/y/z sensor requires to read 6 bytes as a <code>bytes()</code> object</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>read_bytes</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x3B</span><span class=p>,</span><span class=mi>6</span><span class=p>)</span>
</code></pre></div> <p>Each value is 2 bytes. We use <code>bytes.get(offset,size)</code> to extract 2-bytes values at offsets 0/2/4. The size is <code>-2</code> to indicate that values are encoded in Big Endian instead of Little Endian.</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
</code></pre></div> <p>Finally the read value is unsigned 16 bits, but the sensor value is signed 16 bits. We convert 16 bits unsigned to 16 bits signed.</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
</code></pre></div> <p>We then repeat for y and z:</p> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>read_accel</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>read_bytes</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x3B</span><span class=p>,</span><span class=mi>6</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>a1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=p>,</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=p>,</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=p>]</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span>
<span class=w>  </span><span class=k>end</span>
</code></pre></div> <p><strong>Step 5: read sensor every second</strong></p> <p>Simply override <code>every_second()</code></p> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>every_second</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_accel</span><span class=p>()</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_gyro</span><span class=p>()</span>
<span class=w>  </span><span class=k>end</span>
</code></pre></div> <p><strong>Step 6: display sensor value in Web UI</strong></p> <p>You need to override <code>web_sensor()</code> and provide the formatted string. <code>tasmota.web_send_decimal()</code> sends a string to the Web UI, and converts decimal numbers according to the locale settings.</p> <p>Tasmota uses specific markers:</p> <ul> <li><code>{s}</code>: start of line</li> <li><code>{m}</code>: separator between name and value</li> <li><code>{e}</code>: end of line</li> </ul> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=cm>#- display sensor value in the web UI -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_sensor</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 acc_x{m}%.3f G{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 acc_y{m}%.3f G{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 acc_z{m}%.3f G{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 gyr_x{m}%i dps{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 gyr_y{m}%i dps{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 gyr_z{m}%i dps{e}&quot;</span><span class=p>,</span>
<span class=w>              </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>web_send_decimal</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>
</code></pre></div> <p><strong>Step 7: publish JSON TelePeriod sensor value</strong></p> <p>Similarly to Web UI, publish sensor value as JSON.</p> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=cm>#- add sensor value to teleperiod -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>json_append</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>ax</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>ay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>az</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;,\&quot;MPU6886\&quot;:{\&quot;AX\&quot;:%i,\&quot;AY\&quot;:%i,\&quot;AZ\&quot;:%i,\&quot;GX\&quot;:%i,\&quot;GY\&quot;:%i,\&quot;GZ\&quot;:%i}&quot;</span><span class=p>,</span>
<span class=w>              </span><span class=n>ax</span><span class=p>,</span><span class=w> </span><span class=n>ay</span><span class=p>,</span><span class=w> </span><span class=n>az</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>response_append</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>
</code></pre></div> <h3 id=full-example>Full example<a class=headerlink href=#full-example title="Permanent link">~</a></h3> <p>The code can be loaded manually with copy/paste, or stored in flash and loaded at startup in <code>autoexec.be</code> as <code>load("mpu6886.be")</code>. Alternatively it can be loaded with a Tasmota native command or rule:</p> <div class=highlight><pre><span></span><code>Br load(&quot;mpu6886.be&quot;)
</code></pre></div> <p>See code example below for MPU6886:</p> <div class=highlight><pre><span></span><code><span class=cm>#-</span>
<span class=cm> - Example of I2C driver written in Berry</span>
<span class=cm> -</span>
<span class=cm> - Support for MPU6886 device found in M5Stack</span>
<span class=cm> - Alternative to xsns_85_mpu6886.ino </span>
<span class=cm> -#</span>

<span class=kd>class</span><span class=w> </span><span class=nc>MPU6886</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>wire</span><span class=w>          </span><span class=cm>#- if wire == nil then the module is not initialized -#</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>gres</span><span class=p>,</span><span class=w> </span><span class=n>ares</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>accel</span><span class=p>,</span><span class=w> </span><span class=n>gyro</span>

<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>init</span><span class=p>()</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>wire_scan</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mi>58</span><span class=p>)</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>read</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x75</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mh>0x19</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- wrong device -#</span>

<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6B</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6B</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_PWR_MGMT_1</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6B</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_PWR_MGMT_1</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1C</span><span class=p>,</span><span class=w> </span><span class=mh>0x10</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_ACCEL_CONFIG - AFS_8G</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1B</span><span class=p>,</span><span class=w> </span><span class=mh>0x18</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_GYRO_CONFIG - GFS_2000DPS</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1A</span><span class=p>,</span><span class=w> </span><span class=mh>0x01</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_CONFIG</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x19</span><span class=p>,</span><span class=w> </span><span class=mh>0x05</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_SMPLRT_DIV</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x38</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_INT_ENABLE</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x1D</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_ACCEL_CONFIG2</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x6A</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_USER_CTRL</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x23</span><span class=p>,</span><span class=w> </span><span class=mh>0x00</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_FIFO_EN</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x37</span><span class=p>,</span><span class=w> </span><span class=mh>0x22</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_INT_PIN_CFG</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=w> </span><span class=mh>0x38</span><span class=p>,</span><span class=w> </span><span class=mh>0x01</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>    </span><span class=c1># MPU6886_INT_ENABLE</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>delay</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>

<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>gres</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2000</span><span class=mf>.0</span><span class=o>/</span><span class=mi>32768</span><span class=mf>.0</span>
<span class=w>      </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>8</span><span class=mf>.0</span><span class=o>/</span><span class=mi>32678</span><span class=mf>.0</span>
<span class=w>      </span><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;I2C: MPU6886 detected on bus &quot;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=na>bus</span><span class=p>))</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- returns a list of 3 axis, float as g acceleration -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>read_accel</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>read_bytes</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x3B</span><span class=p>,</span><span class=mi>6</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a1</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>a1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=p>,</span><span class=w> </span><span class=n>a2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=p>,</span><span class=w> </span><span class=n>a3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>ares</span><span class=p>]</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- returns a list of 3 gyroscopes, int as dps (degree per second)  -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>read_gyro</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=p>.</span><span class=nf>read_bytes</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span><span class=mh>0x43</span><span class=p>,</span><span class=mi>6</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>g1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>g1</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>g1</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>g2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>g2</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>g2</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>g3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=mi>-2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>g3</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mh>0x8000</span><span class=w> </span><span class=n>g3</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mh>0x10000</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>g1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gres</span><span class=p>),</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>g2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gres</span><span class=p>),</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>g3</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gres</span><span class=p>)]</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- trigger a read every second -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>every_second</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_accel</span><span class=p>()</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_gyro</span><span class=p>()</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- display sensor value in the web UI -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_sensor</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 acc_x{m}%.3f G{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 acc_y{m}%.3f G{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 acc_z{m}%.3f G{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 gyr_x{m}%i dps{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 gyr_y{m}%i dps{e}&quot;</span><span class=o>..</span>
<span class=w>             </span><span class=s2>&quot;{s}MPU6886 gyr_z{m}%i dps{e}&quot;</span><span class=p>,</span>
<span class=w>              </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>web_send_decimal</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- add sensor value to teleperiod -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>json_append</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=kr>self</span><span class=p>.</span><span class=na>wire</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span><span class=w>  </span><span class=cm>#- exit if not initialized -#</span>
<span class=w>    </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>ax</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>ay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>az</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>accel</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;,\&quot;MPU6886\&quot;:{\&quot;AX\&quot;:%i,\&quot;AY\&quot;:%i,\&quot;AZ\&quot;:%i,\&quot;GX\&quot;:%i,\&quot;GY\&quot;:%i,\&quot;GZ\&quot;:%i}&quot;</span><span class=p>,</span>
<span class=w>              </span><span class=n>ax</span><span class=p>,</span><span class=w> </span><span class=n>ay</span><span class=p>,</span><span class=w> </span><span class=n>az</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>gyro</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>response_append</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>

<span class=k>end</span>
<span class=n>mpu6886</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>MPU6886</span><span class=p>()</span>
<span class=n>tasmota</span><span class=p>.</span><span class=nf>add_driver</span><span class=p>(</span><span class=n>mpu6886</span><span class=p>)</span>
</code></pre></div> <h2 id=lvgl-touchscreen-with-3-relays>LVGL Touchscreen with 3 Relays<a class=headerlink href=#lvgl-touchscreen-with-3-relays title="Permanent link">~</a></h2> <div class=highlight><pre><span></span><code><span class=cm>#- start LVGL and init environment -#</span>
<span class=n>lv</span><span class=p>.</span><span class=nf>start</span><span class=p>()</span>

<span class=n>hres</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=nf>get_hor_res</span><span class=p>()</span><span class=w>     </span><span class=c1># should be 240</span>
<span class=n>vres</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=nf>get_ver_res</span><span class=p>()</span><span class=w>     </span><span class=c1># should be 320</span>

<span class=n>scr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=nf>scr_act</span><span class=p>()</span><span class=w>          </span><span class=c1># default screean object</span>
<span class=n>f20</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=nf>montserrat_font</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w>  </span><span class=c1># load embedded Montserrat 20</span>
<span class=n>f28</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=nf>montserrat_font</span><span class=p>(</span><span class=mi>28</span><span class=p>)</span><span class=w>  </span><span class=c1># load embedded Montserrat 28</span>

<span class=cm>#- Background -#</span>
<span class=n>scr</span><span class=p>.</span><span class=nf>set_style_local_bg_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0x000066</span><span class=p>))</span><span class=w>  </span><span class=c1># background in dark blue #000066</span>

<span class=cm>#- Upper state line -#</span>
<span class=n>stat_line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>lv_label</span><span class=p>(</span><span class=n>scr</span><span class=p>)</span>
<span class=k>if</span><span class=w> </span><span class=n>f20</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=n>stat_line</span><span class=p>.</span><span class=nf>set_style_local_text_font</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=n>f20</span><span class=p>)</span><span class=w> </span><span class=k>end</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_long_mode</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>LABEL_LONG_SROLL</span><span class=p>)</span><span class=w>                                                  </span><span class=c1># auto scrolling if text does not fit</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_width</span><span class=p>(</span><span class=n>hres</span><span class=p>)</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_align</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>LABEL_ALIGN_LEFT</span><span class=p>)</span><span class=w>                                                      </span><span class=c1># align text left</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_style_local_bg_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0x000088</span><span class=p>))</span><span class=w>    </span><span class=c1># background #000088</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_style_local_bg_opa</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>OPA_COVER</span><span class=p>)</span><span class=w>            </span><span class=c1># 100% background opacity</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_style_local_text_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0xFFFFFF</span><span class=p>))</span><span class=w>  </span><span class=c1># text color #FFFFFF</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_text</span><span class=p>(</span><span class=s2>&quot;Tasmota&quot;</span><span class=p>)</span>
<span class=n>stat_line_height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stat_line</span><span class=p>.</span><span class=nf>get_height</span><span class=p>()</span>

<span class=cm>#- display wifi strength indicator icon (for professionals ;) -#</span>
<span class=n>stat_line</span><span class=p>.</span><span class=nf>set_style_local_pad_right</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=n>stat_line_height</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span>
<span class=n>wifi_bars</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>lv_wifi_bars</span><span class=p>(</span><span class=n>stat_line</span><span class=p>)</span>
<span class=n>wifi_bars</span><span class=p>.</span><span class=nf>set_style_local_bg_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>BLACK</span><span class=p>))</span>
<span class=n>wifi_bars</span><span class=p>.</span><span class=nf>set_height</span><span class=p>(</span><span class=n>stat_line_height</span><span class=p>)</span>
<span class=n>wifi_bars</span><span class=p>.</span><span class=nf>set_width</span><span class=p>(</span><span class=n>stat_line_height</span><span class=p>)</span>
<span class=n>wifi_bars</span><span class=p>.</span><span class=nf>set_x</span><span class=p>(</span><span class=n>stat_line</span><span class=p>.</span><span class=nf>get_width</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>stat_line_height</span><span class=p>)</span>

<span class=cm>#- create a style for the buttons -#</span>
<span class=n>btn_style</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>lv_style</span><span class=p>()</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_radius</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=mi>10</span><span class=p>)</span><span class=w>                                                    </span><span class=c1># radius of rounded corners</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_bg_opa</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>OPA_COVER</span><span class=p>)</span><span class=w>                                          </span><span class=c1># 100% background opacity</span>
<span class=k>if</span><span class=w> </span><span class=n>f28</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=n>btn_style</span><span class=p>.</span><span class=nf>set_text_font</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=n>f28</span><span class=p>)</span><span class=w> </span><span class=k>end</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_bg_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0x33BBFF</span><span class=p>))</span><span class=w>                                  </span><span class=c1># background color #1FA3EC (Tasmota Blue)</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_border_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0x0000FF</span><span class=p>))</span><span class=w>                              </span><span class=c1># border color #0000FF</span>
<span class=c1>#btn_style.set_bg_color(lv.STATE_FOCUSED, lv_color(0x0000FF))                                  # background color when pressed #0000FF</span>
<span class=c1>#btn_style.set_border_color(lv.STATE_FOCUSED, lv_color(0xFFFFFF))                              # border color when pressed #FFFFFF</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_text_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_DEFAULT</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0x000000</span><span class=p>))</span><span class=w>                                </span><span class=c1># text color #FFFFFF</span>
<span class=cm>#- enabled -#</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_bg_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_CHECKED</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0x0000FF</span><span class=p>))</span><span class=w>                                  </span><span class=c1># background color #1FA3EC (Tasmota Blue)</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_text_color</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_CHECKED</span><span class=p>,</span><span class=w> </span><span class=nf>lv_color</span><span class=p>(</span><span class=mh>0xFFFFFF</span><span class=p>))</span><span class=w>                                </span><span class=c1># text color #FFFFFF</span>
<span class=n>btn_style</span><span class=p>.</span><span class=nf>set_outline_width</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>STATE_FOCUSED</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>                                              </span><span class=c1># remove focus outline, not needed with touchscreen</span>

<span class=cm>#- register buttons -#</span>
<span class=kd>var</span><span class=w> </span><span class=n>btns</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]</span><span class=w>         </span><span class=c1># relay buttons are added to this list to match with Tasmota relays</span>

<span class=cm>#- simple function to find the index of an element in a list -#</span>
<span class=kd>def</span><span class=w> </span><span class=nf>findinlist</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=mi>0</span><span class=o>..</span><span class=nb>size</span><span class=p>(</span><span class=n>l</span><span class=p>)</span><span class=mi>-1</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>l</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>x</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>i</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>

<span class=cm>#- callback function when a button is pressed -#</span>
<span class=cm>#- checks if the button is in the list, and react to EVENT_VALUE_CHANGED event -#</span>
<span class=kd>def</span><span class=w> </span><span class=nf>btn_event_cb</span><span class=p>(</span><span class=n>o</span><span class=p>,</span><span class=w> </span><span class=n>event</span><span class=p>)</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>btn_idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>findinlist</span><span class=p>(</span><span class=n>btns</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>)</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=n>btn_idx</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>EVENT_VALUE_CHANGED</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=nf>get_state</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>BTN_STATE_CHECKED_RELEASED</span><span class=w>   </span><span class=c1># true if checked, false if unchecked</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>set_power</span><span class=p>(</span><span class=n>btn_idx</span><span class=p>,</span><span class=w> </span><span class=o>!</span><span class=n>val</span><span class=p>)</span><span class=w>                          </span><span class=c1># toggle the value</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>

<span class=cm>#- create a button object, set style, register callback and add to global list -#</span>
<span class=cm>#- you still need to re-position the button -#</span>
<span class=kd>def</span><span class=w> </span><span class=nf>create_btn_relay</span><span class=p>(</span><span class=n>label</span><span class=p>)</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>btn</span><span class=p>,</span><span class=w> </span><span class=n>btn_label</span>
<span class=w>  </span><span class=n>btn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>lv_btn</span><span class=p>(</span><span class=n>scr</span><span class=p>)</span>
<span class=w>  </span><span class=n>btn</span><span class=p>.</span><span class=nf>set_pos</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span><span class=w> </span><span class=mi>30</span><span class=p>)</span>
<span class=w>  </span><span class=n>btn</span><span class=p>.</span><span class=nf>set_size</span><span class=p>(</span><span class=n>hres</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>60</span><span class=p>,</span><span class=w> </span><span class=mi>60</span><span class=p>)</span>
<span class=w>  </span><span class=n>btn</span><span class=p>.</span><span class=nf>add_style</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>btn_style</span><span class=p>)</span>
<span class=w>  </span><span class=n>btn</span><span class=p>.</span><span class=nf>set_checkable</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>                                                                      </span><span class=c1># enable toggle mode</span>
<span class=w>  </span><span class=n>btn_label</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>lv_label</span><span class=p>(</span><span class=n>btn</span><span class=p>)</span>
<span class=w>  </span><span class=n>btn_label</span><span class=p>.</span><span class=nf>set_text</span><span class=p>(</span><span class=n>label</span><span class=p>)</span>
<span class=w>  </span><span class=n>btn</span><span class=p>.</span><span class=nf>set_event_cb</span><span class=p>(</span><span class=n>btn_event_cb</span><span class=p>)</span><span class=w>                            </span><span class=c1># set callback to update Tasmota relays</span>
<span class=w>  </span><span class=n>btns</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=n>btn</span><span class=p>)</span><span class=w>                                            </span><span class=c1># append button to the list</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>btn</span>
<span class=k>end</span>

<span class=cm>#- create 3 buttons -#</span>
<span class=kd>var</span><span class=w> </span><span class=n>btn1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>create_btn_relay</span><span class=p>(</span><span class=s2>&quot;Relay 1&quot;</span><span class=p>)</span>
<span class=n>btn1</span><span class=p>.</span><span class=nf>set_y</span><span class=p>(</span><span class=mi>30</span><span class=p>)</span>
<span class=kd>var</span><span class=w> </span><span class=n>btn2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>create_btn_relay</span><span class=p>(</span><span class=s2>&quot;Relay 2&quot;</span><span class=p>)</span>
<span class=n>btn2</span><span class=p>.</span><span class=nf>set_y</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>
<span class=kd>var</span><span class=w> </span><span class=n>btn3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>create_btn_relay</span><span class=p>(</span><span class=s2>&quot;Relay 3&quot;</span><span class=p>)</span>
<span class=n>btn3</span><span class=p>.</span><span class=nf>set_y</span><span class=p>(</span><span class=mi>170</span><span class=p>)</span>

<span class=cm>#- update the buttons values according to internal relays status -#</span>
<span class=kd>def</span><span class=w> </span><span class=nf>btns_update</span><span class=p>()</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>power_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>get_power</span><span class=p>()</span><span class=w>                                            </span><span class=c1># get a list of booleans with status of each relay</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=n>b</span><span class=o>:</span><span class=n>btns</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>get_state</span><span class=p>()</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>power_state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>power_list</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>power_list</span><span class=p>.</span><span class=nf>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kc>false</span><span class=w>          </span><span class=c1># avoid exception if less relays than buttons</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>BTN_STATE_PRESSED</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>BTN_STATE_CHECKED_PRESSED</span><span class=w>     </span><span class=c1># update only if the button is not currently being pressed</span>
<span class=w>      </span><span class=n>b</span><span class=p>.</span><span class=nf>set_state</span><span class=p>(</span><span class=n>power_state</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>BTN_STATE_CHECKED_RELEASED</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>BTN_STATE_RELEASED</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>

<span class=cm>#- update every 500ms -#</span>
<span class=kd>def</span><span class=w> </span><span class=nf>btns_update_loop</span><span class=p>()</span>
<span class=w>  </span><span class=nf>btns_update</span><span class=p>()</span>
<span class=w>  </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>set_timer</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span><span class=w> </span><span class=n>btns_update_loop</span><span class=p>)</span>
<span class=k>end</span>
<span class=nf>btns_update_loop</span><span class=p>()</span><span class=w>  </span><span class=c1># start</span>

<span class=c1># If you change the style after creating the button, you need to update objects:</span>
<span class=kd>def</span><span class=w> </span><span class=nf>btns_refresh_style</span><span class=p>()</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=n>b</span><span class=o>:</span><span class=n>btns</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>refresh_style</span><span class=p>(</span><span class=n>lv</span><span class=p>.</span><span class=na>OBJ_PART_MAIN</span><span class=p>,</span><span class=w> </span><span class=n>lv</span><span class=p>.</span><span class=na>STYLE_PROP_ALL</span><span class=p>)</span><span class=w> </span><span class=k>end</span>
<span class=k>end</span>

<span class=c1># Button states, read and set with:</span>
<span class=c1>#   btn1.get_state()  or  btn1.set_state(lv.BTN_STATE_CHECKED_RELEASED)</span>
<span class=c1># Ex:</span>
<span class=c1>#    btn1.set_state(lv.BTN_STATE_RELEASED)</span>
<span class=c1>#    btn1.set_state(lv.BTN_STATE_CHECKED_RELEASED)</span>

<span class=cm>#- Here are the states for buttons -#</span>
<span class=c1># BTN_STATE_RELEASED</span>
<span class=c1># BTN_STATE_PRESSED</span>
<span class=c1># BTN_STATE_DISABLED</span>
<span class=c1># BTN_STATE_CHECKED_RELEASED</span>
<span class=c1># BTN_STATE_CHECKED_PRESSED</span>
<span class=c1># BTN_STATE_CHECKED_DISABLED</span>
</code></pre></div> <h2 id=multi-zone-heating-controller>Multi-Zone Heating Controller<a class=headerlink href=#multi-zone-heating-controller title="Permanent link">~</a></h2> <p>This project is a multi-zone heating controller written entirely in berry. It demonstrates the use of the persist module for saving/loading data; the webserver module for creating a custom "Manage Heating" user interface; dynamic loading of HTML from the file system; subscribing to a variety of rule triggers (using tasmota.add_rule); the implementation of custom commands (using tasmota.add_cmnd). It also makes good use of time functionality (via <code>tasmota.rtc</code>, <code>tasmota.time_dump</code>, <code>tasmota.set_timer</code> and <code>tasmota.strftime</code>). The project also includes an LCD I2C driver for running a basic 20x4 display. The entire driver is implemented using just the <code>tasmota.wire_scan</code> method.</p> <p><a href=https://github.com/Beormund/Tasmota32-Multi-Zone-Heating-Controller>https://github.com/Beormund/Tasmota32-Multi-Zone-Heating-Controller</a></p> <h2 id=ethernet-network-flipper>Ethernet Network Flipper<a class=headerlink href=#ethernet-network-flipper title="Permanent link">~</a></h2> <p>Used on board with Ethernet. If both Wi-Fi and Ethernet are active, turn off Wi-Fi. Place code in <code>autoexec.be</code> to execute on boot. You can call the function from Berry console any time with <code>netflip()</code>.</p> <div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>netflip</span><span class=p>()</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>eth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>eth</span><span class=p>().</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;ip&#39;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w>   </span><span class=c1>#1</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>wifi</span><span class=p>().</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;ip&#39;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>eth</span><span class=w>  </span><span class=c1>#2</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;Wifi &#39;</span><span class=w> </span><span class=o>..</span><span class=w> </span><span class=p>(</span><span class=n>eth</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w>     </span><span class=c1>#3</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>
<span class=n>tasmota</span><span class=p>.</span><span class=nf>set_timer</span><span class=p>(</span><span class=mi>30000</span><span class=p>,</span><span class=n>netflip</span><span class=p>)</span><span class=w>              </span><span class=c1>#4</span>
</code></pre></div> <ol> <li>store variable "eth" with Ethernet status - "true" if Ethernet IP exists and "false" if not</li> <li>check if wifi status is true and compare to eth status</li> <li>send command <code>Wifi</code> with parameter depending on eth variable. <code>..</code> is to concatenate a string. See Berry <a href=https://berry.readthedocs.io/en/latest/source/en/Chapter-3.html#operator-2>manual</a></li> <li>set a timer to execute the netflip function 30000ms (30 seconds) after loading <code>autoexec.be</code></li> </ol> <p>For newer Berry versions, there is an improved version:</p> <div class=highlight><pre><span></span><code><span class=c1># Ethernet Network Flipper - checks every 30 seconds if ethernet if up</span>
<span class=c1># if Ethernet is up, Wifi is turned off to avoid interference with Zigbee</span>
<span class=c1># if Ethernet is down, Wifi is turned back on to allow fallback connection</span>
<span class=kd>def</span><span class=w> </span><span class=nf>netflip</span><span class=p>()</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>eth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>eth</span><span class=p>(</span><span class=s1>&#39;up&#39;</span><span class=p>)</span><span class=w>                 </span><span class=c1>#1</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>wifi</span><span class=p>(</span><span class=s1>&#39;up&#39;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>eth</span><span class=w>                </span><span class=c1>#2</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;Wifi &#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>eth</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;0&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>))</span><span class=w>  </span><span class=c1>#3</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>set_timer</span><span class=p>(</span><span class=mi>30000</span><span class=p>,</span><span class=n>netflip</span><span class=p>)</span><span class=w>            </span><span class=c1>#4</span>
<span class=k>end</span>
<span class=n>tasmota</span><span class=p>.</span><span class=nf>set_timer</span><span class=p>(</span><span class=mi>30000</span><span class=p>,</span><span class=n>netflip</span><span class=p>)</span><span class=w>              </span><span class=c1>#5</span>
</code></pre></div> <ol> <li>store variable "eth" with Ethernet status - "true" if Ethernet IP exists and "false" if not</li> <li>check if wifi and eth are both up or both down</li> <li>send command <code>Wifi</code> with parameter depending on eth variable, turn Wifi on if eth is down, turn Wifi off if eth is up</li> <li>set a timer to execute the netflip function every 30000ms (30 seconds)</li> <li>set a timer to execute the netflip function 30000ms (30 seconds) after loading <code>autoexec.be</code></li> </ol> <h2 id=tmp117-driver>TMP117 Driver<a class=headerlink href=#tmp117-driver title="Permanent link">~</a></h2> <p><a href=https://github.com/TomsTek/tasmota-berry-TMP117-driver>TomsTek@GitHub</a></p> <h2 id=call-function-at-intervals>Call function at intervals<a class=headerlink href=#call-function-at-intervals title="Permanent link">~</a></h2> <p>This small helper function allows you to call a function at stable intervals, automatically correcting in case of latency or other deviations. Not suitable for very short intervals; while the delay interval is in milliseconds for consistency with the standard <code>tasmota.set_timer</code>, it would normally be seconds multiplied by 1000, like 60000 for every minute.</p> <p><div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>set_timer_modulo</span><span class=p>(</span><span class=n>delay</span><span class=p>,</span><span class=n>f</span><span class=p>,</span><span class=n>id</span><span class=p>)</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>now</span><span class=o>=</span><span class=n>tasmota</span><span class=p>.</span><span class=nf>millis</span><span class=p>()</span>
<span class=w>  </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>set_timer</span><span class=p>((</span><span class=n>now</span><span class=o>+</span><span class=n>delay</span><span class=o>/</span><span class=mi>4</span><span class=o>+</span><span class=n>delay</span><span class=p>)</span><span class=o>/</span><span class=n>delay</span><span class=o>*</span><span class=n>delay</span><span class=o>-</span><span class=n>now</span><span class=p>,</span><span class=w> </span><span class=kd>def</span><span class=p>()</span><span class=w> </span><span class=nf>set_timer_modulo</span><span class=p>(</span><span class=n>delay</span><span class=p>,</span><span class=n>f</span><span class=p>,</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=nf>f</span><span class=p>()</span><span class=w> </span><span class=k>end</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span>
<span class=k>end</span>
</code></pre></div> Note that the timer calculation will overflow after about 25 days of uptime, resulting in incorrect timer values. A better option is to use cron instead.</p> <h2 id=h-bridge-control>H-bridge control<a class=headerlink href=#h-bridge-control title="Permanent link">~</a></h2> <p>An H-bridge is an electronic circuit that switches the polarity of a voltage applied to a load. These circuits are often used in robotics and other applications to allow DC motors to run forwards or backwards.</p> <p>You can typically use 2 PWM channels to pilot a H-bridge, under the condition that both channels are never active at the same time; otherwise you may destroy your device. This means that phasing must be calculated so that one pulse started once the other pulse is inactive, and the sum of both duty cycles must not exceed 100%.</p> <p>The following Berry function ensures appropriate management of H-bridge:</p> <div class=highlight><pre><span></span><code><span class=c1>#</span>
<span class=c1># H_bridge class in Berry to pilot a H-bridge device</span>
<span class=c1>#</span>

<span class=kd>class</span><span class=w> </span><span class=nc>H_bridge</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>gpio1</span><span class=p>,</span><span class=w> </span><span class=n>gpio2</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>max</span>

<span class=w>  </span><span class=c1># init(phy_gpio1, phy_gpio2) - initialize H-bridge with the 2 GPIOs used to control it</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>gpio1</span><span class=p>,</span><span class=w> </span><span class=n>gpio2</span><span class=p>)</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>gpio1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gpio1</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>gpio2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gpio2</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>max</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1023</span><span class=w>     </span><span class=c1># max value of duty</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># set the value of both PWM values</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=n>v1</span><span class=p>,</span><span class=w> </span><span class=n>v2</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w>   </span><span class=n>v1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v2</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w>   </span><span class=n>v2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>v2</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>max</span>
<span class=w>      </span><span class=k>raise</span><span class=w> </span><span class=s2>&quot;value_error&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;the sum of duties must not exceed 100%&quot;</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=kr>import</span><span class=w> </span><span class=n>gpio</span>
<span class=w>    </span><span class=n>gpio</span><span class=p>.</span><span class=nf>set_pwm</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>gpio1</span><span class=p>,</span><span class=w> </span><span class=n>v1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>    </span><span class=n>gpio</span><span class=p>.</span><span class=nf>set_pwm</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>gpio2</span><span class=p>,</span><span class=w> </span><span class=n>v2</span><span class=p>,</span><span class=w> </span><span class=n>v1</span><span class=p>)</span><span class=w>    </span><span class=c1># dephase by value v1</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>
</code></pre></div> <p>Example of use:</p> <div class=highlight><pre><span></span><code><span class=kd>var</span><span class=w> </span><span class=n>hbridge</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>H_bridge</span><span class=p>(</span><span class=mi>12</span><span class=p>,</span><span class=w> </span><span class=mi>13</span><span class=p>)</span><span class=w>    </span><span class=c1># use GPIO12 and GPIO13</span>
<span class=n>hbridge</span><span class=p>.</span><span class=nf>set</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span><span class=mi>200</span><span class=p>)</span><span class=w>              </span><span class=c1># set values to 102/1023 and 204/1023, i.e. 10% and 20%</span>

<span class=n>hbridge</span><span class=p>.</span><span class=nf>set</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span><span class=mi>950</span><span class=p>)</span><span class=w>              </span><span class=c1># set values to 102/1023 and 950/1023, i.e. 10% and 93%</span>
<span class=n>BRY</span><span class=o>:</span><span class=w> </span><span class=n>Exception</span><span class=o>&gt;</span><span class=w> </span><span class=s1>&#39;value_error&#39;</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>duties</span><span class=w> </span><span class=n>must</span><span class=w> </span><span class=n>not</span><span class=w> </span><span class=n>exceed</span><span class=w> </span><span class=mi>100</span><span class=o>%</span>
</code></pre></div> <h2 id=flash-to-file>Flash to file<a class=headerlink href=#flash-to-file title="Permanent link">~</a></h2> <p>This is an example of dumping the content of the internal flash of the ESP32 and write the content in the file system that you can download back to your PC.</p> <p>The example below dumps the content of the safeboot partition.</p> <div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>flash_to_file</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>)</span>
<span class=w>  </span><span class=kr>import</span><span class=w> </span><span class=n>flash</span>
<span class=w>  </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>

<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;wb&quot;</span><span class=p>)</span>
<span class=w>  </span><span class=k>try</span>
<span class=w>    </span><span class=c1># Do 4KB chunks</span>

<span class=w>    </span><span class=k>while</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>chunk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>512</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>chunk</span><span class=w>    </span><span class=n>chunk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=k>end</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flash</span><span class=p>.</span><span class=nf>read</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>chunk</span><span class=p>)</span>
<span class=w>      </span><span class=nb>print</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;0x%06X - %s (%i)&quot;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=nb>str</span><span class=p>(</span><span class=n>b</span><span class=p>),</span><span class=w> </span><span class=n>chunk</span><span class=p>))</span>
<span class=w>      </span><span class=n>f</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
<span class=w>      </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>

<span class=w>      </span><span class=n>addr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>chunk</span>
<span class=w>      </span><span class=n>len</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>chunk</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=n>f</span><span class=p>.</span><span class=nf>close</span><span class=p>()</span>
<span class=w>  </span><span class=k>except</span><span class=w> </span><span class=o>..</span><span class=w> </span><span class=kr>as</span><span class=w> </span><span class=n>e</span><span class=p>,</span><span class=n>m</span>
<span class=w>    </span><span class=n>f</span><span class=p>.</span><span class=nf>close</span><span class=p>()</span>
<span class=w>  </span><span class=k>end</span>

<span class=k>end</span>

<span class=nf>flash_to_file</span><span class=p>(</span><span class=s2>&quot;safe_boot_flashed.bin&quot;</span><span class=p>,</span><span class=w> </span><span class=mh>0x10000</span><span class=p>,</span><span class=w> </span><span class=mi>768320</span><span class=p>)</span>
</code></pre></div> <h2 id=tank-sensor>Tank Sensor<a class=headerlink href=#tank-sensor title="Permanent link">~</a></h2> <p>Tank Sensor for fuel-oil volume measurement using a VL53L1X or SR04 sensor</p> <p><a href=https://github.com/trlafleur/Tasmota-Tank-Sensor>https://github.com/trlafleur/Tasmota-Tank-Sensor</a></p> <h2 id=home-assistant-controls-for-tasmota>Home Assistant Controls for Tasmota<a class=headerlink href=#home-assistant-controls-for-tasmota title="Permanent link">~</a></h2> <p>This is a Tasmota Berry Script library to greatly simplify the process of exposing Home Assistant controls (e.g. Pull-down Lists, Number Sliders, Sensors, etc.) from a Tasmota device - and handling the communication between both sides.</p> <p><a href=https://github.com/fmtr/hct>https://github.com/fmtr/hct</a></p> <h2 id=build-mqtt-topic-string-based-on-fulltopic-configuration>Build MQTT topic string based on FullTopic configuration<a class=headerlink href=#build-mqtt-topic-string-based-on-fulltopic-configuration title="Permanent link">~</a></h2> <p>This code bit illustrates how you can create a topic string in the form of the <code>FullTopic</code> specification. Details like which <code>%prefix%</code> you want and what topic last level are obviously variable. In a class, creating the variable makes snnse in <code>init()</code> to avoid issuing commands every time. Commands prefixed with <code>_</code> does avoid MQTT messages, but this feature is not available on older Tasmota version.</p> <div class=highlight><pre><span></span><code><span class=kd>var</span><span class=w> </span><span class=n>topic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>replace</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>replace</span><span class=p>(</span>
<span class=w>              </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;_FullTopic&#39;</span><span class=p>,</span><span class=kc>true</span><span class=p>)[</span><span class=s1>&#39;FullTopic&#39;</span><span class=p>],</span>
<span class=w>              </span><span class=s1>&#39;%topic%&#39;</span><span class=p>,</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;_Topic&#39;</span><span class=p>,</span><span class=kc>true</span><span class=p>)[</span><span class=s1>&#39;Topic&#39;</span><span class=p>]),</span>
<span class=w>              </span><span class=s1>&#39;%prefix%&#39;</span><span class=p>,</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;_Prefix&#39;</span><span class=p>,</span><span class=kc>true</span><span class=p>)[</span><span class=s1>&#39;Prefix3&#39;</span><span class=p>])</span>
<span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;SENSOR&#39;</span>
</code></pre></div> <h2 id=wake-on-lan>Wake-on-LAN<a class=headerlink href=#wake-on-lan title="Permanent link">~</a></h2> <p>The code below sends WoL (Wake on Lan) packets so you can wake up a device located on the same LAN.</p> <div class=highlight><pre><span></span><code><span class=kd>def</span><span class=w> </span><span class=nf>send_wake_on_lan</span><span class=p>(</span><span class=n>mac</span><span class=p>,</span><span class=w> </span><span class=n>broadcast_ip</span><span class=p>)</span>
<span class=w>  </span><span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=w>  </span><span class=n>u</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>udp</span><span class=p>()</span>
<span class=w>  </span><span class=n>u</span><span class=p>.</span><span class=nf>begin</span><span class=p>(</span><span class=s2>&quot;&quot;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>bytes</span><span class=p>(</span><span class=s2>&quot;FFFFFFFFFFFF&quot;</span><span class=p>)</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>mac_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>bytes</span><span class=p>().</span><span class=nf>fromhex</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>tr</span><span class=p>(</span><span class=n>mac</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;:&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=p>))</span>
<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=mi>1</span><span class=o>..</span><span class=mi>16</span>
<span class=w>    </span><span class=n>payload</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>mac_bytes</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=c1>#print(payload)</span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>u</span><span class=p>.</span><span class=nf>send</span><span class=p>(</span><span class=n>broadcast_ip</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=k>end</span>


<span class=nf>send_wake_on_lan</span><span class=p>(</span><span class=s2>&quot;84:CC:A8:64:B7:68&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;192.168.2.255&quot;</span><span class=p>)</span>
</code></pre></div> <h2 id=other-resources>Other resources<a class=headerlink href=#other-resources title="Permanent link">~</a></h2> <p>For Tasmota the're many Berry scripts available which can be found in the links below.</p> <p><a href=https://github.com/arendst/Tasmota/tree/development/tasmota/berry>https://github.com/arendst/Tasmota/tree/development/tasmota/berry</a> <a href=http://sfromis.strangled.net/tasmota/berry/github-repositories>http://sfromis.strangled.net/tasmota/berry/github-repositories</a> <a href=https://github.com/tasmota/Berry_playground/tree/main>https://github.com/tasmota/Berry_playground/tree/main</a></p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M256 8a248 248 0 1 0 0 496 248 248 0 1 0 0-496m115 168.7c-3.7 39.2-19.9 134.4-28.1 178.3-3.5 18.6-10.3 24.8-16.9 25.4-14.4 1.3-25.3-9.5-39.3-18.7-21.8-14.3-34.2-23.2-55.3-37.2-24.5-16.1-8.6-25 5.3-39.5 3.7-3.8 67.1-61.5 68.3-66.7.2-.7.3-3.1-1.2-4.4s-3.6-.8-5.1-.5c-2.2.5-37.1 23.5-104.6 69.1-9.9 6.8-18.9 10.1-26.9 9.9-8.9-.2-25.9-5-38.6-9.1-15.5-5-27.9-7.7-26.8-16.3.6-4.5 6.7-9 18.4-13.7 72.3-31.5 120.5-52.3 144.6-62.3 68.9-28.6 83.2-33.6 92.5-33.8 2.1 0 6.6.5 9.6 2.9 2 1.7 3.2 4.1 3.5 6.7.5 3.2.6 6.5.4 9.8z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.action.edit", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../assets/javascripts/bundle.79ae519e.min.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../extra_javascript/tablesort.js></script> </body> </html>