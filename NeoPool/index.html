<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation (Wiki) for Tasmota"><link href=https://tasmota.github.io/docs/NeoPool/ rel=canonical><link rel=icon href=../_media/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.3"><title>Sugar Valley NeoPool Controller - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Barlow";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-8J08F8X90S"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-8J08F8X90S",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-8J08F8X90S",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#sugar-valley-neopool-controller class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title=Tasmota class="md-header__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tasmota </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Sugar Valley NeoPool Controller </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../Features/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../ESP32/ class=md-tabs__link> ESP32 </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> <li class=md-tabs__item> <a href=http://tasmota.github.io/install class=md-tabs__link> Web Installer </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> News </span> </a> </li> <li class=md-nav__item> <a href=../About/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../Upgrading/ class=md-nav__link> <span class=md-ellipsis> Upgrading </span> </a> </li> <li class=md-nav__item> <a href=../MQTT/ class=md-nav__link> <span class=md-ellipsis> MQTT </span> </a> </li> <li class=md-nav__item> <a href=../Commands/ class=md-nav__link> <span class=md-ellipsis> Commands </span> </a> </li> <li class=md-nav__item> <a href=../Templates/ class=md-nav__link> <span class=md-ellipsis> Templates </span> </a> </li> <li class=md-nav__item> <a href=../Components/ class=md-nav__link> <span class=md-ellipsis> Components </span> </a> </li> <li class=md-nav__item> <a href=../Modules/ class=md-nav__link> <span class=md-ellipsis> Modules </span> </a> </li> <li class=md-nav__item> <a href=../Peripherals/ class=md-nav__link> <span class=md-ellipsis> Peripherals </span> </a> </li> <li class=md-nav__item> <a href=../WebUI/ class=md-nav__link> <span class=md-ellipsis> WebUI </span> </a> </li> <li class=md-nav__item> <a href=../Firmware-Builds/ class=md-nav__link> <span class=md-ellipsis> Firmware Builds </span> </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ class=md-nav__link> <span class=md-ellipsis> Compiling </span> </a> </li> <li class=md-nav__item> <a href=../Contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../Download/ class=md-nav__link> <span class=md-ellipsis> Download </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/discussions/categories/show-and-tell class=md-nav__link> <span class=md-ellipsis> Project Showcase </span> </a> </li> <li class=md-nav__item> <a href=../For-Developers/ class=md-nav__link> <span class=md-ellipsis> For Developers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Features/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../ADC/ class=md-nav__link> <span class=md-ellipsis> Analog Pin </span> </a> </li> <li class=md-nav__item> <a href=../ArtNet/ class=md-nav__link> <span class=md-ellipsis> ArtNet DMX </span> </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ class=md-nav__link> <span class=md-ellipsis> Buttons and Switches </span> </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ class=md-nav__link> <span class=md-ellipsis> DeepSleep </span> </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ class=md-nav__link> <span class=md-ellipsis> Device Groups </span> </a> </li> <li class=md-nav__item> <a href=../Universal-Display-Driver/ class=md-nav__link> <span class=md-ellipsis> Universal Display and Universal Touch drivers (uDisplay/uTouch) </span> </a> </li> <li class=md-nav__item> <a href=../Displays/ class=md-nav__link> <span class=md-ellipsis> Displays </span> </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ class=md-nav__link> <span class=md-ellipsis> Dynamic Sleep </span> </a> </li> <li class=md-nav__item> <a href=../I2CDEVICES/ class=md-nav__link> <span class=md-ellipsis> I2C Devices </span> </a> </li> <li class=md-nav__item> <a href=../I2S-Audio/ class=md-nav__link> <span class=md-ellipsis> I2S Audio </span> </a> </li> <li class=md-nav__item> <a href=../IPv6/ class=md-nav__link> <span class=md-ellipsis> IPv6 </span> </a> </li> <li class=md-nav__item> <a href=../Lights/ class=md-nav__link> <span class=md-ellipsis> Lights </span> </a> </li> <li class=md-nav__item> <a href=../Matter/ class=md-nav__link> <span class=md-ellipsis> Matter </span> </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ class=md-nav__link> <span class=md-ellipsis> PIR Motion Sensors </span> </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ class=md-nav__link> <span class=md-ellipsis> Power Monitoring Calibration </span> </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ class=md-nav__link> <span class=md-ellipsis> PWM Dimmer </span> </a> </li> <li class=md-nav__item> <a href=../Rules/ class=md-nav__link> <span class=md-ellipsis> Rules </span> </a> </li> <li class=md-nav__item> <a href=../Scripting-Language/ class=md-nav__link> <span class=md-ellipsis> Scripting Language </span> </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ class=md-nav__link> <span class=md-ellipsis> Shutters and Blinds </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_21> <label class=md-nav__link for=__nav_2_21 id=__nav_2_21_label tabindex=0> <span class=md-ellipsis> Protocol Bridging </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_21_label aria-expanded=false> <label class=md-nav__title for=__nav_2_21> <span class="md-nav__icon md-icon"></span> Protocol Bridging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../TasmotaClient/ class=md-nav__link> <span class=md-ellipsis> Arduino MCU </span> </a> </li> <li class=md-nav__item> <a href=../Bluetooth/ class=md-nav__link> <span class=md-ellipsis> BLE Gateway </span> </a> </li> <li class=md-nav__item> <a href=../DALI/ class=md-nav__link> <span class=md-ellipsis> DALI </span> </a> </li> <li class=md-nav__item> <a href=../HDMI_CEC/ class=md-nav__link> <span class=md-ellipsis> HDMI CEC </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ class=md-nav__link> <span class=md-ellipsis> IR Communication </span> </a> </li> <li class=md-nav__item> <a href=../Projector/ class=md-nav__link> <span class=md-ellipsis> LCD/DLP Projector Control </span> </a> </li> <li class=md-nav__item> <a href=../LoRa-and-LoRaWan-Bridge/ class=md-nav__link> <span class=md-ellipsis> LoRa and LoRaWan Bridge </span> </a> </li> <li class=md-nav__item> <a href=../Modbus-Bridge/ class=md-nav__link> <span class=md-ellipsis> Modbus Bridge </span> </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> <span class=md-ellipsis> OpenTherm </span> </a> </li> <li class=md-nav__item> <a href=../RF-Protocol/ class=md-nav__link> <span class=md-ellipsis> RF Communication </span> </a> </li> <li class=md-nav__item> <a href=../Serial-to-TCP-Bridge/ class=md-nav__link> <span class=md-ellipsis> Serial to TCP Bridge </span> </a> </li> <li class=md-nav__item> <a href=../TWAI/ class=md-nav__link> <span class=md-ellipsis> TWAI </span> </a> </li> <li class=md-nav__item> <a href=../Telegram/ class=md-nav__link> <span class=md-ellipsis> Telegram </span> </a> </li> <li class=md-nav__item> <a href=../Zigbee/ class=md-nav__link> <span class=md-ellipsis> Zigbee </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ class=md-nav__link> <span class=md-ellipsis> Smart Meter Interface </span> </a> </li> <li class=md-nav__item> <a href=../Thermostat/ class=md-nav__link> <span class=md-ellipsis> Thermostat </span> </a> </li> <li class=md-nav__item> <a href=../Timers/ class=md-nav__link> <span class=md-ellipsis> Timers </span> </a> </li> <li class=md-nav__item> <a href=../TLS/ class=md-nav__link> <span class=md-ellipsis> TLS Secured MQTT </span> </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ class=md-nav__link> <span class=md-ellipsis> TuyaMCU </span> </a> </li> <li class=md-nav__item> <a href=../UFS/ class=md-nav__link> <span class=md-ellipsis> Universal File System </span> </a> </li> <li class=md-nav__item> <a href=../Range-Extender/ class=md-nav__link> <span class=md-ellipsis> Wi-Fi Range Extender </span> </a> </li> <li class=md-nav__item> <a href=../Wireguard/ class=md-nav__link> <span class=md-ellipsis> Wireguard VPN </span> </a> </li> <li class=md-nav__item> <a href=../Tutorials/ class=md-nav__link> <span class=md-ellipsis> Projects and Tutorials </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> ESP32 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> ESP32 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ESP32/ class=md-nav__link> <span class=md-ellipsis> Tasmota32 Features </span> </a> </li> <li class=md-nav__item> <a href=../Berry/ class=md-nav__link> <span class=md-ellipsis> Berry </span> </a> </li> <li class=md-nav__item> <a href=../Bluetooth_ESP32/ class=md-nav__link> <span class=md-ellipsis> Bluetooth Low Energy </span> </a> </li> <li class=md-nav__item> <a href=../LVGL/ class=md-nav__link> <span class=md-ellipsis> LVGL </span> </a> </li> <li class=md-nav__item> <a href=../HASPmota/ class=md-nav__link> <span class=md-ellipsis> HASPmota </span> </a> </li> <li class=md-nav__item> <a href=../Matter/ class=md-nav__link> <span class=md-ellipsis> Matter </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-Extension/ class=md-nav__link> <span class=md-ellipsis> Tasmota Extension </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-Application/ class=md-nav__link> <span class=md-ellipsis> Tasmota Application Files </span> </a> </li> <li class=md-nav__item> <a href=../TFL/ class=md-nav__link> <span class=md-ellipsis> TensorFlow Lite </span> </a> </li> <li class=md-nav__item> <a href=../TouchPin/ class=md-nav__link> <span class=md-ellipsis> Touch GPIOs </span> </a> </li> <li class=md-nav__item> <a href=../Safeboot/ class=md-nav__link> <span class=md-ellipsis> Safeboot Partition Layout </span> </a> </li> <li class=md-nav__item> <a href=https://templates.blakadder.com/esp32 class=md-nav__link> <span class=md-ellipsis> Supported Devices </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Smart Home Integrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../Alexa/ class=md-nav__link> <span class=md-ellipsis> Alexa </span> </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ class=md-nav__link> <span class=md-ellipsis> AWS IoT </span> </a> </li> <li class=md-nav__item> <a href=../Domoticz/ class=md-nav__link> <span class=md-ellipsis> Domoticz </span> </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ class=md-nav__link> <span class=md-ellipsis> Home Assistant </span> </a> </li> <li class=md-nav__item> <a href=../Homebridge/ class=md-nav__link> <span class=md-ellipsis> Homebridge </span> </a> </li> <li class=md-nav__item> <a href=https://homey.app/en-us/app/com.paveld.tasmota/Tasmota-MQTT/ class=md-nav__link> <span class=md-ellipsis> Homey </span> </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ class=md-nav__link> <span class=md-ellipsis> HomeSeer </span> </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ class=md-nav__link> <span class=md-ellipsis> IP Symcon </span> </a> </li> <li class=md-nav__item> <a href=../KNX/ class=md-nav__link> <span class=md-ellipsis> KNX </span> </a> </li> <li class=md-nav__item> <a href=../NodeRed/ class=md-nav__link> <span class=md-ellipsis> NodeRed </span> </a> </li> <li class=md-nav__item> <a href=../nymea/ class=md-nav__link> <span class=md-ellipsis> nymea </span> </a> </li> <li class=md-nav__item> <a href=../Octoprint/ class=md-nav__link> <span class=md-ellipsis> OctoPrint </span> </a> </li> <li class=md-nav__item> <a href=../openHAB/ class=md-nav__link> <span class=md-ellipsis> openHAB </span> </a> </li> <li class=md-nav__item> <a href=../otto/ class=md-nav__link> <span class=md-ellipsis> Otto </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 class=md-nav__link> <span class=md-ellipsis> IOBroker </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter class=md-nav__link> <span class=md-ellipsis> Mozilla WebThings Adapter </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/hongtat/tasmota-connect class=md-nav__link> <span class=md-ellipsis> SmartThings </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/Gifford47/tasmohab/blob/master/README.md class=md-nav__link> <span class=md-ellipsis> Tasmohab </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Supported-Peripherals/ class=md-nav__link> <span class=md-ellipsis> Peripherals </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Supported Devices </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-nav__link> <span class=md-ellipsis> Configure Unknown Device </span> </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' class=md-nav__link> <span class=md-ellipsis> All Supported Devices </span> </a> </li> <li class=md-nav__item> <a href=../Pinouts/ class=md-nav__link> <span class=md-ellipsis> Wi-Fi Module Pinouts </span> </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ class=md-nav__link> <span class=md-ellipsis> Supported Modules </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Help </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ class=md-nav__link> <span class=md-ellipsis> Device Recovery </span> </a> </li> <li class=md-nav__item> <a href="https://discord.gg/Ks2Kzd4 " target='_blank""' class=md-nav__link> <span class=md-ellipsis> Discord Support </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=http://tasmota.github.io/install class=md-nav__link> <span class=md-ellipsis> Web Installer </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#connection class=md-nav__link> <span class=md-ellipsis> Connection </span> </a> <nav class=md-nav aria-label=Connection> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-m5stack-atom-lite-with-tail485-addon class=md-nav__link> <span class=md-ellipsis> Using M5Stack Atom Lite with Tail485 addon </span> </a> </li> <li class=md-nav__item> <a href=#using-any-other-esp class=md-nav__link> <span class=md-ellipsis> Using any other ESP </span> </a> </li> <li class=md-nav__item> <a href=#sugar-valley-connection class=md-nav__link> <span class=md-ellipsis> Sugar Valley connection </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configuration class=md-nav__link> <span class=md-ellipsis> Configuration </span> </a> <nav class=md-nav aria-label=Configuration> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tasmota-settings class=md-nav__link> <span class=md-ellipsis> Tasmota settings </span> </a> </li> <li class=md-nav__item> <a href=#m5stack-atom-lite-with-tail485-template class=md-nav__link> <span class=md-ellipsis> M5Stack Atom Lite with Tail485 template </span> </a> </li> <li class=md-nav__item> <a href=#final-check class=md-nav__link> <span class=md-ellipsis> Final check </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sensor-data class=md-nav__link> <span class=md-ellipsis> SENSOR data </span> </a> <nav class=md-nav aria-label="SENSOR data"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sensor-data-description class=md-nav__link> <span class=md-ellipsis> SENSOR data description </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#commands class=md-nav__link> <span class=md-ellipsis> Commands </span> </a> <nav class=md-nav aria-label=Commands> <ul class=md-nav__list> <li class=md-nav__item> <a href=#examples class=md-nav__link> <span class=md-ellipsis> Examples </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#enhancements class=md-nav__link> <span class=md-ellipsis> Enhancements </span> </a> <nav class=md-nav aria-label=Enhancements> <ul class=md-nav__list> <li class=md-nav__item> <a href=#daily-sync-device-to-tasmota-time class=md-nav__link> <span class=md-ellipsis> Daily sync device to Tasmota time </span> </a> </li> <li class=md-nav__item> <a href=#esp82xxesp32-add-buttons-for-filtration-and-light-control class=md-nav__link> <span class=md-ellipsis> ESP82xx/ESP32: Add buttons for filtration and light control </span> </a> </li> <li class=md-nav__item> <a href=#esp32-adding-user-defined-neopool-commands-to-tasmota class=md-nav__link> <span class=md-ellipsis> ESP32: Adding user defined NeoPool commands to Tasmota </span> </a> </li> <li class=md-nav__item> <a href=#esp32-add-gui-controls-for-filtration-light-and-aux-relais class=md-nav__link> <span class=md-ellipsis> ESP32: Add GUI controls for filtration, light and aux relais </span> </a> </li> <li class=md-nav__item> <a href=#esp32-make-the-scripts-persistent class=md-nav__link> <span class=md-ellipsis> ESP32: Make the scripts persistent </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/NeoPool.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1 id=sugar-valley-neopool-controller>Sugar Valley NeoPool Controller<a class=headerlink href=#sugar-valley-neopool-controller title="Permanent link">~</a></h1> <details class=failure> <summary>This feature is not included in precompiled binaries</summary> <p>When <a href=../Compile-your-build/ >compiling your build</a> add the following to <code>user_config_override.h</code>: <div class=highlight><pre><span></span><code><span class=cp>#ifndef USE_NEOPOOL</span>
<span class=cp>#define USE_NEOPOOL                       </span><span class=c1>// Add support for Sugar Valley NeoPool Controller - also known under brands Hidrolife, Aquascenic, Oxilife, Bionet, Hidroniser, UVScenic, Station, Brilix, Bayrol and Hay (+6k flash, +60 mem)</span>
<span class=cp>#endif</span>
</code></pre></div></p> </details> <p><a href=https://sugar-valley.net/en/productos/ >Sugar Valley</a> NeoPool are water treatment systems also known under the names Hidrolife, Aquascenic, Oxilife, Bionet, Hidroniser, UVScenic, Station, Brilix, Bayrol and Hay. It uses a <a href=https://en.wikipedia.org/wiki/RS-485>RS485</a> interface with the <a href=https://en.wikipedia.org/wiki/Modbus>Modbus</a> data protocol for enhancement equipment like Wifi-Interface or a second attached control panel. All functions and parameters can be queried and controlled via this bus interface.</p> <p>The Tasmota Sugar Valley NeoPool Controller sensor module shows the most of parameters such as the built-in display:</p> <p><img alt src=../_media/xsns_83_neopool_s.png></p> <p>There are <a href=#commands>Tasmota commands</a> implemented to control the high level functions for filtration, light and system parameters such as pH setpoint, hydrolysis level, redox setpoint etc. However, the sensor also provides low-level commands to directly <a href=#npread>read</a> and <a href=#npwrite>write</a> NeoPool register, means that you have the option to implement your own commands via home automation systems or by using the Tasmota build-in possibilities <a href=../Commands/#rules>Rules</a> with <a href=../Commands/#the-power-of-backlog>Backlog</a> or the powerful Berry language on ESP32.</p> <h2 id=connection>Connection<a class=headerlink href=#connection title="Permanent link">~</a></h2> <p>The NeoPool controller uses a RS485 interface, the ESP has RS232 interfaces. Both are serial interfaces but with different physical specifications. Therefore to connect your NeoPool controller to an ESP82xx/32 you need a TTL-UART to RS485 converter. For an ESP8266 it is recommended to use GPIO1 and GPIO3, because the ESP then uses the serial interface of the hardware.</p> <p><img alt src=../_media/xsns_83_neopool_schematic.png></p> <h3 id=using-m5stack-atom-lite-with-tail485-addon>Using M5Stack Atom Lite with Tail485 addon<a class=headerlink href=#using-m5stack-atom-lite-with-tail485-addon title="Permanent link">~</a></h3> <p>This is the easiest and the most comfortable way to run Tasmota with the Sugar Valley system. The combination of a <a href=https://docs.m5stack.com/en/core/atom_lite>M5Stack Atom Lite</a> and the <a href=https://docs.m5stack.com/en/atom/tail485>Tail485</a> addon is very small, does not need a separate power supply (because it is powered from the Sugar Valley system) and can even be placed directly next to the system or in the junction box itself. </p> <p>For this you will need:</p> <ul> <li>a <a href=https://docs.m5stack.com/en/core/atom_lite>M5Stack Atom Lite</a><br><img alt src=../_media/xsns_83_neopool_m5stack_atom_lite.png></li> <li>a <a href=https://docs.m5stack.com/en/atom/tail485>Tail485</a><br><img alt src=../_media/xsns_83_neopool_tail485.png></li> <li>a 4 wire dupont cable or 4 wire cable using a 5 pin 2,54 mm JST connector<br><img alt src=../_media/xsns_83_neopool_tail485_cable.png><br>(see also <a href=#sugar-valley-connection>Sugar Valley connection</a>)<br></li> <li>Sugar Valley pin 1 (+12V) goes to Tail485 pin 12V (9-24V)</li> <li>Sugar Valley pin 3 (Modbus A+) goes to Tail485 pin A</li> <li>Sugar Valley pin 4 (Modbus B-) goes to Tail485 pin B</li> <li>Sugar Valley pin 5 (Modbus GND) goes to Tail485 pin GND</li> </ul> <p>For final use, put the whole thing together:</p> <p><img alt src=../_media/xsns_83_neopool_m5stack_atom_lite_tail485_cable.png></p> <p>To get this combination running:</p> <ul> <li>compile your own Tasmota including the NeoPool driver as described under the red note <code>"This function is not included in precompiled binaries"</code> at the very top of this page and flash your this to your M5STack Atom Lite using USB</li> <li>make the configuration steps <a href=#m5stack-atom-lite-with-tail485-template>M5Stack Atom Lite with Tail485 template</a></li> <li>turn off the Sugar Valley device and plug the 4-wire dupont or 5 pin JST cable into the <a href=#using-wifi-port>WIFI</a> or <a href=#using-extern-port>EXTERN</a> ports</li> <li>turn on the Sugar Valley device</li> </ul> <p>That's all.</p> <h3 id=using-any-other-esp>Using any other ESP<a class=headerlink href=#using-any-other-esp title="Permanent link">~</a></h3> <p>The following TTL UART to RS485 converter have been tested with both an ESP8266 and ESP32 using a Vcc of 3.3V:</p> <p><img alt src=../_media/xsns_83_neopool_rs485_1_s.png> <img alt src=../_media/xsns_83_neopool_rs485_2_s.png></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Your TTL UART to RS485 converter must be able to work with an operating voltage of 3.3V. Some converters are not designed for operating with 3.3V and only works with 5V TTL level - these converters are useless. <strong>Do not operate your TTL UART to RS485 converter with 5V</strong>, your converter <strong>must be operated with the 3.3V</strong> from ESP, otherwise the ESP GPIO ports will be damaged.</p> </div> <h3 id=sugar-valley-connection>Sugar Valley connection<a class=headerlink href=#sugar-valley-connection title="Permanent link">~</a></h3> <p>The Sugar Valley NeoPool RS485 connector pins are located under the connection cover, for the Sugar-Valley products on the right-hand side next to the relay connections:</p> <p>The pin assignment (from top to bottom):</p> <table> <thead> <tr> <th>Pin</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>+12V</td> </tr> <tr> <td>2</td> <td>nc</td> </tr> <tr> <td>3</td> <td>Modbus A+</td> </tr> <tr> <td>4</td> <td>Modbus B-</td> </tr> <tr> <td>5</td> <td>Modbus GND</td> </tr> </tbody> </table> <div class="admonition failure"> <p class=admonition-title>The +12V connection is the 12V from the internal power supply, do not feed in any external voltage.</p> </div> <p>You can use the "WIFI" or "EXTERN" connector, both are independent Modbus channels and uses the Modbus address 1 by default.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The "DISPLAY" port can only be used if neither the built-in nor an external display is connected but since there is probably at least one display connected to one of the two "DISPLAY" ports, the "DISPLAY" port is useless.</p> </div> <h4 id=using-wifi-port>Using WIFI Port<a class=headerlink href=#using-wifi-port title="Permanent link">~</a></h4> <p><img alt src=../_media/xsns_83_neopool_connector_wifi.jpg></p> <h4 id=using-extern-port>Using EXTERN Port<a class=headerlink href=#using-extern-port title="Permanent link">~</a></h4> <p><img alt src=../_media/xsns_83_neopool_connector.jpg></p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Leave the define for <code>NEOPOOL_MODBUS_ADDRESS</code> set to 1 whether you are using the "WIFI" or "EXTERNAL" port (unless you have changed the parameters for it within your Sugar Valley device).</p> </div> <h2 id=configuration>Configuration<a class=headerlink href=#configuration title="Permanent link">~</a></h2> <h3 id=tasmota-settings>Tasmota settings<a class=headerlink href=#tasmota-settings title="Permanent link">~</a></h3> <p>The configuration is limited to the assignment of two GPIOs under Tasmota <strong><em>Configuration -&gt; Configure Module</em></strong>:</p> <ul> <li>change the Module type to <code>Generic (0)</code> - this will restart your Tasmota</li> <li>After restart set<br></li> <li>GPIO1 to <code>NeoPool RX</code><br></li> <li>GPIO3 to <code>NeoPool TX</code></li> </ul> <p><img alt src=../_media/xsns_83_neopool_config.png></p> <p>Don't be surprised that Rx seems to be connected to Tx here (and vice versa). The Rx and Tx designations are to be considered from the point of view of the respective devices, which can be confusing.</p> <h3 id=m5stack-atom-lite-with-tail485-template>M5Stack Atom Lite with Tail485 template<a class=headerlink href=#m5stack-atom-lite-with-tail485-template title="Permanent link">~</a></h3> <p>For this combination use a template, got to Console and enter the command below:</p> <div class=highlight><pre><span></span><code>Template {&quot;NAME&quot;:&quot;NeoPool&quot;,&quot;GPIO&quot;:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,0,0,6976,0,0,0,0,0,7008,1,0,0,0,0,0,0],&quot;FLAG&quot;:0,&quot;BASE&quot;:1}
</code></pre></div> <p>This also allows the later use of the additonal GPIOs 19, 21 - 23 and 33 for other purposes (sensors or similar).</p> <p>After a restart active the template using command <code>Module 0</code>.</p> <h3 id=final-check>Final check<a class=headerlink href=#final-check title="Permanent link">~</a></h3> <p>After Tasmota restarts, the main screen should display the controller data as shown above. If not, check that the A+/B pins aren't swapped and that the Rx/Tx pins are on the correct GPIOs - swap once if in doubt.</p> <h2 id=sensor-data>SENSOR data<a class=headerlink href=#sensor-data title="Permanent link">~</a></h2> <p>Sensor data is sent via the Tasmota topic <code>tele/%topic%/SENSOR</code> in JSON format every <a href=../Commands/#teleperiod>TelePeriod</a> interval. To get the data immediately, use the Tasmota <a href=../Commands/#teleperiod>TelePeriod</a> command without parameter:</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
<span class=w>  </span><span class=nt>&quot;Time&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2021-06-01T11:00:00+02:00&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=nt>&quot;NeoPool&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nt>&quot;Time&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2021-06-01T11:00:00&quot;</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Oxilife&quot;</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Module&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;pH&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Redox&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Hydrolysis&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Chlorine&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Conductivity&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Ionization&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Temperature&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>23.5</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Powerunit&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Version&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;V3.45&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;NodeID&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;XXXX XXXX XXXX XXXX XXXX 442A&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;5V&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>5.017</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;12V&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>13.904</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;24-30V&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>33.721</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;4-20mA&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>0.01</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;pH&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>7.2</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Min&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>7.0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Max&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>7.2</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;State&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Pump&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;FL1&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Tank&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Redox&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>752</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Setpoint&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>750</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Chlorine&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>0.7</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Setpoint&quot;</span><span class=p>:</span><span class=w> </span><span class=mf>1.0</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Conductivity&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Ionization&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Setpoint&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Max&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Hydrolysis&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>100</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Unit&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;%&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Setpoint&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>100</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Max&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>100</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Runtime&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=nt>&quot;Total&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;28T22:13:19&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Part&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;28T22:13:02&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Pol1&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;14T12:32:46&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Pol2&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;14T09:40:33&quot;</span><span class=p>,</span>
<span class=w>        </span><span class=nt>&quot;Changes&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>258</span>
<span class=w>      </span><span class=p>},</span>
<span class=w>      </span><span class=nt>&quot;State&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Pol1&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Cover&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Boost&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Low&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;FL1&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Redox&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Filtration&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;State&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Speed&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>2</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;Mode&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Light&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Relay&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;State&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>],</span>
<span class=w>      </span><span class=nt>&quot;Aux&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>],</span>
<span class=w>      </span><span class=nt>&quot;Acid&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=p>},</span>
<span class=w>    </span><span class=nt>&quot;Connection&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nt>&quot;Time&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2024-08-14T15:00:00&quot;</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBRequests&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>9040</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBNoError&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>9039</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBIllegalFunc&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBIllegalDataAddr&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBIllegalDataValue&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBSlaveError&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBAck&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBSlaveBusy&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBNotEnoughData&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBMemParityErr&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBCRCErr&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBGWPath&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBGWTarget&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBRegErr&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBRegData&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBTooManyReg&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBUnknownErr&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;MBNoResponse&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>      </span><span class=nt>&quot;DataOutOfRange&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>  </span><span class=p>},</span>
<span class=w>  </span><span class=nt>&quot;TempUnit&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;C&quot;</span>
<span class=p>}</span>
</code></pre></div> <h3 id=sensor-data-description>SENSOR data description<a class=headerlink href=#sensor-data-description title="Permanent link">~</a></h3> <table> <thead> <tr> <th style="text-align: left;">Key</th> <th style="text-align: left;">Details</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;">Time</td> <td style="text-align: left;">(String) Device time</td> </tr> <tr> <td style="text-align: left;">Type</td> <td style="text-align: left;">(String) Model description (<code>Hidrolife</code>, <code>Aquascenic</code>, <code>Oxilife</code>, <code>Bionet</code>, <code>Hidroniser</code>, <code>UVScenic</code>, <code>Station</code>, <code>Brilix</code>, <code>Generic</code>, <code>Bayrol</code> or <code>Hay</code>)</td> </tr> <tr> <td style="text-align: left;">Module</td> <td style="text-align: left;">(Bool) These subkeys indicate whether the corresponding module is installed and activated (<code>1</code>) or not (<code>0</code>)</td> </tr> <tr> <td style="text-align: left;">Temperature</td> <td style="text-align: left;">(Float) Temperature value from temperature sensor (only available if temperature sensor is installed)</td> </tr> <tr> <td style="text-align: left;">Powerunit.Version</td> <td style="text-align: left;">(String) The firmware version of the power unit module</td> </tr> <tr> <td style="text-align: left;">Powerunit.NodeID</td> <td style="text-align: left;">(String) The NodeID of your device (default hidden, do not publish your NodeID). See <a href=../Commands/#setoption157><code>SetOption157</code></a></td> </tr> <tr> <td style="text-align: left;">Powerunit.5V</td> <td style="text-align: left;">(Float) Voltage value of the 5 Volt output</td> </tr> <tr> <td style="text-align: left;">Powerunit.12V</td> <td style="text-align: left;">(Float) Voltage value of the 12 Volt output</td> </tr> <tr> <td style="text-align: left;">Powerunit.24-30V</td> <td style="text-align: left;">(Float) Voltage value of the 24-30 Volt output</td> </tr> <tr> <td style="text-align: left;">Powerunit.4-20mA</td> <td style="text-align: left;">(Float) Current value of the 4-20mA output</td> </tr> <tr> <td style="text-align: left;">pH.Data</td> <td style="text-align: left;">(Float) Current pH value (<code>0</code>..<code>14</code>)</td> </tr> <tr> <td style="text-align: left;">pH.Min</td> <td style="text-align: left;">(Float) Minimum setting value for pH control (only useful if a base pump is connected).</td> </tr> <tr> <td style="text-align: left;">pH.Max</td> <td style="text-align: left;">(Float) Maximum setting value for pH control (only useful if an acid pump is connected).</td> </tr> <tr> <td style="text-align: left;">pH.State</td> <td style="text-align: left;">(Int) Status of the pH controller:<br><code>0</code> = no alarm<br><code>1</code> = pH too high: pH value is 0.8 points higher than setpoint (<code>NPpHMax</code> on acid systems, <code>NPpHMin</code> on base systems, <code>NPpHMax</code> on acid+base systems)<br><code>2</code> = pH too low: pH value is 0.8 points lower than setpoint (<code>NPpHMax</code> on acid systems, <code>NPpHMin</code> on base systems, <code>NPpHMin</code> on acid+base systems)<br><code>3</code> = pH pump has exceeded the working time set by the MBF_PAR_RELAY_PH_MAX_TIME parameter and has stopped<br><code>4</code> = pH higher than setpoint (<code>NPpHMax</code> + 0.1 on acid systems, <code>NPpHMin</code> + 0.1 on base systems, <code>NPpHMax</code> on acid+base systems)<br><code>5</code> = pH lower than setpoint (<code>NPpHMax</code> - 0.3 on acid systems, <code>NPpHMin</code> - 0.3 on base systems, <code>NPpHMin</code> on acid+base systems)<br><code>6</code> = Tank level alarm</td> </tr> <tr> <td style="text-align: left;">pH.Pump</td> <td style="text-align: left;">(Int) pH control module and controlling pumps:<br><code>0</code> = pH control module and controlling pumps inactive<br><code>1</code> = Acid/base pH pump pump on<br><code>2</code> = Acid/base pH pump pump off</td> </tr> <tr> <td style="text-align: left;">pH.FL1</td> <td style="text-align: left;">(Bool) Control status of the pH module by flow detection:<br><code>0</code> = Disable<br><code>1</code> = Enable</td> </tr> <tr> <td style="text-align: left;">pH.Tank</td> <td style="text-align: left;">(Bool) Acid/Base tank signal input:<br><code>0</code> = Tank empty<br><code>1</code> = No Tank alarm</td> </tr> <tr> <td style="text-align: left;">Redox.Data</td> <td style="text-align: left;">(Int) Current redox value [mV]</td> </tr> <tr> <td style="text-align: left;">Redox.Setpoint</td> <td style="text-align: left;">(Int) Redox target [mV]</td> </tr> <tr> <td style="text-align: left;">Chlorine.Data</td> <td style="text-align: left;">(Float) Current chlorine value [ppm]</td> </tr> <tr> <td style="text-align: left;">Chlorine.Setpoint</td> <td style="text-align: left;">(Float) Chlorine target production level [ppm]</td> </tr> <tr> <td style="text-align: left;">Conductivity</td> <td style="text-align: left;">(Int) Current conductivity level [%]</td> </tr> <tr> <td style="text-align: left;">Ionization.Data</td> <td style="text-align: left;">(Int) Current ionization level</td> </tr> <tr> <td style="text-align: left;">Ionization.Setpoint</td> <td style="text-align: left;">(Int) Ionization target production level</td> </tr> <tr> <td style="text-align: left;">Ionization.Max</td> <td style="text-align: left;">(Int) Ionization maximum production level (system defined)</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Data</td> <td style="text-align: left;">(Float/Int) Hydrolysis current production level</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Unit</td> <td style="text-align: left;">(String) Hydrolysis unit ("g/h" or "%")</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Setpoint</td> <td style="text-align: left;">(Float/Int) Hydrolisis target production level</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Max</td> <td style="text-align: left;">(Float/Int) Hydrolysis maximum production level [g/h</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Runtime.Total</td> <td style="text-align: left;">(String) Cell total runtime (format <em>dd_T_hh</em>:_mm_:<em>ss</em>)</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Runtime.Part</td> <td style="text-align: left;">(String) Cell partly runtime</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Runtime.Pol1</td> <td style="text-align: left;">(String) Cell runtime for polarization 1</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Runtime.Pol2</td> <td style="text-align: left;">(String) Cell runtime for polarization 2</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Runtime.Changes</td> <td style="text-align: left;">(Int) Number of polarization changes</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.State</td> <td style="text-align: left;">(String) Cell state:<br><code>OFF</code> = Cell inactive<br><code>FLOW</code> = Cell water flow alarm<br><code>POL1</code> = Cell polarization 1 active<br><code>POL2</code> = Cell polarization 2 active</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Cover</td> <td style="text-align: left;">(Bool) Cover signal input:<br><code>0</code> = Cover input inactive<br><code>1</code> = Cover input active</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Boost</td> <td style="text-align: left;">(Int) Boost mode state:<br><code>0</code> = Boost mode inactive<br><code>1</code> = Boost mode active<br><code>2</code> = Boost mode active with redox control</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Low</td> <td style="text-align: left;">(Bool) Hydrolysis low alarm:<br><code>0</code> = No alarm<br><code>1</code> = Hydrolysis cannot reach the setpoint</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.FL1</td> <td style="text-align: left;">(Bool) Hydrolysis cell flow indicator:<br><code>0</code> = No alarm<br><code>1</code> = Hydrolysis flow alarm, no flow detected</td> </tr> <tr> <td style="text-align: left;">Hydrolysis.Redox</td> <td style="text-align: left;">(Bool) Activation of hydrolysis by the redox module:<br><code>0</code> = Not activated by redox module<br><code>1</code> = Activated by redox module</td> </tr> <tr> <td style="text-align: left;">Filtration.State</td> <td style="text-align: left;">(Int) Filtration pump state:<br><code>0</code> = Pump off<br><code>1</code> = Pump on</td> </tr> <tr> <td style="text-align: left;">Filtration.Speed</td> <td style="text-align: left;">(Int) Filtration pump speed:<br><code>1</code> = Low<br><code>2</code> = Middle<br><code>3</code> = High</td> </tr> <tr> <td style="text-align: left;">Filtration.Mode</td> <td style="text-align: left;">(Int) Filtration mode:<br><code>0</code> = Manual<br><code>1</code> = Auto<br><code>2</code> = Heating<br><code>3</code> = Smart<br><code>4</code> = Intelligent<br><code>13</code> = Backwash operation</td> </tr> <tr> <td style="text-align: left;">Light</td> <td style="text-align: left;">(Bool) Light state:<br><code>0</code> = Light off<br><code>1</code> = Light on</td> </tr> <tr> <td style="text-align: left;">Relay</td> <td style="text-align: left;">Relay state values (<code>0</code> = off, <code>1</code> = on):</td> </tr> <tr> <td style="text-align: left;">Relay.State</td> <td style="text-align: left;">(Array) Relay states for all possible seven relays 1-7 (functional independent)</td> </tr> <tr> <td style="text-align: left;">Relay.Aux</td> <td style="text-align: left;">(Array) Relay states for the 4 Aux relais (these are the same as <code>Relay.State</code> 4-7 - functional independent)</td> </tr> <tr> <td style="text-align: left;">Relay.Acid</td> <td style="text-align: left;">(Bool) Acid relay state</td> </tr> <tr> <td style="text-align: left;">Relay.Base</td> <td style="text-align: left;">(Bool) Base relay state</td> </tr> <tr> <td style="text-align: left;">Relay.Redox</td> <td style="text-align: left;">(Bool) Redox relay state</td> </tr> <tr> <td style="text-align: left;">Relay.Chlorine</td> <td style="text-align: left;">(Bool) Chlorine relay state</td> </tr> <tr> <td style="text-align: left;">Relay.Conductivity</td> <td style="text-align: left;">(Bool) Conductivity relay state</td> </tr> <tr> <td style="text-align: left;">Relay.Heating</td> <td style="text-align: left;">(Bool) Heating relay state</td> </tr> <tr> <td style="text-align: left;">Relay.UV</td> <td style="text-align: left;">(Bool) UV relay state</td> </tr> <tr> <td style="text-align: left;">Relay.Valve</td> <td style="text-align: left;">(Bool) Valve relay state</td> </tr> <tr> <td style="text-align: left;">Connection</td> <td style="text-align: left;">NeoPool Modbus connection statistics (ESP32 only, <a href=#npsetoption1>NPSetOption1</a> must be 1):</td> </tr> <tr> <td style="text-align: left;">Connection.Time</td> <td style="text-align: left;">(String) Start time statistics</td> </tr> <tr> <td style="text-align: left;">Connection.MBRequests</td> <td style="text-align: left;">(Int) Total ModBus queries</td> </tr> <tr> <td style="text-align: left;">Connection.MBNoError</td> <td style="text-align: left;">(Int) Responses without error</td> </tr> <tr> <td style="text-align: left;">Connection.MBNoResponse</td> <td style="text-align: left;">(Int) Missing responses</td> </tr> <tr> <td style="text-align: left;">Connection.DataOutOfRange</td> <td style="text-align: left;">(Int) Number of values outside the sensor range</td> </tr> <tr> <td style="text-align: left;">Connection.MBIllegalFunc</td> <td style="text-align: left;">(Int) Err 1: Illegal Function</td> </tr> <tr> <td style="text-align: left;">Connection.MBIllegalDataAddr</td> <td style="text-align: left;">(Int) Err 2: Illegal Data Address</td> </tr> <tr> <td style="text-align: left;">Connection.MBIllegalDataValue</td> <td style="text-align: left;">(Int) Err 3: Illegal Data Value</td> </tr> <tr> <td style="text-align: left;">Connection.MBSlaveError</td> <td style="text-align: left;">(Int) Err 4: Slave Error</td> </tr> <tr> <td style="text-align: left;">Connection.MBAck</td> <td style="text-align: left;">(Int) Err 5: Acknowledge but not finished (no error)</td> </tr> <tr> <td style="text-align: left;">Connection.MBSlaveBusy</td> <td style="text-align: left;">(Int) Err 6: Slave Busy</td> </tr> <tr> <td style="text-align: left;">Connection.MBNotEnoughData</td> <td style="text-align: left;">(Int) Err 7: Not enough minimal data received</td> </tr> <tr> <td style="text-align: left;">Connection.MBMemParityErr</td> <td style="text-align: left;">(Int) Err 8: Memory Parity error</td> </tr> <tr> <td style="text-align: left;">Connection.MBCRCErr</td> <td style="text-align: left;">(Int) Err 9: CRC error</td> </tr> <tr> <td style="text-align: left;">Connection.MBGWPath</td> <td style="text-align: left;">(Int) Err 10: Gateway Path Unavailable</td> </tr> <tr> <td style="text-align: left;">Connection.MBGWTarget</td> <td style="text-align: left;">(Int) Err 11: Gateway Target device failed to respond</td> </tr> <tr> <td style="text-align: left;">Connection.MBRegErr</td> <td style="text-align: left;">(Int) Err 12: Wrong number of registers</td> </tr> <tr> <td style="text-align: left;">Connection.MBRegData</td> <td style="text-align: left;">(Int) Err 13: Register data not specified</td> </tr> <tr> <td style="text-align: left;">Connection.MBTooManyReg</td> <td style="text-align: left;">(Int) Err 14: To many registers</td> </tr> <tr> <td style="text-align: left;">Connection.MBUnknownErr</td> <td style="text-align: left;">(Int) Unknown errors occured</td> </tr> </tbody> </table> <p>The JSON values <code>pH</code>, <code>Redox</code>, <code>Hydrolysis</code>, <code>Chlorine</code>, <code>Conductivity</code> and <code>Ionization</code> are only available if the corresponding module is installed in the device (the corresponding "Module" subkey must be <code>1</code>).</p> <p>The <code>Relay</code> subkeys <code>Acid</code>, <code>Base</code>, <code>Redox</code>, <code>Chlorine</code>, <code>Conductivity</code>, <code>Heating</code>, <code>UV</code> and <code>Valve</code> are only available if the related function is assigned to a relay.</p> <p>To check which modules are installed use the <code>Module</code> value from SENSOR topic or query it manually by using the <a href=#npcontrol>NPControl</a> command:</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
<span class=w>  </span><span class=nt>&quot;Modules&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nt>&quot;pH&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Redox&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Hydrolysis&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Chlorine&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Conductivity&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Ionization&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<span class=w>  </span><span class=p>},</span>
<span class=w>  </span><span class=nt>&quot;Relay&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=nt>&quot;Acid&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>1</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Base&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Redox&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Chlorine&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Conductivity&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Heating&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>4</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;UV&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span>
<span class=w>    </span><span class=nt>&quot;Valve&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>0</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <table> <thead> <tr> <th style="text-align: left;">Key</th> <th style="text-align: left;">Details</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;">Modules</td> <td style="text-align: left;">(Bool) These subkeys indicate whether the corresponding module is installed and activated (<code>1</code>) or not (<code>0</code>)</td> </tr> <tr> <td style="text-align: left;">Relays</td> <td style="text-align: left;">(Int) These subkeys list the relay number assignments to the internal function (<code>0</code>..<code>7</code>)<br><code>0</code> = functionality is unassigned<br><code>1</code>..<code>7</code> functionality is assigned to the related relay number<br><br>Examples: <code>"Acid": 1</code> means relay 1 is assigned to the acid function<br><code>"Heating": 4</code> means relay 4 (is equal to Aux1) is assigned to the heating function</td> </tr> </tbody> </table> <h2 id=commands>Commands<a class=headerlink href=#commands title="Permanent link">~</a></h2> <p>This sensor supports some high-level <a href=#commands>commands</a> for end user.</p> <p>Regardless, all other Modbus registers can be read and write, so you can <a href=#enhancements>enhance</a> your Sugar Valley control by using low-level <a href=#npread>NPRead</a>/<a href=#npwrite>npwrite</a> commands.</p> <p>Modbus register addresses and their meaning are described within source file <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/xsns_83_neopool.ino>xsns_83_neopool.ino</a> at the beginning and (partly) within document <a href=https://downloads.vodnici.net/uploads/wpforo/attachments/69/171-Modbus-registers.pdf>171-Modbus-registers</a>.<br> Please note that Sugar Valley Modbus registers are not byte addresses but modbus registers containing 16-bit values - don't think in byte memory layout.</p> <table> <thead> <tr> <th style="text-align: left;">Command</th> <th style="text-align: left;">Parameters</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;">NPFiltration<a id=npfiltration></a></td> <td style="text-align: left;"><code>&lt;state&gt;( &lt;speed&gt;)</code><br>Set manual filtration (state = <code>0</code> or <code>1</code>, speed = <code>1..3</code>):<ul><li><code>0</code> - manual turn filtration pump off</li><li><code>1</code> - manual turn filtration pump on</li></ul>Optional set filtration <code>&lt;speed&gt;</code> (only available if filtration speed control is configured):<ul><li><code>1</code> - slow</li><li><code>2</code> - medium</li><li><code>3</code> - fast</li></ul></td> </tr> <tr> <td style="text-align: left;">NPFiltrationmode<a id=npfiltrationmode></a></td> <td style="text-align: left;"><code>&lt;mode&gt;</code><br>Set filtration mode (mode = <code>0..4</code> or <code>13</code>):<ul><li><code>0</code> - <em>MANUAL</em><br>allows to turn the filtration (and all other systems that depend on it) on and off</li><li><code>1</code> - <em>AUTO</em><br>allows filtering to be turned on and off according to the settings of the <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/tasmota_xsns_sensor/xsns_83_neopool.ino#L204>MBF_PAR_TIMER_BLOCK_FILT_INT</a> timers.</li><li><code>2</code> - <em>HEATING</em><br>similar to the AUTO mode, but includes setting the temperature for the heating function. This mode is activated only if the BF_PAR_HEATING_MODE register is at 1 and there is a heating relay assigned.</li><li><code>3</code> - <em>SMART</em><br>adjusts the pump operating times depending on the temperature. This mode is activated only if the <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/tasmota_xsns_sensor/xsns_83_neopool.ino#L166>MBF_PAR_TEMPERATURE_ACTIVE</a> register is at 1.</li><li><code>4</code> - <em>INTELLIGENT</em><br>performs an intelligent filtration process in combination with the heating function. This mode is activated only if the <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/tasmota_xsns_sensor/xsns_83_neopool.ino#L171>MBF_PAR_HEATING_MODE</a> register is at 1 and there is a heating relay assigned.</li><li><code>13</code> - <em>BACKWASH</em><br>started when the backwash operation is activated.</ul></td> </tr> <tr> <td style="text-align: left;">NPFiltrationspeed<a id=npfiltrationspeed></a></td> <td style="text-align: left;"><code>&lt;speed&gt;</code><br>Set manual filtration speed (speed = <code>1..3</code>):<ul><li><code>1</code> - Low</li><li><code>2</code> - Mid</li><li><code>3</code> - High</li></ul>Note: The command is only available if filtration speed control is configured.</td> </tr> <tr> <td style="text-align: left;">NPBoost<a id=npboost></a></td> <td style="text-align: left;"><code>&lt;mode&gt;</code><br>Set hydrolysis/electrolysis boost mode (mode = <code>0..2</code> or <code>OFF</code>, <code>ON</code>, <code>REDOX</code>):<ul><li><code>0</code> or <code>OFF</code> - <em>Boost off</em><br>disables the boost mode</li><li><code>1</code> or <code>ON</code> - <em>Boost on</em><br>enables the boost mode independent of the redox value</li><li><code>2</code> or <code>REDOX</code> - <em>Boost on with Redox control</em><br>similar to ON, but with consideration of the current redox settings.</li></ul>Note: The boost function always switches the filtering on.</td> </tr> <tr> <td style="text-align: left;">NPTime<a id=nptime></a></td> <td style="text-align: left;"><code>&lt;time&gt;</code><br>Set device time:<ul><li><code>0</code> - sync with Tasmota local time</li><li><code>1</code> - sync with Tasmota utc time</li><li><code>2..4294967295</code> - set time as epoch</li></ul></td> </tr> <tr> <td style="text-align: left;">NPLight<a id=nplight></a></td> <td style="text-align: left;"><code>&lt;state&gt;( &lt;delay&gt;)</code><br>Set light (state = <code>0..4</code>, delay = <code>5..100</code> in 1/10 sec):<ul><li><code>0</code> - manual turn light off</li><li><code>1</code> - manual turn light on</li><li><code>2</code> - manual toggle light</li><li><code>3</code> - switch light into auto mode according <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/tasmota_xsns_sensor/xsns_83_neopool.ino#L208>MBF_PAR_TIMER_BLOCK_LIGHT_INT</a> settings</li><li><code>4</code> - select light RGB LED to next program. This is normally done by power the light on (if currently off), then power off the light for <code>&lt;delay&gt;</code> time and power on again. <code>&lt;delay&gt;</code> must be specified in 1/10 seconds, default is 15 (=1.5 sec).</ul></td> </tr> <tr> <td style="text-align: left;">NPpHMin<a id=npphmin></a></td> <td style="text-align: left;"><code>&lt;ph&gt;</code><br>Set pH lower limit (ph = <code>0..14</code>)<br>Note: The command is only available if the pH module is installed.</td> </tr> <tr> <td style="text-align: left;">NPpHMax<a id=npphmax></a></td> <td style="text-align: left;"><code>&lt;ph&gt;</code><br>Set pH upper limit (ph = <code>0..14</code>)<br>Note: The command is only available if the pH module is installed.</td> </tr> <tr> <td style="text-align: left;">NPpH<a id=npph></a></td> <td style="text-align: left;"><code>&lt;ph&gt;</code><br>Set pH upper limit (ph = <code>0..14</code>) - alias for NPpHMax<br>Note: The command is only available if the pH module is installed.</td> </tr> <tr> <td style="text-align: left;">NPRedox<a id=npredox></a></td> <td style="text-align: left;"><code>&lt;setpoint&gt;</code><br>Set redox setpoint in mV (setpoint = <code>0..1000</code>)<br>Note: The command is only available if the redox module is installed.</td> </tr> <tr> <td style="text-align: left;">NPHydrolysis<a id=nphydrolysis></a></td> <td style="text-align: left;"><code>&lt;level&gt;( %)</code><br>Set hydrolysis/electrolysis level:<ul><li><code>0..100</code> in % for systems configured to %</li><li><code>0..&lt;max&gt;</code> in g/h for systems configured to g/h (<code>&lt;max&gt;</code> depends on the value of the <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/tasmota_xsns_sensor/xsns_83_neopool.ino#L141>MBF_PAR_HIDRO_NOM</a> register of the device)</li></ul><code>&lt;level&gt;</code> can specified in % on all systems by appending the % sign to the value<br>Note: The command is only available if the hydrolysis/electrolysis control is present.</td> </tr> <tr> <td style="text-align: left;">NPIonization<a id=npionization></a></td> <td style="text-align: left;"><code>&lt;level&gt;</code><br>Set ionization target production level (level = <code>0..&lt;max&gt;</code>, the upper limit <code>&lt;max&gt;</code> may vary depending on the <a href=https://github.com/arendst/Tasmota/blob/development/tasmota/tasmota_xsns_sensor/xsns_83_neopool.ino#L140>MBF_PAR_ION_NOM</a> register)<br>Note: The command is only available if the hydrolysis/electrolysis control is present.</td> </tr> <tr> <td style="text-align: left;">NPChlorine<a id=npchlorine></a></td> <td style="text-align: left;"><code>&lt;setpoint&gt;</code><br>Set chlorine setpoint in ppm (setpoint = <code>0..10</code>)<br>Note: The command is only available if the free chlorine probe detector is installed.</td> </tr> <tr> <td style="text-align: left;">NPControl<a id=npcontrol></a></td> <td style="text-align: left;">Show information about <a href=./#sensor-data-description>system controls</a>.</td> </tr> <tr> <td style="text-align: left;">NPTelePeriod<a id=npteleperiod></a></td> <td style="text-align: left;"><code>&lt;time&gt;</code><br>Enables/disables auto telemetry message when NeoPool values change (time = <code>0</code> or <code>5..3600</code>):<ul><li><code>0</code> - disable this function off (default), telemetry message are only reported depending on <a href=../Commands/#teleperiod>TelePeriod</a> setting</li><li><code>5..3600</code> - set the minimum of seconds between two telemetry messages for NeoPool measured values (status changes for relays and settings trigger the SENSOR messages immediately, regardless of the time set)</li></ul>Hint: To get immediate telemetry messages only for status changes (relays, settings) set <code>&lt;time&gt;</code> higher than <a href=../Commands/#teleperiod>TelePeriod</a>. In this case, measured sensors are reported only by <a href=../Commands/#teleperiod>TelePeriod</a> setting, status changes are reported immediately.</td> </tr> <tr> <td style="text-align: left;">NPOnError<a id=nponerror></a></td> <td style="text-align: left;"><code>&lt;repeat&gt;</code><br>Set the number of retries for Modbus read/write commands errors (repeat = <code>0..10</code>):<ul><li><code>0</code> - disable auto-repeat on read/write error</li><li><code>1..10</code> - repeat commands n times until ok</li></ul></td> </tr> <tr> <td style="text-align: left;">NPResult<a id=npresult></a></td> <td style="text-align: left;"><code>&lt;format&gt;</code><br>Set addr/data result format for read/write commands (format = <code>0|1</code>):<ul><li><code>0</code> - output decimal numbers</li><li><code>1</code> - output hexadecimal strings, this is the default</li></ul></td> </tr> <tr> <td style="text-align: left;">NPPHRes<a id=npphres></a></td> <td style="text-align: left;"><code>&lt;resolution&gt;</code><br>Set number of decimal places in results for PH value (resolution = <code>0..3</code>).</td> </tr> <tr> <td style="text-align: left;">NPCLRes<a id=npclres></a></td> <td style="text-align: left;"><code>&lt;resolution&gt;</code><br>Set number of decimal places in results for CL value (resolution = <code>0..3</code>).</td> </tr> <tr> <td style="text-align: left;">NPIONRes<a id=npionres></a></td> <td style="text-align: left;"><code>&lt;resolution&gt;</code><br>Set number of decimal places in results for ION value (resolution = <code>0..3</code>).</td> </tr> <tr> <td style="text-align: left;">NPSetOption0<a id=npsetoption0></a></td> <td style="text-align: left;">Sensor data min/max validation and correction function (ESP32 only)<br><code>0</code> = disable correction<br> <code>1</code> = enable correction <em>(default)</em></td> </tr> <tr> <td style="text-align: left;">NPSetOption1<a id=npsetoption1></a></td> <td style="text-align: left;">NeoPool Modbus connection statistics (ESP32 only)<br><code>0</code> = disable statistics<br> <code>1</code> = enable statistics <em>(default)</em></td> </tr> <tr> <td style="text-align: left;">NPRead<a id=npread></a></td> <td style="text-align: left;"><code>&lt;addr&gt;( &lt;cnt&gt;)</code><br>Read device 16-bit register (addr = <code>0..0x06FF</code>, cnt = <code>1..30</code>). <code>&lt;cnt&gt;</code> = <code>1</code> if omitted</td> </tr> <tr> <td style="text-align: left;">NPRead<a id=npread></a></td> <td style="text-align: left;"><code>&lt;addr&gt;( &lt;cnt&gt;)</code><br>Read device 16-bit register (addr = <code>0..0x06FF</code>, cnt = <code>1..30</code>). <code>&lt;cnt&gt;</code> = <code>1</code> if omitted</td> </tr> <tr> <td style="text-align: left;">NPReadLSB<a id=npreadlsb></a></td> <td style="text-align: left;"><code>&lt;addr&gt;( &lt;cnt&gt;)</code><br>Read device LSB of 16-bit register (addr = <code>0..0x06FF</code>, cnt = <code>1..30</code>). <code>&lt;cnt&gt;</code> = <code>1</code> if omitted</td> </tr> <tr> <td style="text-align: left;">NPReadMSB<a id=npreadmsb></a></td> <td style="text-align: left;"><code>&lt;addr&gt;( &lt;cnt&gt;)</code><br>Read device MSB of 16-bit register (addr = <code>0..0x06FF</code>, cnt = <code>1..30</code>). <code>&lt;cnt&gt;</code> = <code>1</code> if omitted</td> </tr> <tr> <td style="text-align: left;">NPReadL<a id=npreadl></a></td> <td style="text-align: left;"><code>&lt;addr&gt;( &lt;cnt&gt;)</code><br>Read device 32-bit register (addr = <code>0..0x06FF</code>, cnt = <code>1..15</code>). <code>&lt;cnt&gt;</code> = <code>1</code> if omitted</td> </tr> <tr> <td style="text-align: left;">NPWrite<a id=npwrite></a></td> <td style="text-align: left;"><code>&lt;addr&gt; &lt;data&gt;( &lt;data&gt;...)</code><br>Write device 16-bit register (addr = <code>0..0x06FF</code>, data = <code>0..0xFFFF</code>). Use of <code>&lt;data&gt;</code> max 20 times</td> </tr> <tr> <td style="text-align: left;">NPWriteLSB<a id=npwritelsb></a></td> <td style="text-align: left;"><code>&lt;addr&gt; &lt;data&gt;( &lt;data&gt;...)</code><br>Write device LSB 16-bit register (addr = <code>0..0x06FF</code>, data = <code>0..0xFF</code>). Use of <code>&lt;data&gt;</code> max 20 times</td> </tr> <tr> <td style="text-align: left;">NPWriteMSB<a id=npwritemsb></a></td> <td style="text-align: left;"><code>&lt;addr&gt; &lt;data&gt;( &lt;data&gt;...)</code><br>Write device MSB 16-bit register (addr = <code>0..0x06FF</code>, data = <code>0..0xFF</code>). Use of <code>&lt;data&gt;</code> max 20 times</td> </tr> <tr> <td style="text-align: left;">NPWriteL<a id=npwritel></a></td> <td style="text-align: left;"><code>&lt;addr&gt; &lt;data&gt;( &lt;data&gt;...)</code><br>Write device 32-bit register (addr = <code>0..0x06FF</code>, data = <code>0..0xFFFFFFFF</code>). Use of <code>&lt;data&gt;</code> max 10 times</td> </tr> <tr> <td style="text-align: left;">NPBit<a id=npbit></a></td> <td style="text-align: left;"><code>&lt;addr&gt; &lt;bit&gt;( &lt;data&gt;)</code><br>Read/Write a single bit from device 16-bit register (addr = <code>0..0x06FF</code>, bit = <code>0..15</code>, data = <code>0|1</code>). Read if <code>&lt;data&gt;</code> is omitted, otherwise set single bit</td> </tr> <tr> <td style="text-align: left;">NPBitL<a id=npbitl></a></td> <td style="text-align: left;"><code>&lt;addr&gt; &lt;bit&gt;( &lt;data&gt;)</code><br>Read/Write a single bit from device 32-bit register (addr = <code>0..0x06FF</code>, bit = <code>0..31</code>, data = <code>0|1</code>). Read if <code>&lt;data&gt;</code> is omitted, otherwise set single bit</td> </tr> <tr> <td style="text-align: left;">NPEscape<a id=npescape></a></td> <td style="text-align: left;">Clears possible errors (like pump exceeded time etc.)</td> </tr> <tr> <td style="text-align: left;">NPExec<a id=npexec></a></td> <td style="text-align: left;">Take over changes without writing to EEPROM. This command is necessary e. g. on changes in <em>Installer page</em> (addr 0x0400..0x04EE).</td> </tr> <tr> <td style="text-align: left;">NPSave<a id=npsave></a></td> <td style="text-align: left;">Write data permanently into EEPROM.<br>During the EEPROM write procedure the NeoPool device may be unresponsive to MODBUS requests, this process always takes less than 1 second.<br>Since this process is limited by the number of EEPROM write cycles, it is recommend to write all necessary changes to the registers and only then execute EEPROM write process using this command.<br><strong>Note: The number of EEPROM writes for Sugar Valley NeoPool devices is guaranteed 100,000 cycles. As soon as this number is exceeded, further storage of information can no longer be guaranteed</strong>.</td> </tr> <tr> <td style="text-align: left;">See also</td> <td style="text-align: left;"><a href=../Commands/#setoption157><code>SetOption157</code></a> - Hide/Show sensitive data</td> </tr> </tbody> </table> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The setttings changed by commands <a href=#npphres>NPPHRes</a>, <a href=#npclres>NPCLRes</a>, <a href=#npionres>NPIONRes</a>, <a href=#npsetoption0>NPSetOption0</a> and <a href=#npsetoption1>NPSetOption1</a> are permanently stored only if firmware was compiled with USE_UFILESYS (#define <code>USE_UFILESYS</code>, default enabled on ESP32 and disabled on ESP82xx). Without USE_UFILESYS (default on ESP82xx), you can alternatively use a rule to set your defaults during system start, e. g.: <code>Rule1 ON System#Init DO Backlog NPPHRes 1;NPCLRes 1;NPIonRes 1;NPSetOption0 1;NPSetOption1 0</code></p> </div> <h3 id=examples>Examples<a class=headerlink href=#examples title="Permanent link">~</a></h3> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Get filtration mode</p> </div> <div class=highlight><pre><span></span><code><span class=err>NPFil</span><span class=kc>trat</span><span class=err>io</span><span class=kc>n</span><span class=err>mode</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPFiltrationmode&quot;</span><span class=p>:</span><span class=s2>&quot;Manual&quot;</span><span class=p>}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Set filtration mode</p> </div> <div class=highlight><pre><span></span><code><span class=err>NPFil</span><span class=kc>trat</span><span class=err>io</span><span class=kc>n</span><span class=err>mode</span><span class=w> </span><span class=mi>1</span>
<span class=p>{</span><span class=nt>&quot;NPFiltrationmode&quot;</span><span class=p>:</span><span class=s2>&quot;Auto&quot;</span><span class=p>}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Switch light relay on</p> </div> <div class=highlight><pre><span></span><code><span class=err>NPLigh</span><span class=kc>t</span><span class=w> </span><span class=mi>1</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPLight&quot;</span><span class=p>:</span><span class=s2>&quot;ON&quot;</span><span class=p>}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Read Heating setpoint temperature</p> </div> <p>Here we read register <code>MBF_PAR_HEATING_TEMP</code> (<code>0x0416</code>):</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPResul</span><span class=kc>t</span><span class=w> </span><span class=mi>0</span><span class=err>;NPRead</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>416</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPResult&quot;</span><span class=p>:</span><span class=mi>0</span><span class=p>}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPRead&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1046</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=mi>28</span><span class=p>}}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Enable additional factory menu</p> </div> <p>For that enable bit <code>MBMSK_SHOW_FACTORY_MENU</code> (15) in register <code>MBF_PAR_UICFG_VISUAL_OPTIONS</code> (<code>0x0605</code>)</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPBi</span><span class=kc>t</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>605</span><span class=p>,</span><span class=mi>15</span><span class=p>,</span><span class=mi>1</span><span class=err>;NPSave</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPBit&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=s2>&quot;0x0605&quot;</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=s2>&quot;0xAFC0&quot;</span><span class=p>,</span><span class=nt>&quot;Bit15&quot;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPSave&quot;</span><span class=p>:</span><span class=s2>&quot;Done&quot;</span><span class=p>}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Read system time</p> </div> <p>We either use command <code>NPTime</code> or read the 32-bit value starting <code>MBF_PAR_TIME_LOW</code> (<code>0x0408</code>) using decimal output:</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPResul</span><span class=kc>t</span><span class=w> </span><span class=mi>0</span><span class=err>;NPTime;NPReadL</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>408</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPResult&quot;</span><span class=p>:</span><span class=mi>0</span><span class=p>}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPTime&quot;</span><span class=p>:</span><span class=s2>&quot;2021-01-31T21:22:20&quot;</span><span class=p>}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPReadL&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1032</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=mi>1612124540</span><span class=p>}}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Enable temperature module</p> </div> <p>Do this by enabling <code>MBF_PAR_TEMPERATURE_ACTIVE</code> (<code>0x04F</code>) and set it permanently in EEPROM::</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPWri</span><span class=kc>te</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>40</span><span class=err>F</span><span class=p>,</span><span class=mi>1</span><span class=err>;NPSave</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPWrite&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=s2>&quot;0x040F&quot;</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=s2>&quot;0x0001&quot;</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPSave&quot;</span><span class=p>:</span><span class=s2>&quot;Done&quot;</span><span class=p>}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Hide auxiliary relay display from main menu</p> </div> <p>To do this, set bit <code>MBMSK_HIDE_AUX_RELAYS</code> (3) in register <code>MBF_PAR_UICFG_VISUAL_OPTIONS</code> (<code>0x0605</code>):</p> <div class=highlight><pre><span></span><code><span class=err>NPBi</span><span class=kc>t</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>605</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>1</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPBit&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=s2>&quot;0x0605&quot;</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=s2>&quot;0x08C8&quot;</span><span class=p>}}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Read Filtration interval 1-3 settings</p> </div> <p>To do this, we read the registers <code>MBF_PAR_TIMER_BLOCK_FILT_INT1</code> (<code>0x0434</code>), <code>MBF_PAR_TIMER_BLOCK_FILT_INT2</code> (<code>0x0443</code>) and <code>MBF_PAR_TIMER_BLOCK_FILT_INT3</code> (<code>0x0452</code>) with offset <code>MBV_TIMER_OFFMB_TIMER_ENABLE</code> (0) as 16-bit values and the remaining timer offset values <code>MBV_TIMER_OFFMB_*</code> as 32-bit values:</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPResul</span><span class=kc>t</span><span class=w> </span><span class=mi>0</span><span class=err>;NPRead</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>434</span><span class=err>;NPReadL</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>435</span><span class=p>,</span><span class=mi>7</span><span class=err>;NPRead</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>443</span><span class=err>;NPReadL</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>444</span><span class=p>,</span><span class=mi>7</span><span class=err>;NPRead</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>452</span><span class=err>;NPReadL</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>0453</span><span class=p>,</span><span class=mi>7</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPResult&quot;</span><span class=p>:</span><span class=mi>0</span><span class=p>}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPRead&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1076</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPReadL&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1077</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:[</span><span class=mi>28800</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>86400</span><span class=p>,</span><span class=mi>14400</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPRead&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1091</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPReadL&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1092</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:[</span><span class=mi>43200</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>86400</span><span class=p>,</span><span class=mi>21600</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPRead&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1106</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPReadL&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1107</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>86400</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]}}</span><span class=w> </span><span class=err>*</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Set filtration interval</p> </div> <p>Here we set interval 1 to a daily interval between 9:00 - 12:30 (9:00: 3600 * 9  32400 / 12:30  3,5h = 12600)</p> <p>For this write register <code>MBF_PAR_TIMER_BLOCK_FILT_INT1</code> (<code>0x0434</code>) using the offsets <code>MBV_TIMER_OFFMB_</code>. For the sake of simplicity we write 4 consecutive 32-bit registers:</p> <ul> <li><code>MBV_TIMER_OFFMB_TIMER_ON</code>: Timer start = 9<em>3600 + 00</em>60 = 32400</li> <li><code>MBV_TIMER_OFFMB_TIMER_OFF</code>: Timer stop - not used</li> <li><code>MBV_TIMER_OFFMB_TIMER_PERIOD</code>: Time in seconds between starting points = 86400 (means daily interval)</li> <li><code>MBV_TIMER_OFFMB_TIMER_INTERVAL</code>: Time in seconds that the timer has to run when started. This is the difference between 12:30 (12<em>3600 + 30</em>60 = 45000) and 9:30(see Timer start = 32400) = 12600</li> </ul> <div class=highlight><pre><span></span><code><span class=err>NPWri</span><span class=kc>te</span><span class=err>L</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>435</span><span class=p>,</span><span class=mi>32400</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>86400</span><span class=w> </span><span class=mi>12600</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPWriteL&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=mi>1077</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:[</span><span class=mi>32400</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>86400</span><span class=p>,</span><span class=mi>12600</span><span class=p>]}}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Manual switch relay 7 (Aux4)</p> </div> <p>To switch Aux4 ON, we set <code>MBF_PAR_TIMER_BLOCK_AUX4_INT1</code> (<code>0x04D9</code>) + <code>MBV_TIMER_OFFMB_TIMER_ENABLE</code> (0) to MBV_PAR_CTIMER_ALWAYS_ON (<code>3</code>):.</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPWri</span><span class=kc>te</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>4</span><span class=err>D</span><span class=mi>9</span><span class=p>,</span><span class=mi>3</span><span class=err>;NPExec</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPWrite&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=s2>&quot;0x04D9&quot;</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=s2>&quot;0x0003&quot;</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPExec&quot;</span><span class=p>:</span><span class=s2>&quot;Done&quot;</span><span class=p>}</span>
</code></pre></div> <p>To switch Aux4 OFF, we set <code>MBF_PAR_TIMER_BLOCK_AUX4_INT1</code> (<code>0x04D9</code>) + <code>MBV_TIMER_OFFMB_TIMER_ENABLE</code> (0) to MBV_PAR_CTIMER_ALWAYS_OFF (<code>4</code>):.</p> <div class=highlight><pre><span></span><code><span class=err>Backlog</span><span class=w> </span><span class=err>NPWri</span><span class=kc>te</span><span class=w> </span><span class=mi>0</span><span class=err>x</span><span class=mi>4</span><span class=err>D</span><span class=mi>9</span><span class=p>,</span><span class=mi>4</span><span class=err>;NPExec</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPWrite&quot;</span><span class=p>:{</span><span class=nt>&quot;Address&quot;</span><span class=p>:</span><span class=s2>&quot;0x04D9&quot;</span><span class=p>,</span><span class=nt>&quot;Data&quot;</span><span class=p>:</span><span class=s2>&quot;0x0004&quot;</span><span class=p>}}</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPExec&quot;</span><span class=p>:</span><span class=s2>&quot;Done&quot;</span><span class=p>}</span>
</code></pre></div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Modbus autorepeat on communication error</p> </div> <p>Read current autorepeat value:</p> <div class=highlight><pre><span></span><code><span class=err>NPO</span><span class=kc>n</span><span class=err>Error</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPOnError&quot;</span><span class=p>:</span><span class=mi>2</span><span class=p>}</span>
</code></pre></div> <p>Set autorepeat value to 3:</p> <div class=highlight><pre><span></span><code><span class=err>NPO</span><span class=kc>n</span><span class=err>Error</span><span class=w> </span><span class=mi>3</span>
<span class=err>RESULT</span><span class=w> </span><span class=err>=</span><span class=w> </span><span class=p>{</span><span class=nt>&quot;NPOnError&quot;</span><span class=p>:</span><span class=mi>3</span><span class=p>}</span>
</code></pre></div> <h2 id=enhancements>Enhancements<a class=headerlink href=#enhancements title="Permanent link">~</a></h2> <h3 id=daily-sync-device-to-tasmota-time>Daily sync device to Tasmota time<a class=headerlink href=#daily-sync-device-to-tasmota-time title="Permanent link">~</a></h3> <p>Since the NeoPool devices, without a WiFi module, have no way of synchronizing their internal clock with an external clock and, in addition, the accuracy of the internal clock leaves something to be desired, it makes sense to synchronize the clock with Tasmota once a day. Advantageously, we do this at night after a possible daylight saving time or normal time change.</p> <p>We use a rule that synchronizes the time and which is triggered by the Tasmota built-in timer (here we use timer 10):</p> <div class=highlight><pre><span></span><code><span class=kt>Rule2</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Clock</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>10</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>NPTime</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Activate it:</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=kt>Rule2</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <p>Configure Tasmota "Timer 10" for your needs:</p> <p><img alt src=../_media/xsns_83_neopool_timer.png></p> <h3 id=esp82xxesp32-add-buttons-for-filtration-and-light-control>ESP82xx/ESP32: Add buttons for filtration and light control<a class=headerlink href=#esp82xxesp32-add-buttons-for-filtration-and-light-control title="Permanent link">~</a></h3> <p>Add two dummy buttons to control the filtration pump and the light.</p> <p>First we define two dummy relay (which does not have any physical function) on two unused GPIO (here we use GPIO0 and GPIO4 where we define Tasmota Relay 1 and 2):</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>GPIO0</span><span class=w> </span><span class=mi>224</span><span class=p>;</span><span class=kt>GPIO4</span><span class=w> </span><span class=mi>225</span>
</code></pre></div> <p>Then we rename the buttons for better visibility:</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>WebButton1</span><span class=w> </span><span class=kt>Filtration</span><span class=p>;</span><span class=kt>WebButton2</span><span class=w> </span><span class=kt>Light</span>
</code></pre></div> <p>Now we have the WebGUI buttons like this:</p> <p><img alt src=../_media/xsns_83_neopool_ctrl.png></p> <p>but missing the functionality behind. For that we use <a href=../Rules/ >Rules</a> and connect the states for Tasmota Power, Neopool filtration and light:</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>NPFiltration</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>NPFiltration</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>NeoPool</span><span class=o>#</span><span class=kt>Filtration</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>NeoPool</span><span class=o>#</span><span class=kt>Filtration</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>NPLight</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>NPLight</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>NeoPool</span><span class=o>#</span><span class=kt>Light</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>NeoPool</span><span class=o>#</span><span class=kt>Light</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Don't wonder about the double trigger definition, which at first glance seem nonsensical - they are necessary so that the rule does not trigger endless.</p> <p>At least we activate the rule:</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <p>It is important to enable the Rule ONCE (<code>Rule1 5</code>) function, which prevents the trigger is triggering themself in a loop.</p> <p>You can now control filtration and light using the WebGUI and get the current status of the device elements when they are switched by auto-mode or manually on the device directly.</p> <p><img alt src=../_media/xsns_83_neopool_do_ctrl.png></p> <p>Additional advantage is that you can also use Tasmota Timer switching Power1 (=filtration) and Power2 (light) for your needs.</p> <h3 id=esp32-adding-user-defined-neopool-commands-to-tasmota>ESP32: Adding user defined NeoPool commands to Tasmota<a class=headerlink href=#esp32-adding-user-defined-neopool-commands-to-tasmota title="Permanent link">~</a></h3> <p>The following enhancements are made using the <a href=../Berry/ >Berry Scripting Language</a> which is available on ESP32 only.</p> <p>The Berry script file <a href=#neopoolcmdbe>neopoolcmd.be</a> below adds the following new commands to Tasmota:</p> <table> <thead> <tr> <th style="text-align: left;">Command</th> <th style="text-align: left;">Parameters</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;">NPAux&lt;x&gt;<a id=npaux></a></td> <td style="text-align: left;"><code>&lt;state&gt;</code><br>Set auxiliary relay &lt;x&gt; (x=<code>1..4</code>, state = <code>0..2</code>):<ul><li><code>0</code> - switch off auxiliary relay</li><li><code>1</code> - switch on auxiliary relay</li><code>2</code> - toggle auxiliary relay</li></ul></td> </tr> <tr> <td style="text-align: left;">NPAntiFreeze&lt;x&gt;<a id=npantifreeze></a></td> <td style="text-align: left;"><code>&lt;state&gt;</code><br>Set Smart mode antifreeze (state = <code>0..2</code>):<ul><li><code>0</code> - switch Smart mode antifreeze off</li><li><code>1</code> - switch Smart mode antifreeze on</li><code>2</code> - toggle Smart mode antifreeze</li></ul></td> </tr> <tr> <td style="text-align: left;">NPTimer&lt;x&gt;<a id=nptimer></a></td> <td style="text-align: left;"><code>0</code> or <code>OFF</code> or <code>&lt;hh:mm hh:mm&gt;( &lt;period&gt;)</code> or <code>&lt;json&gt;</code><br>Set device timer for filtration, light and auxiliary relay (x=<code>1..12</code>)<br> &lt;x&gt;:<ul><li><code>1</code> - Filtration timer 1</li><li><code>2</code> - Filtration timer 2</li><li><code>3</code> - Filtration timer 3</li><li><code>4</code> - Light timer</li><li><code>5</code> - Aux1 timer 1</li><li><code>6</code> - Aux1 timer 2</li><li><code>7</code> - Aux2 timer 1</li><li><code>8</code> - Aux2 timer 2</li><li><code>9</code> - Aux3 timer 1</li><li><code>10</code> - Aux3 timer 2</li><li><code>11</code> - Aux4 timer 1</li><li><code>12</code> - Aux4 timer 2</li></ul><br><ul><li><code>0</code> or <code>OFF</code> - Switch timer off</li><li><code>hh:mm hh:mm</code> - Start/End time pair<li><code>period</code> - optional period interval (default seconds), use postfix (e. g. "1d") for period unit:<br><code>s</code> - seconds<br><code>m</code> - minutes<br><code>h</code> - hours<br><code>d</code> - days<br><code>w</code> - weeks</li><li><code>json</code> - valid JSON string containng start-/endtime and period e. g. <code>#!json {"Start":"17:00","End":"22:15","Period":"1d"}</code></li></ul></td> </tr> <tr> <td style="text-align: left;">NPVersion<a id=npversion></a></td> <td style="text-align: left;">Get the firmware info as array (firmware version and creation date)</td> </tr> <tr> <td style="text-align: left;">NPBackup<a id=npbackup></a></td> <td style="text-align: left;">(<code>&lt;name&gt;</code>( <code>overwrite</code>)<br>Creates a backup copy of device setting (it saves the INSTALLER (0x04xx), USER (0x05xx) and MISC (0x06xx) pages). <code>&lt;name&gt;</code> is optional and may contain <a href=https://docs.python.org/3/library/datetime.html#strftime-and-strptime-format-codes>strftime format codes</a> (default <code>devicename_%Y-%m-%dT%H:%M:%S</code>).<br>The command fails if the backup file already exists. Explicitly use <code>&lt;name&gt;</code> and append <code>overwrite</code> to overwrite an existing backup file or delete the file manually.<br>Note: The backup files are stored in Tasmota file system within the hidden directory <code>.npbackup</code>, pay attention to the maximum free size of the file system and use <code>NPPrune</code> if necessary</td> </tr> <tr> <td style="text-align: left;">NPRestore<a id=nprestore></a></td> <td style="text-align: left;"><code>&lt;name&gt;</code><br>Restores a previous device setting backup, <code>&lt;name&gt;</code> is required. Use command <code>NPList</code> to get a list the backup files.<br>Note: A restart of the system may be necessary if massive changes are made by an <code>NPRestore</code>.</td> </tr> <tr> <td style="text-align: left;">NPList<a id=nplist></a></td> <td style="text-align: left;">Get a list of all stored backup files.</td> </tr> <tr> <td style="text-align: left;">NPPrune<a id=npprune></a></td> <td style="text-align: left;"><code>&lt;age&gt;</code>( <code>dry-run</code>)<br>Deletes backup files that are older than specified <code>&lt;age&gt;</code> seconds. Use postfix (e. g. "1w") for <age>:<br><code>s</code> - seconds<br><code>m</code> - minutes<br><code>h</code> - hours<br><code>d</code> - days<br><code>w</code> - weeks<br><code>y</code> - years<br>Use <code>dry-run</code> to simulate the <code>NPPrune</code> run, it will list the files that will be deleted.</td> </tr> </tbody> </table> <p>Store the following script into the Tasmota file system by using the WebGUI "Console" / "Manage File system".</p> <h4 id=neopoolcmdbe>neopoolcmd.be<a class=headerlink href=#neopoolcmdbe title="Permanent link">~</a></h4> <details class=summary> <summary>View script</summary> <div class=highlight><pre><span></span><code><span class=c1># File: neopoolcmd.be</span>
<span class=c1>#</span>
<span class=c1># Add commands NPAux, NPAntiFreeze, NPTimer, NPVersion, NPBackup, NPRestore, NPList and NPPrune</span>

<span class=c1># Neopool definitions</span>

<span class=n>MBF_POWER_MODULE_REGISTER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x000C</span>
<span class=n>MBF_POWER_MODULE_DATA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x000D</span>
<span class=n>MBF_RELAY_STATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x010E</span>
<span class=n>MBF_PAR_SMART_ANTI_FREEZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x41A</span>
<span class=n>MBF_PAR_UICFG_MACHINE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0600</span>

<span class=c1># MBF_PAR_TIMER_BLOCK_BASE</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_ENABLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_ON</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_OFF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_PERIOD</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_INTERVAL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>7</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_COUNTDOWN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>9</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_FUNCTION</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>11</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_WORK_TIME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>13</span>

<span class=n>MBV_TIMER_OFFMB_TIMER_ON_IDX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_OFF_IDX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_PERIOD_IDX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_INTERVAL_IDX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_COUNTDOWN_IDX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_FUNCTION_IDX</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=mi>5</span>
<span class=n>MBV_TIMER_OFFMB_TIMER_WORK_TIME_IDX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>6</span>

<span class=c1># MBV_TIMER_OFFMB_TIMER_ENABLE working modes:</span>
<span class=n>MBV_PAR_CTIMER_DISABLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=n>MBV_PAR_CTIMER_ENABLED</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
<span class=n>MBV_PAR_CTIMER_ENABLED_LINKED</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
<span class=n>MBV_PAR_CTIMER_ALWAYS_ON</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=mi>3</span>
<span class=n>MBV_PAR_CTIMER_ALWAYS_OFF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span>
<span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>5</span>
<span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_PLUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x01</span>
<span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_MINUS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x02</span>
<span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_ARROWDOWN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x04</span>
<span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_ARROWUP</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x08</span>
<span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEYS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_PLUS</span><span class=o>:</span><span class=s2>&quot;+&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_MINUS</span><span class=o>:</span><span class=s2>&quot;-&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_ARROWDOWN</span><span class=o>:</span><span class=s2>&quot;&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY_ARROWUP</span><span class=o>:</span><span class=s2>&quot;&quot;</span>
<span class=p>}</span>

<span class=c1># MBV_TIMER_OFFMB_TIMER_FUNCTION codes:</span>
<span class=n>MBV_PAR_CTIMER_FCT_FILTRATION</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0001</span>
<span class=n>MBV_PAR_CTIMER_FCT_LIGHTING</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0002</span>
<span class=n>MBV_PAR_CTIMER_FCT_HEATING</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0004</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0100</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0200</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0400</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0800</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x1000</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x2000</span>
<span class=n>MBV_PAR_CTIMER_FCT_RELAY7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x4000</span>
<span class=c1># Function codes text</span>
<span class=n>MBV_PAR_CTIMER_FCT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_FILTRATION</span><span class=o>:</span><span class=s2>&quot;Filtration&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_LIGHTING</span><span class=o>:</span><span class=s2>&quot;Light&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_HEATING</span><span class=o>:</span><span class=s2>&quot;Heating&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY1</span><span class=o>:</span><span class=s2>&quot;Relay1&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY2</span><span class=o>:</span><span class=s2>&quot;Relay2&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY3</span><span class=o>:</span><span class=s2>&quot;Relay3&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY4</span><span class=o>:</span><span class=s2>&quot;Aux1&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY5</span><span class=o>:</span><span class=s2>&quot;Aux2&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY6</span><span class=o>:</span><span class=s2>&quot;Aux3&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY7</span><span class=o>:</span><span class=s2>&quot;Aux4&quot;</span>
<span class=p>}</span>

<span class=c1># configuration of the system timers</span>
<span class=n>MBF_PAR_TIMER_BLOCK_FILT_INT1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0434</span>
<span class=n>MBF_PAR_TIMER_BLOCK_FILT_INT2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0443</span>
<span class=n>MBF_PAR_TIMER_BLOCK_FILT_INT3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0452</span>
<span class=n>MBF_PAR_TIMER_BLOCK_LIGHT_INT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0470</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX1_INT1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x04AC</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX1_INT2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0461</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX2_INT1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x04BB</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX2_INT2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x047F</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX3_INT1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x04CA</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX3_INT2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x048E</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX4_INT1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x04D9</span>
<span class=n>MBF_PAR_TIMER_BLOCK_AUX4_INT2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x049D</span>

<span class=c1># Timer base addr index</span>
<span class=n>PAR_TIMER_BLOCK</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<span class=w>  </span><span class=c1># addr, function</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_FILT_INT1</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_FILTRATION</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_FILT_INT2</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_FILTRATION</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_FILT_INT3</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_FILTRATION</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_LIGHT_INT</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_LIGHTING</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX1_INT1</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY4</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX1_INT2</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY4</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX2_INT1</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY5</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX2_INT2</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY5</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX3_INT1</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY6</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX3_INT2</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY6</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX4_INT1</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY7</span><span class=p>],</span>
<span class=w>  </span><span class=p>[</span><span class=n>MBF_PAR_TIMER_BLOCK_AUX4_INT2</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT_RELAY7</span><span class=p>]</span>
<span class=p>]</span>
<span class=n>PAR_TIMER_BLOCK_AUX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<span class=w>  </span><span class=n>MBF_PAR_TIMER_BLOCK_AUX1_INT1</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBF_PAR_TIMER_BLOCK_AUX2_INT1</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBF_PAR_TIMER_BLOCK_AUX3_INT1</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBF_PAR_TIMER_BLOCK_AUX4_INT1</span>
<span class=p>]</span>

<span class=c1># Register to exclude from restore</span>
<span class=n>MBF_PAR_TIME_LOW</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0408</span>
<span class=n>MBF_PAR_TIME_HIGH</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0409</span>
<span class=n>MBF_ACTION_COPY_TO_RTC</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x04F0</span>

<span class=n>RESTORE_EXCL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<span class=w>  </span><span class=n>MBF_PAR_TIME_LOW</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBF_PAR_TIME_HIGH</span><span class=p>,</span>
<span class=w>  </span><span class=n>MBF_ACTION_COPY_TO_RTC</span>
<span class=p>]</span>

<span class=n>MACHINE_NAMES</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span>
<span class=w>  </span><span class=s2>&quot;NeoPool&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Hidrolife&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Aquascenic&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Oxilife&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Bionet&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Hidroniser&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;UVScenic&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Station&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Brilix&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Generic&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Bayrol&quot;</span><span class=p>,</span>
<span class=w>  </span><span class=s2>&quot;Hay&quot;</span>
<span class=p>]</span>

<span class=kr>import</span><span class=w> </span><span class=n>string</span>
<span class=kr>import</span><span class=w> </span><span class=n>json</span>
<span class=kr>import</span><span class=w> </span><span class=n>path</span>

<span class=c1># NeoPool command class</span>
<span class=kd>class</span><span class=w> </span><span class=nc>NeoPoolCommands</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>TEXT_OFF</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>TEXT_ON</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>TEXT_TOGGLE</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>BACKUP_DIR</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>BACKUP_NAME</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>BACKUP_START_ADDR</span>
<span class=w>  </span><span class=kd>var</span><span class=w> </span><span class=n>BACKUP_END_ADDR</span>

<span class=w>  </span><span class=c1># helper</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>ltrim</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>split</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>rtrim</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=mi>-1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>)</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>split</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>trim</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>rtrim</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>ltrim</span><span class=p>(</span><span class=n>s</span><span class=p>));</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>list_sort</span><span class=p>(</span><span class=n>_list</span><span class=p>)</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=mi>1</span><span class=o>..</span><span class=nb>size</span><span class=p>(</span><span class=n>_list</span><span class=p>)</span><span class=mi>-1</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_list</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span>
<span class=w>      </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>j</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>_list</span><span class=p>[</span><span class=n>j</span><span class=mi>-1</span><span class=p>]</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>_value</span><span class=p>)</span>
<span class=w>        </span><span class=n>_list</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_list</span><span class=p>[</span><span class=n>j</span><span class=mi>-1</span><span class=p>]</span>
<span class=w>        </span><span class=n>j</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=mi>1</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>      </span><span class=n>_list</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_value</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>_list</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>get_args</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>payload</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=p>[]</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>replace</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span><span class=w> </span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=mi>0</span><span class=o>..</span><span class=nb>size</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=mi>-1</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s2>&quot;&#39;&quot;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
<span class=w>        </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
<span class=w>        </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=s2>&quot;,&quot;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
<span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=s1>&#39; &#39;</span>
<span class=w>      </span><span class=k>else</span>
<span class=w>        </span><span class=n>s</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>split</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;,&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=k>while</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=nf>remove</span><span class=p>(</span><span class=n>p</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>))</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>p</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>get_args_switch</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span><span class=w> </span><span class=n>p2</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=n>res</span>
<span class=w>    </span><span class=k>try</span>
<span class=w>      </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>      </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s2>&quot;&quot;</span>

<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=s1>&#39;off&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;off&#39;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span>
<span class=w>        </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=s1>&#39;0&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;0&#39;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span>
<span class=w>        </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=s1>&#39;on&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;on&#39;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span>
<span class=w>          </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=s1>&#39;1&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span>
<span class=w>          </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=n>p2</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span>
<span class=w>          </span><span class=p>((</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>p2</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=n>p2</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>||</span>
<span class=w>            </span><span class=p>(</span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>parm</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2&#39;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>          </span><span class=p>)</span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
<span class=w>      </span><span class=k>else</span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>gc</span><span class=p>()</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>res</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>get_period_from_int</span><span class=p>(</span><span class=n>period_num</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>period_num</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=s2>&quot;0&quot;</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=p>((</span><span class=n>period_num</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=p>(</span><span class=mi>86400</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>365</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%dy&quot;</span><span class=p>,</span><span class=w> </span><span class=n>period_num</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=mi>86400</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>365</span><span class=p>))</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=p>((</span><span class=n>period_num</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=p>(</span><span class=mi>86400</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>7</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%dw&quot;</span><span class=p>,</span><span class=w> </span><span class=n>period_num</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=p>(</span><span class=mi>86400</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>7</span><span class=p>))</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=p>((</span><span class=n>period_num</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>86400</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%dd&quot;</span><span class=p>,</span><span class=w> </span><span class=n>period_num</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>86400</span><span class=p>)</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=p>((</span><span class=n>period_num</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>3600</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%dh&quot;</span><span class=p>,</span><span class=w> </span><span class=n>period_num</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>3600</span><span class=p>)</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=p>((</span><span class=n>period_num</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>60</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%dm&quot;</span><span class=p>,</span><span class=w> </span><span class=n>period_num</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>60</span><span class=p>)</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%ds&quot;</span><span class=p>,</span><span class=w> </span><span class=n>period_num</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>get_period_from_str</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span>
<span class=w>    </span><span class=n>period_str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>period_str</span><span class=p>))</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>period_num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>period_str</span><span class=p>[</span><span class=nb>size</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39;y&#39;</span>
<span class=w>      </span><span class=n>period_num</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=mi>365</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=n>period_str</span><span class=p>[</span><span class=nb>size</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39;w&#39;</span>
<span class=w>      </span><span class=n>period_num</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=mi>7</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=n>period_str</span><span class=p>[</span><span class=nb>size</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39;d&#39;</span>
<span class=w>      </span><span class=n>period_num</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=mi>24</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=n>period_str</span><span class=p>[</span><span class=nb>size</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39;h&#39;</span>
<span class=w>      </span><span class=n>period_num</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span>
<span class=w>    </span><span class=k>elif</span><span class=w> </span><span class=n>period_str</span><span class=p>[</span><span class=nb>size</span><span class=p>(</span><span class=n>period_str</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s1>&#39;m&#39;</span>
<span class=w>      </span><span class=n>period_num</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=mi>60</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>period_num</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>get_timer</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>timer_enable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_ENABLE</span><span class=p>);</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>timer_enable</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPReadL&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_ON</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=k>end</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Unknown&quot;</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>values</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timer_enable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_DISABLE</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>timer_enable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ENABLED</span><span class=p>)</span>
<span class=w>      </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Timer&quot;</span>
<span class=w>      </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timer_enable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ENABLED</span><span class=w> </span><span class=o>&amp;&amp;</span>
<span class=w>        </span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_ON_IDX</span><span class=p>])</span><span class=w> </span><span class=o>!=</span>
<span class=w>          </span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_ON_IDX</span><span class=p>])</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_INTERVAL_IDX</span><span class=p>]))</span>
<span class=w>        </span><span class=p>)</span>
<span class=w>      </span><span class=p>)</span>
<span class=w>        </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span>
<span class=w>      </span><span class=k>end</span>

<span class=w>      </span><span class=n>values</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;,&quot;Start&quot;:&quot;%s&quot;,&quot;End&quot;:&quot;%s&quot;,&quot;Period&quot;:&quot;%s&quot;&#39;</span><span class=p>,</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>strftime</span><span class=p>(</span><span class=s2>&quot;%H:%M&quot;</span><span class=p>,</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_ON_IDX</span><span class=p>])),</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>strftime</span><span class=p>(</span><span class=s2>&quot;%H:%M&quot;</span><span class=p>,</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_ON_IDX</span><span class=p>])</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_INTERVAL_IDX</span><span class=p>])),</span>
<span class=w>        </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_period_from_int</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_PERIOD_IDX</span><span class=p>]))</span>
<span class=w>      </span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timer_enable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_OFF</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>timer_enable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_ON</span><span class=p>)</span>
<span class=w>      </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Manual&quot;</span>
<span class=w>      </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>timer_enable</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_OFF</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span>
<span class=w>      </span><span class=n>values</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>timer_enable</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x00FF</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEY</span><span class=p>)</span>
<span class=w>      </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;Temporary&quot;</span>
<span class=w>      </span><span class=n>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span>
<span class=w>      </span><span class=n>values</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;,&quot;Key&quot;:&quot;%s&quot;,&quot;Duration&quot;:&quot;%s&quot;&#39;</span><span class=p>,</span>
<span class=w>        </span><span class=n>MBV_PAR_CTIMER_COUNTDOWN_KEYS</span><span class=p>.</span><span class=nf>find</span><span class=p>(((</span><span class=n>timer_enable</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x0F</span><span class=p>),</span><span class=w> </span><span class=s2>&quot;unknown&quot;</span><span class=p>),</span>
<span class=w>        </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_period_from_int</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_INTERVAL_IDX</span><span class=p>]))</span>
<span class=w>      </span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>alloc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_FCT</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=n>MBV_TIMER_OFFMB_TIMER_FUNCTION_IDX</span><span class=p>]),</span><span class=w> </span><span class=s2>&quot;undefined&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s%d&quot;:{&quot;Mode&quot;:&quot;%s&quot;,&quot;State&quot;:&quot;%s&quot;,&quot;Allocation&quot;:&quot;%s&quot;%s}}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=n>state</span><span class=p>,</span><span class=w> </span><span class=n>alloc</span><span class=p>,</span><span class=w> </span><span class=n>values</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>read_cmnd</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>cnt</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%s 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>read_cmnd</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>cnt</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>).</span><span class=nf>find</span><span class=p>(</span><span class=n>read_cmnd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;Unknown&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=c1># result must be a json</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=s2>&quot;Unknown&quot;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>res</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;NeoPool module not available or not activated&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>_json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>load</span><span class=p>(</span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>(</span><span class=n>res</span><span class=p>))</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>_json</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s2>&quot;Error&quot;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>res</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;NeoPool device does not respond&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>compile</span><span class=p>(</span><span class=s2>&quot;return &quot;</span><span class=o>..</span><span class=na>_json</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;Data&#39;</span><span class=p>))()</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPAux&lt;x&gt; OFF|0|ON|1|TOGGLE|2 (&lt;x&gt; = 1..4)</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPAux</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>ctrl</span><span class=p>,</span><span class=w> </span><span class=n>parm</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>4</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args_switch</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_TOGGLE</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>parm</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_OFF</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>parm</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_ON</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>parm</span>
<span class=w>        </span><span class=k>try</span>
<span class=w>          </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_RELAY_STATE</span><span class=p>)</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ctrl</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>          </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ctrl</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=n>idx</span><span class=o>+</span><span class=mi>2</span><span class=p>))</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_OFF</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ALWAYS_ON</span>
<span class=w>        </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>          </span><span class=k>return</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>else</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>        </span><span class=k>return</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWrite 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK_AUX</span><span class=p>[</span><span class=n>idx</span><span class=mi>-1</span><span class=p>],</span><span class=w> </span><span class=n>ctrl</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPExec&quot;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=k>try</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_RELAY_STATE</span><span class=p>)</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ctrl</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ctrl</span><span class=w> </span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>(</span><span class=n>idx</span><span class=o>+</span><span class=mi>2</span><span class=p>))</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mi>1</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>        </span><span class=k>return</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s%d&quot;:&quot;%s&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>ctrl</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=p>(</span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span><span class=p>))</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPAntiFreeze OFF|0|ON|1|TOGGLE|2</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPAntiFreeze</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>ctrl</span><span class=p>,</span><span class=w> </span><span class=n>parm</span>
<span class=w>    </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args_switch</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_TOGGLE</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>parm</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>parm</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
<span class=w>      </span><span class=k>elif</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>parm</span>
<span class=w>        </span><span class=k>try</span>
<span class=w>          </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_PAR_SMART_ANTI_FREEZE</span><span class=p>)</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ctrl</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ctrl</span>
<span class=w>            </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=w>          </span><span class=k>else</span>
<span class=w>            </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span>
<span class=w>          </span><span class=k>end</span>
<span class=w>        </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>          </span><span class=k>return</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>else</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>        </span><span class=k>return</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWrite 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_PAR_SMART_ANTI_FREEZE</span><span class=p>,</span><span class=w> </span><span class=n>ctrl</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPExec&quot;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=k>try</span>
<span class=w>        </span><span class=n>ctrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_PAR_SMART_ANTI_FREEZE</span><span class=p>)</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ctrl</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>        </span><span class=k>return</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;%s&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>ctrl</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span><span class=p>))</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPTimer&lt;x&gt; 0|OFF|&lt;hh:mm hh:mm&gt;( &lt;period&gt;)|&lt;json&gt; (&lt;x&gt; = 1..12)</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPTimer</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>parm</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>PAR_TIMER_BLOCK</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>try</span>
<span class=w>      </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>      </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span>

<span class=w>      </span><span class=c1># Set timer</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args_switch</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span>
<span class=w>        </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&#39;</span>
<span class=w>      </span><span class=k>end</span>

<span class=w>      </span><span class=k>try</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>load</span><span class=p>(</span><span class=n>parm</span><span class=p>))</span>
<span class=w>          </span><span class=c1># convert none json parm to json parm</span>
<span class=w>          </span><span class=kd>var</span><span class=w> </span><span class=n>params</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span>
<span class=w>          </span><span class=kd>var</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;start&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;end&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;period&quot;</span><span class=p>]</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>params</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>keys</span><span class=p>)</span>
<span class=w>            </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>            </span><span class=k>return</span>
<span class=w>          </span><span class=k>end</span>
<span class=w>          </span><span class=kd>var</span><span class=w> </span><span class=n>_json</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{}</span>
<span class=w>          </span><span class=k>while</span><span class=w> </span><span class=n>params</span><span class=p>.</span><span class=nb>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span>
<span class=w>            </span><span class=n>_json</span><span class=p>[</span><span class=n>keys</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=w>            </span><span class=n>keys</span><span class=p>.</span><span class=nf>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=w>            </span><span class=n>params</span><span class=p>.</span><span class=nf>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=w>          </span><span class=k>end</span>
<span class=w>          </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>(</span><span class=n>_json</span><span class=p>)</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>        </span><span class=k>return</span>
<span class=w>      </span><span class=k>end</span>

<span class=w>      </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>load</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kc>nil</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>parm</span><span class=p>)</span>
<span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=n>timer_start</span><span class=p>,</span><span class=w> </span><span class=n>timer_end</span><span class=p>,</span><span class=w> </span><span class=n>strp</span>
<span class=w>        </span><span class=k>try</span>
<span class=w>            </span><span class=c1># set start and end</span>
<span class=w>          </span><span class=n>strp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>strptime</span><span class=p>(</span><span class=n>parm</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;start&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;00:00&quot;</span><span class=p>),</span><span class=w> </span><span class=s2>&quot;%H:%M&quot;</span><span class=p>)</span>
<span class=w>          </span><span class=n>timer_start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>strp</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;hour&quot;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>3600</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>strp</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;min&quot;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span><span class=p>)</span>
<span class=w>          </span><span class=n>strp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>strptime</span><span class=p>(</span><span class=n>parm</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;end&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;00:00&quot;</span><span class=p>),</span><span class=w> </span><span class=s2>&quot;%H:%M&quot;</span><span class=p>)</span>
<span class=w>          </span><span class=n>timer_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strp</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;hour&quot;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>3600</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>strp</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;min&quot;</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>60</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>timer_start</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>timer_end</span><span class=p>)</span>
<span class=w>            </span><span class=kd>var</span><span class=w> </span><span class=n>tmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timer_end</span>
<span class=w>            </span><span class=n>timer_end</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>timer_start</span>
<span class=w>            </span><span class=n>timer_start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tmp</span>
<span class=w>          </span><span class=k>end</span>
<span class=w>        </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>          </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>          </span><span class=k>return</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWrite 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_ENABLE</span><span class=p>,</span><span class=w> </span><span class=n>MBV_PAR_CTIMER_ENABLED</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWriteL 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_FUNCTION</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>1</span><span class=p>]),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWriteL 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_ON</span><span class=p>,</span><span class=w> </span><span class=n>timer_start</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWriteL 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_INTERVAL</span><span class=p>,</span><span class=w> </span><span class=n>timer_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timer_start</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>

<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>get_period_from_str</span><span class=p>(</span><span class=n>parm</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;Period&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>))</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>          </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWriteL 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>PAR_TIMER_BLOCK</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MBV_TIMER_OFFMB_TIMER_PERIOD</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_period_from_str</span><span class=p>(</span><span class=n>parm</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=s2>&quot;Period&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>))),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPExec&quot;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>

<span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_timer</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>)</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>res</span>
<span class=w>          </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>else</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>      </span><span class=k>end</span>

<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=c1># Get timer</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_timer</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>)</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>res</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
<span class=w>      </span><span class=k>end</span>

<span class=w>    </span><span class=k>end</span>

<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPVersion</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPVersion</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>verstr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>..</span><span class=w> </span><span class=mi>12</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWrite 0x%04X,%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_POWER_MODULE_REGISTER</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=o>*</span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_POWER_MODULE_DATA</span><span class=p>)</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>      </span><span class=n>verstr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>char</span><span class=p>(</span><span class=n>data</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=p>)</span>
<span class=w>      </span><span class=n>verstr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>char</span><span class=p>(</span><span class=n>data</span><span class=w>    </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0xFF</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>arr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>split</span><span class=p>(</span><span class=n>verstr</span><span class=p>,</span><span class=s1>&#39;\n&#39;</span><span class=p>)</span><span class=w> </span><span class=n>arr</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:%s}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>(</span><span class=n>arr</span><span class=p>)))</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPBackup (&lt;name&gt;( overwrite)</span>
<span class=w>  </span><span class=c1>#   &lt;name&gt; may contain strftime specifier</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPBackup</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>overwrite</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>machine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_PAR_UICFG_MACHINE</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>machine</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>    </span><span class=n>machine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>machine</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>MACHINE_NAMES</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>machine</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span>
<span class=w>      </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>parm</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span>
<span class=w>        </span><span class=n>overwrite</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>parm</span><span class=p>[</span><span class=mi>1</span><span class=p>]))</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>strftime</span><span class=p>(</span><span class=n>MACHINE_NAMES</span><span class=p>[</span><span class=n>machine</span><span class=p>]</span><span class=o>+</span><span class=s2>&quot;_&quot;</span><span class=o>+</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_NAME</span><span class=p>,</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>rtc</span><span class=p>()[</span><span class=s1>&#39;local&#39;</span><span class=p>])</span>
<span class=w>      </span><span class=n>name</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;%+03d:%02d&quot;</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>tasmota</span><span class=p>.</span><span class=nf>rtc</span><span class=p>()[</span><span class=s1>&#39;local&#39;</span><span class=p>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>rtc</span><span class=p>()[</span><span class=s1>&#39;utc&#39;</span><span class=p>])</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>3600</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=n>path</span><span class=p>.</span><span class=nf>mkdir</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=p>)</span>
<span class=w>    </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>strftime</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>rtc</span><span class=p>()[</span><span class=s1>&#39;local&#39;</span><span class=p>])</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>overwrite</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>overwrite</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=s1>&#39;o&#39;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>overwrite</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=nf>exists</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>name</span><span class=p>)</span>
<span class=w>          </span><span class=c1># overwrite, first delete existing</span>
<span class=w>          </span><span class=n>path</span><span class=p>.</span><span class=nf>remove</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>name</span><span class=p>)</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>else</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Error&quot;,&quot;File&quot;:&quot;%s&quot;,&quot;Msg&quot;:&quot;Unknown command %s&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>overwrite</span><span class=p>))</span>
<span class=w>        </span><span class=k>return</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=nf>exists</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>name</span><span class=p>)</span>
<span class=w>      </span><span class=c1># do not overwrite existing backups</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Error&quot;,&quot;File&quot;:&quot;%s&quot;,&quot;Msg&quot;:&quot;Already exists&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=c1># read register</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>reg_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]</span>
<span class=w>    </span><span class=k>try</span>
<span class=w>      </span><span class=k>for</span><span class=w> </span><span class=n>addr</span><span class=o>:</span><span class=nb>range</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_START_ADDR</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_END_ADDR</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>)</span>
<span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>)</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>
<span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=n>r</span>
<span class=w>          </span><span class=n>reg_data</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>      </span><span class=n>reg_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>reg_data</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Error&quot;,&quot;Msg&quot;:&quot;Reading Modbus register error&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=c1># write backup file</span>
<span class=w>    </span><span class=k>try</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>open</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;w&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>f</span><span class=p>.</span><span class=nf>write</span><span class=p>(</span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>({</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;0x%04X&quot;</span><span class=p>,</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_START_ADDR</span><span class=p>)</span><span class=o>:</span><span class=n>reg_data</span><span class=p>}))</span>
<span class=w>      </span><span class=n>f</span><span class=p>.</span><span class=nf>close</span><span class=p>()</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Error&quot;,&quot;File&quot;:&quot;%s&quot;,&quot;Msg&quot;:&quot;Writing file error&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Done&quot;,&quot;File&quot;:&quot;%s&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span>
<span class=w>    </span><span class=k>return</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPRestore &lt;name&gt;</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPRestore</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>machine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>read_register</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;NPRead&quot;</span><span class=p>,</span><span class=w> </span><span class=n>MBF_PAR_UICFG_MACHINE</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>machine</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>end</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span>
<span class=w>      </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>parm</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>path</span><span class=p>.</span><span class=nf>exists</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>name</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Error&quot;,&quot;File&quot;:&quot;%s&quot;,&quot;Msg&quot;:&quot;Does not exists&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=c1># Restore</span>
<span class=w>    </span><span class=c1># read backup file</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>backup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{}</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>f</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>open</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;r&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>try</span>
<span class=w>      </span><span class=n>backup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>load</span><span class=p>(</span><span class=n>f</span><span class=p>.</span><span class=nf>read</span><span class=p>())</span>
<span class=w>      </span><span class=n>f</span><span class=p>.</span><span class=nf>close</span><span class=p>()</span>
<span class=w>    </span><span class=k>except</span><span class=w> </span><span class=o>..</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Error&quot;,&quot;File&quot;:&quot;%s&quot;,&quot;Msg&quot;:&quot;JSON format error&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=c1># if any multiple addr sort it</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>addr_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=o>:</span><span class=n>backup</span><span class=p>.</span><span class=nf>keys</span><span class=p>()</span>
<span class=w>      </span><span class=n>addr_list</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>addr_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>list_sort</span><span class=p>(</span><span class=n>addr_list</span><span class=p>)</span>
<span class=w>    </span><span class=c1># do restore commands</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>addr</span><span class=o>:</span><span class=n>addr_list</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>reg_list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>backup</span><span class=p>[</span><span class=n>addr</span><span class=p>]</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>write_cmnd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=w>      </span><span class=kd>var</span><span class=w> </span><span class=n>write_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span>
<span class=w>      </span><span class=k>for</span><span class=w> </span><span class=n>reg_value</span><span class=o>:</span><span class=n>reg_list</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>RESTORE_EXCL</span><span class=p>.</span><span class=nf>find</span><span class=p>(</span><span class=n>write_addr</span><span class=p>)</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=s2>&quot;&quot;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>write_cmnd</span>
<span class=w>            </span><span class=n>write_cmnd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s2>&quot;NPWrite 0x%04X&quot;</span><span class=p>,</span><span class=w> </span><span class=n>write_addr</span><span class=p>)</span>
<span class=w>          </span><span class=k>end</span>
<span class=w>          </span><span class=n>write_cmnd</span><span class=w> </span><span class=o>+=</span><span class=s2>&quot;,&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>str</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>reg_value</span><span class=p>))</span>
<span class=w>          </span><span class=n>cnt</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span>
<span class=w>          </span><span class=k>if</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>8</span>
<span class=w>            </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>write_cmnd</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>            </span><span class=n>write_cmnd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>            </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=w>          </span><span class=k>end</span>
<span class=w>        </span><span class=k>elif</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>write_cmnd</span><span class=p>)</span>
<span class=w>          </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>write_cmnd</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>          </span><span class=n>write_cmnd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;&quot;</span>
<span class=w>          </span><span class=n>cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>        </span><span class=n>write_addr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>write_cmnd</span><span class=p>)</span>
<span class=w>        </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=n>write_cmnd</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPExec&quot;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPSave&quot;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Done&quot;,&quot;File&quot;:&quot;%s&quot;}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span>
<span class=w>    </span><span class=k>return</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPList</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPList</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:%s}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>(</span><span class=n>path</span><span class=p>.</span><span class=nf>listdir</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=p>))</span><span class=w> </span><span class=p>))</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=c1># NPPrune &lt;age&gt;( dry-run)</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>NPPrune</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>dry_run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_args</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span>
<span class=w>      </span><span class=n>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>get_period_from_str</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>parm</span><span class=p>[</span><span class=mi>0</span><span class=p>])))</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>parm</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nb>size</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>parm</span><span class=p>[</span><span class=mi>1</span><span class=p>])))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=s1>&#39;d&#39;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>tolower</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=nf>trim</span><span class=p>(</span><span class=n>parm</span><span class=p>[</span><span class=mi>1</span><span class=p>]))[</span><span class=mi>0</span><span class=p>]</span>
<span class=w>          </span><span class=n>dry_run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span>
<span class=w>        </span><span class=k>else</span>
<span class=w>          </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>          </span><span class=k>return</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd_error</span><span class=p>()</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>dfiles</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]</span>
<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>_filename</span><span class=o>:</span><span class=n>path</span><span class=p>.</span><span class=nf>listdir</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=p>)</span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tasmota</span><span class=p>.</span><span class=nf>rtc</span><span class=p>()[</span><span class=s1>&#39;local&#39;</span><span class=p>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=nf>last_modified</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>_filename</span><span class=p>))</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>age</span>
<span class=w>        </span><span class=n>dfiles</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=n>_filename</span><span class=p>)</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=o>!</span><span class=n>dry_run</span>
<span class=w>          </span><span class=n>path</span><span class=p>.</span><span class=nf>remove</span><span class=p>(</span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=o>+</span><span class=s2>&quot;/&quot;</span><span class=o>+</span><span class=n>_filename</span><span class=p>)</span>
<span class=w>        </span><span class=k>end</span>
<span class=w>      </span><span class=k>end</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>dry_run</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;dry-run&quot;,&quot;File&quot;:%s}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>(</span><span class=n>dfiles</span><span class=p>)))</span>
<span class=w>      </span><span class=k>return</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>resp_cmnd</span><span class=p>(</span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;{&quot;%s&quot;:&quot;Done&quot;,&quot;File&quot;:%s}&#39;</span><span class=p>,</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>json</span><span class=p>.</span><span class=nf>dump</span><span class=p>(</span><span class=n>dfiles</span><span class=p>)))</span>
<span class=w>  </span><span class=k>end</span>


<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>init</span><span class=p>()</span>
<span class=w>    </span><span class=c1># get tasmota settings</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_OFF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;StateText1&#39;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>).</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;StateText1&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;OFF&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_ON</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;StateText2&#39;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>).</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;StateText2&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ON&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>TEXT_TOGGLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;StateText3&#39;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>).</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;StateText3&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;TOGGLE&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_DIR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/.npbackup&quot;</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;%Y-%m-%dT%H:%M:%S&#39;</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_START_ADDR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x0400</span>
<span class=w>    </span><span class=kr>self</span><span class=p>.</span><span class=na>BACKUP_END_ADDR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mh>0x06FF</span>
<span class=w>    </span><span class=c1># add commands</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPAux&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPAux</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPAntiFreeze&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPAntiFreeze</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPTimer&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPTimer</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPVersion&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPVersion</span><span class=p>(</span><span class=n>cmd</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPBackup&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPBackup</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPRestore&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPRestore</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPList&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPList</span><span class=p>(</span><span class=n>cmd</span><span class=p>))</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>add_cmd</span><span class=p>(</span><span class=s1>&#39;NPPrune&#39;</span><span class=p>,</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kr>self</span><span class=p>.</span><span class=nf>NPPrune</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=n>idx</span><span class=p>,</span><span class=w> </span><span class=n>payload</span><span class=p>))</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>deinit</span><span class=p>()</span>
<span class=w>    </span><span class=c1># remove commands</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPAux&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPAntiFreeze&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPTimer&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPVersion&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPBackup&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPRestore&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPList&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>remove_cmd</span><span class=p>(</span><span class=s1>&#39;NPPrune&#39;</span><span class=p>)</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>
<span class=n>neopoolcommands</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>NeoPoolCommands</span><span class=p>()</span>
</code></pre></div> </details> <p>To activate the new commands, go to WebGUI "Consoles" / "Berry Scripting console" and execute</p> <div class=highlight><pre><span></span><code><span class=nf>load</span><span class=p>(</span><span class=s2>&quot;neopoolcmd.be&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=esp32-add-gui-controls-for-filtration-light-and-aux-relais>ESP32: Add GUI controls for filtration, light and aux relais<a class=headerlink href=#esp32-add-gui-controls-for-filtration-light-and-aux-relais title="Permanent link">~</a></h3> <p>The following enhancements are made using the <a href=../Berry/ >Berry Scripting Language</a> which is available on ESP32 only.</p> <p>The class <code>NeoPoolButtonMethods</code> below adds new GUI elements to control filtration, light and aux relais:</p> <p><img alt src=../_media/xsns_83_neopool_gui.png></p> <p>Store the following code into a Tasmota file by using the WebGUI "Console" / "Manage File system".</p> <h4 id=neopoolguibe>neopoolgui.be<a class=headerlink href=#neopoolguibe title="Permanent link">~</a></h4> <details class=summary> <summary>View script</summary> <div class=highlight><pre><span></span><code><span class=c1># File: neopoolgui.be</span>
<span class=c1>#</span>
<span class=c1># Add GUI elements for filtration control, light and aux relais</span>

<span class=kr>import</span><span class=w> </span><span class=n>webserver</span>
<span class=kr>import</span><span class=w> </span><span class=n>string</span>

<span class=kd>class</span><span class=w> </span><span class=nc>NeoPoolButtonMethods</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>Driver</span>

<span class=w>  </span><span class=cm>#- method for adding elements to the main menu -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_add_main_button</span><span class=p>()</span>

<span class=w>    </span><span class=kd>def</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>comp</span><span class=p>)</span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>comp</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s1>&#39;selected=&quot;&quot;&#39;</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s1>&#39;&#39;</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>html</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;&lt;p&gt;&lt;/p&gt;&#39;</span>

<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>speed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;NPFiltration&#39;</span><span class=p>).</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;Speed&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;invalid&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s1>&#39;NPFiltrationmode&#39;</span><span class=p>).</span><span class=nf>find</span><span class=p>(</span><span class=s1>&#39;NPFiltrationmode&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;invalid&#39;</span><span class=p>)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=s1>&#39;invalid&#39;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>speed</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=s1>&#39;invalid&#39;</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mode</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;NeoPool device not available&#39;</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>      </span><span class=c1># Filtration mode/speed</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;table style=&quot;width:100%&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:50%;padding: 0 4px 0 4px;&quot;&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;label for=&quot;mode&quot;&gt;&lt;small&gt;Mode:&lt;/small&gt;&lt;/label&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;select id=&quot;mode&quot; name=&quot;mode&quot;&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_manual&quot;%s&gt;Manual&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Manual&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_auto&quot;%s&gt;Auto&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Auto&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_heating&quot;%s&gt;Heating&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Heating&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_smart&quot;%s&gt;Smart&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Smart&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_intelligent&quot;%s&gt;Intelligent&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>mode</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Intelligent&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;/select&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:50%;padding: 0 4px 0 4px;&quot;&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;label for=&quot;speed&quot;&gt;&lt;small&gt;Speed:&lt;/label&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;select id=&quot;speed&quot; name=&quot;speed&quot;&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_slow&quot;%s&gt;Slow&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>speed</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_medium&quot;%s&gt;Medium&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>speed</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=n>string</span><span class=p>.</span><span class=nf>format</span><span class=p>(</span><span class=s1>&#39;&lt;option value=&quot;m_sv_fast&quot;%s&gt;Fast&lt;/option&gt;&#39;</span><span class=p>,</span><span class=w> </span><span class=nf>selected</span><span class=p>(</span><span class=n>speed</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=p>))</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;/select&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;/tr&gt;&lt;tr&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;script&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;document.getElementById(&quot;speed&quot;).addEventListener (&quot;change&quot;,function(){la(&quot;&amp;&quot;+this.value+&quot;=1&quot;);});&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;document.getElementById(&quot;mode&quot;).addEventListener (&quot;change&quot;,function(){la(&quot;&amp;&quot;+this.value+&quot;=1&quot;);});&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;/script&gt;&#39;</span>

<span class=w>      </span><span class=c1># Filtration button</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;table style=&quot;width:100%&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:100%&quot;&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;button id=&quot;bn_filtration&quot; name=&quot;bn_filtration&quot; onclick=&quot;la(\&#39;&amp;m_sv_filtration=1\&#39;);&quot;&gt;Filtration&lt;/button&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;/tr&gt;&lt;tr&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;</span>

<span class=w>      </span><span class=c1># Light button</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;table style=&quot;width:100%&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:100%&quot;&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;    &lt;button onclick=&quot;la(\&#39;&amp;m_sv_light=1\&#39;);&quot;&gt;Light&lt;/button&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;/tr&gt;&lt;tr&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;</span>

<span class=w>      </span><span class=c1># Aux buttons</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;table style=&quot;width:100%&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:25%&quot;&gt;&lt;button onclick=&quot;la(\&#39;&amp;m_sv_aux=1\&#39;);&quot;&gt;Aux1&lt;/button&gt;&lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:25%&quot;&gt;&lt;button onclick=&quot;la(\&#39;&amp;m_sv_aux=2\&#39;);&quot;&gt;Aux2&lt;/button&gt;&lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:25%&quot;&gt;&lt;button onclick=&quot;la(\&#39;&amp;m_sv_aux=3\&#39;);&quot;&gt;Aux3&lt;/button&gt;&lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;  &lt;td style=&quot;width:25%&quot;&gt;&lt;button onclick=&quot;la(\&#39;&amp;m_sv_aux=4\&#39;);&quot;&gt;Aux4&lt;/button&gt;&lt;/td&gt;&#39;</span>
<span class=w>      </span><span class=n>html</span><span class=o>+=</span><span class=w> </span><span class=s1>&#39;&lt;/tr&gt;&lt;tr&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&#39;</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=n>webserver</span><span class=p>.</span><span class=nf>content_send</span><span class=p>(</span><span class=n>html</span><span class=p>)</span>
<span class=w>    </span><span class=n>html</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=n>speed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=n>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>nil</span>
<span class=w>    </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>gc</span><span class=p>()</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=cm>#- As we can add only one sensor method we will have to combine them besides all other sensor readings in one method -#</span>
<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>web_sensor</span><span class=p>()</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_filtration&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltration 2&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_slow&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltration 1,1&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_medium&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltration 1,2&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_fast&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltration 1,3&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_manual&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltrationmode 0&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_auto&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltrationmode 1&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_heating&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltrationmode 2&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_smart&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltrationmode 3&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_intelligent&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPFiltrationmode 4&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_light&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPLight 2&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>webserver</span><span class=p>.</span><span class=nf>has_arg</span><span class=p>(</span><span class=s2>&quot;m_sv_aux&quot;</span><span class=p>)</span>
<span class=w>      </span><span class=n>tasmota</span><span class=p>.</span><span class=nf>cmd</span><span class=p>(</span><span class=s2>&quot;NPAux&quot;</span><span class=o>+</span><span class=n>webserver</span><span class=p>.</span><span class=nf>arg</span><span class=p>(</span><span class=s2>&quot;m_sv_aux&quot;</span><span class=p>)</span><span class=o>+</span><span class=s2>&quot; TOGGLE&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=k>end</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>init</span><span class=p>()</span>
<span class=w>  </span><span class=k>end</span>

<span class=w>  </span><span class=kd>def</span><span class=w> </span><span class=nf>deinit</span><span class=p>()</span>
<span class=w>  </span><span class=k>end</span>
<span class=k>end</span>

<span class=n>neopool_driver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>NeoPoolButtonMethods</span><span class=p>()</span>
<span class=n>tasmota</span><span class=p>.</span><span class=nf>add_driver</span><span class=p>(</span><span class=n>neopool_driver</span><span class=p>)</span>
</code></pre></div> </details> <p>To activate the new gui elements, go to WebGUI "Consoles" / "Berry Scripting console" and execute</p> <div class=highlight><pre><span></span><code><span class=nf>load</span><span class=p>(</span><span class=s2>&quot;neopoolgui.be&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=esp32-make-the-scripts-persistent>ESP32: Make the scripts persistent<a class=headerlink href=#esp32-make-the-scripts-persistent title="Permanent link">~</a></h3> <p>If you want the extensions to be activated automatically every time you restart your ESP32, save the <code>load()</code> commands into the special file <code>autoexec.be</code>:</p> <h4 id=autoexecbe>autoexec.be<a class=headerlink href=#autoexecbe title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=nf>load</span><span class=p>(</span><span class=s2>&quot;neopoolcmd.be&quot;</span><span class=p>)</span>
<span class=nf>load</span><span class=p>(</span><span class=s2>&quot;neopoolgui.be&quot;</span><span class=p>)</span>
</code></pre></div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M256 8a248 248 0 1 0 0 496 248 248 0 1 0 0-496m115 168.7c-3.7 39.2-19.9 134.4-28.1 178.3-3.5 18.6-10.3 24.8-16.9 25.4-14.4 1.3-25.3-9.5-39.3-18.7-21.8-14.3-34.2-23.2-55.3-37.2-24.5-16.1-8.6-25 5.3-39.5 3.7-3.8 67.1-61.5 68.3-66.7.2-.7.3-3.1-1.2-4.4s-3.6-.8-5.1-.5c-2.2.5-37.1 23.5-104.6 69.1-9.9 6.8-18.9 10.1-26.9 9.9-8.9-.2-25.9-5-38.6-9.1-15.5-5-27.9-7.7-26.8-16.3.6-4.5 6.7-9 18.4-13.7 72.3-31.5 120.5-52.3 144.6-62.3 68.9-28.6 83.2-33.6 92.5-33.8 2.1 0 6.6.5 9.6 2.9 2 1.7 3.2 4.1 3.5 6.7.5 3.2.6 6.5.4 9.8z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.action.edit", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../assets/javascripts/bundle.79ae519e.min.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../extra_javascript/tablesort.js></script> </body> </html>