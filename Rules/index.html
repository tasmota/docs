<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation (Wiki) for Tasmota"><link href=https://tasmota.github.io/docs/Rules/ rel=canonical><link href=../PWM-dimmer-switch/ rel=prev><link href=../Scripting-Language/ rel=next><link rel=icon href=../_media/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.3"><title>Rules - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Barlow";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-8J08F8X90S"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-8J08F8X90S",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-8J08F8X90S",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#rule-syntax class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title=Tasmota class="md-header__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tasmota </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Rules </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../Features/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../ESP32/ class=md-tabs__link> ESP32 </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> <li class=md-tabs__item> <a href=http://tasmota.github.io/install class=md-tabs__link> Web Installer </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota data-md-component=logo> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex=0> <span class=md-ellipsis> Home </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Home </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> News </span> </a> </li> <li class=md-nav__item> <a href=../About/ class=md-nav__link> <span class=md-ellipsis> About </span> </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../Upgrading/ class=md-nav__link> <span class=md-ellipsis> Upgrading </span> </a> </li> <li class=md-nav__item> <a href=../MQTT/ class=md-nav__link> <span class=md-ellipsis> MQTT </span> </a> </li> <li class=md-nav__item> <a href=../Commands/ class=md-nav__link> <span class=md-ellipsis> Commands </span> </a> </li> <li class=md-nav__item> <a href=../Templates/ class=md-nav__link> <span class=md-ellipsis> Templates </span> </a> </li> <li class=md-nav__item> <a href=../Components/ class=md-nav__link> <span class=md-ellipsis> Components </span> </a> </li> <li class=md-nav__item> <a href=../Modules/ class=md-nav__link> <span class=md-ellipsis> Modules </span> </a> </li> <li class=md-nav__item> <a href=../Peripherals/ class=md-nav__link> <span class=md-ellipsis> Peripherals </span> </a> </li> <li class=md-nav__item> <a href=../WebUI/ class=md-nav__link> <span class=md-ellipsis> WebUI </span> </a> </li> <li class=md-nav__item> <a href=../Firmware-Builds/ class=md-nav__link> <span class=md-ellipsis> Firmware Builds </span> </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ class=md-nav__link> <span class=md-ellipsis> Compiling </span> </a> </li> <li class=md-nav__item> <a href=../Contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=../Download/ class=md-nav__link> <span class=md-ellipsis> Download </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/discussions/categories/show-and-tell class=md-nav__link> <span class=md-ellipsis> Project Showcase </span> </a> </li> <li class=md-nav__item> <a href=../For-Developers/ class=md-nav__link> <span class=md-ellipsis> For Developers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Features </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Features/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../ADC/ class=md-nav__link> <span class=md-ellipsis> Analog Pin </span> </a> </li> <li class=md-nav__item> <a href=../ArtNet/ class=md-nav__link> <span class=md-ellipsis> ArtNet DMX </span> </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ class=md-nav__link> <span class=md-ellipsis> Buttons and Switches </span> </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ class=md-nav__link> <span class=md-ellipsis> DeepSleep </span> </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ class=md-nav__link> <span class=md-ellipsis> Device Groups </span> </a> </li> <li class=md-nav__item> <a href=../Universal-Display-Driver/ class=md-nav__link> <span class=md-ellipsis> Universal Display and Universal Touch drivers (uDisplay/uTouch) </span> </a> </li> <li class=md-nav__item> <a href=../Displays/ class=md-nav__link> <span class=md-ellipsis> Displays </span> </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ class=md-nav__link> <span class=md-ellipsis> Dynamic Sleep </span> </a> </li> <li class=md-nav__item> <a href=../I2CDEVICES/ class=md-nav__link> <span class=md-ellipsis> I2C Devices </span> </a> </li> <li class=md-nav__item> <a href=../I2S-Audio/ class=md-nav__link> <span class=md-ellipsis> I2S Audio </span> </a> </li> <li class=md-nav__item> <a href=../IPv6/ class=md-nav__link> <span class=md-ellipsis> IPv6 </span> </a> </li> <li class=md-nav__item> <a href=../Lights/ class=md-nav__link> <span class=md-ellipsis> Lights </span> </a> </li> <li class=md-nav__item> <a href=../Matter/ class=md-nav__link> <span class=md-ellipsis> Matter </span> </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ class=md-nav__link> <span class=md-ellipsis> PIR Motion Sensors </span> </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ class=md-nav__link> <span class=md-ellipsis> Power Monitoring Calibration </span> </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ class=md-nav__link> <span class=md-ellipsis> PWM Dimmer </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Rules </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Rules </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#rule-syntax class=md-nav__link> <span class=md-ellipsis> Rule Syntax </span> </a> <nav class=md-nav aria-label="Rule Syntax"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rule-trigger class=md-nav__link> <span class=md-ellipsis> Rule Trigger </span> </a> </li> <li class=md-nav__item> <a href=#rule-command class=md-nav__link> <span class=md-ellipsis> Rule Command </span> </a> </li> <li class=md-nav__item> <a href=#rule-variables class=md-nav__link> <span class=md-ellipsis> Rule Variables </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conditional-rules class=md-nav__link> <span class=md-ellipsis> Conditional Rules </span> </a> </li> <li class=md-nav__item> <a href=#expressions-in-rules class=md-nav__link> <span class=md-ellipsis> Expressions in Rules </span> </a> </li> <li class=md-nav__item> <a href=#rule-cookbook class=md-nav__link> <span class=md-ellipsis> Rule Cookbook </span> </a> <nav class=md-nav aria-label="Rule Cookbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#long-press-on-a-switch class=md-nav__link> <span class=md-ellipsis> Long press on a switch </span> </a> </li> <li class=md-nav__item> <a href=#send-mqtt-message-on-button-press class=md-nav__link> <span class=md-ellipsis> Send MQTT message on button press </span> </a> </li> <li class=md-nav__item> <a href=#usage-of-one-shot-once class=md-nav__link> <span class=md-ellipsis> Usage of one-shot (once) </span> </a> </li> <li class=md-nav__item> <a href=#use-a-potentiometer class=md-nav__link> <span class=md-ellipsis> Use a potentiometer </span> </a> </li> <li class=md-nav__item> <a href=#use-a-rotary-encoder class=md-nav__link> <span class=md-ellipsis> Use a rotary encoder </span> </a> </li> <li class=md-nav__item> <a href=#use-zigbee-to-control-tasmota-devices class=md-nav__link> <span class=md-ellipsis> Use Zigbee to control Tasmota devices </span> </a> </li> <li class=md-nav__item> <a href=#button-single-press-double-press-and-hold class=md-nav__link> <span class=md-ellipsis> Button single press, double press and hold </span> </a> </li> <li class=md-nav__item> <a href=#disable-switch-single-press-and-use-long-press class=md-nav__link> <span class=md-ellipsis> Disable switch single press and use long press </span> </a> </li> <li class=md-nav__item> <a href=#execute-several-commands-when-a-timer-expires class=md-nav__link> <span class=md-ellipsis> Execute several commands when a Timer expires </span> </a> </li> <li class=md-nav__item> <a href=#setting-variables class=md-nav__link> <span class=md-ellipsis> Setting variables </span> </a> </li> <li class=md-nav__item> <a href=#time-delayed-auto-off-switch class=md-nav__link> <span class=md-ellipsis> Time-delayed Auto-off Switch </span> </a> </li> <li class=md-nav__item> <a href=#time-delay-after-switch-off class=md-nav__link> <span class=md-ellipsis> Time-delay After Switch Off </span> </a> </li> <li class=md-nav__item> <a href=#auto-off-motion-sense-switch class=md-nav__link> <span class=md-ellipsis> Auto-off Motion Sense Switch </span> </a> </li> <li class=md-nav__item> <a href=#auto-off-if-or-when-current-is-idle class=md-nav__link> <span class=md-ellipsis> Auto-off if or when current is idle </span> </a> </li> <li class=md-nav__item> <a href=#control-timers-from-a-switch class=md-nav__link> <span class=md-ellipsis> Control Timers from a Switch </span> </a> </li> <li class=md-nav__item> <a href=#toggle-relay-when-holding-button-for-2-seconds class=md-nav__link> <span class=md-ellipsis> Toggle Relay when holding button for 2 seconds </span> </a> </li> <li class=md-nav__item> <a href=#make-sure-light-is-on-at-night class=md-nav__link> <span class=md-ellipsis> Make sure Light is on at night </span> </a> </li> <li class=md-nav__item> <a href=#turn-on-light-before-dawn-and-at-dusk class=md-nav__link> <span class=md-ellipsis> Turn On Light Before Dawn and At Dusk </span> </a> </li> <li class=md-nav__item> <a href=#turn-on-light-before-dawn-and-at-dusk_1 class=md-nav__link> <span class=md-ellipsis> Turn On Light Before Dawn and At Dusk </span> </a> </li> <li class=md-nav__item> <a href=#enable-a-pir-switch-only-at-night class=md-nav__link> <span class=md-ellipsis> Enable a PIR Switch only at night </span> </a> </li> <li class=md-nav__item> <a href=#control-luminance-switch-with-timer class=md-nav__link> <span class=md-ellipsis> Control luminance switch with Timer </span> </a> </li> <li class=md-nav__item> <a href=#automatically-vary-the-color-temperature-of-a-cct-light class=md-nav__link> <span class=md-ellipsis> Automatically vary the color temperature of a CCT light </span> </a> </li> <li class=md-nav__item> <a href=#perform-any-action-on-singledouble-press-for-switches-and-buttons class=md-nav__link> <span class=md-ellipsis> Perform any action on single/double press (for switches AND buttons) </span> </a> </li> <li class=md-nav__item> <a href=#enable-or-disable-relay-with-a-switch-in-domoticz class=md-nav__link> <span class=md-ellipsis> Enable or disable relay with a switch in Domoticz </span> </a> </li> <li class=md-nav__item> <a href=#force-automatic-re-connection-to-mqtt-server-via-sd-dns class=md-nav__link> <span class=md-ellipsis> Force automatic re-connection to MQTT server via SD DNS </span> </a> </li> <li class=md-nav__item> <a href=#change-distance-to-percentage class=md-nav__link> <span class=md-ellipsis> Change distance to percentage </span> </a> </li> <li class=md-nav__item> <a href=#distinguish-switch1-and-switch2-without-the-use-of-relay1-and-relay2 class=md-nav__link> <span class=md-ellipsis> Distinguish Switch1 and Switch2 (without the use of Relay1 and Relay2) </span> </a> </li> <li class=md-nav__item> <a href=#receiving-state-of-anything-that-triggers-switch-more-than-one-time class=md-nav__link> <span class=md-ellipsis> Receiving state of anything that triggers SWITCH more than one time </span> </a> </li> <li class=md-nav__item> <a href=#prevent-wemos-d1-mini-load-overcurrent class=md-nav__link> <span class=md-ellipsis> Prevent Wemos D1 mini load overcurrent </span> </a> </li> <li class=md-nav__item> <a href=#using-dummy-gpio-to-send-serial-codes-to-an-mcu class=md-nav__link> <span class=md-ellipsis> Using dummy GPIO to send Serial codes to an MCU </span> </a> </li> <li class=md-nav__item> <a href=#arithmetic-commands-used-with-var class=md-nav__link> <span class=md-ellipsis> Arithmetic commands used with VAR </span> </a> </li> <li class=md-nav__item> <a href=#transmit-sensor-value-only-when-a-delta-is-reached class=md-nav__link> <span class=md-ellipsis> Transmit sensor value only when a delta is reached </span> </a> </li> <li class=md-nav__item> <a href=#adjust-a-value-and-send-it-over-mqtt class=md-nav__link> <span class=md-ellipsis> Adjust a value and send it over MQTT </span> </a> </li> <li class=md-nav__item> <a href=#control-relays-via-serial class=md-nav__link> <span class=md-ellipsis> Control relays via serial </span> </a> </li> <li class=md-nav__item> <a href=#processing-json-received-from-softwareserialbridge class=md-nav__link> <span class=md-ellipsis> Processing JSON received from (Software)SerialBridge </span> </a> </li> <li class=md-nav__item> <a href=#using-break-to-simulate-ifelseifelseendif class=md-nav__link> <span class=md-ellipsis> Using BREAK to simulate IF..ELSEIF..ELSE..ENDIF </span> </a> </li> <li class=md-nav__item> <a href=#adjust-powerdelta-according-to-current-power-values class=md-nav__link> <span class=md-ellipsis> Adjust PowerDelta according to current Power values </span> </a> </li> <li class=md-nav__item> <a href=#forward-ir-signals class=md-nav__link> <span class=md-ellipsis> Forward IR signals </span> </a> </li> <li class=md-nav__item> <a href=#garage-door-opener class=md-nav__link> <span class=md-ellipsis> Garage Door Opener </span> </a> </li> <li class=md-nav__item> <a href=#ir-remote-button-multi-press class=md-nav__link> <span class=md-ellipsis> IR Remote Button Multi-press </span> </a> </li> <li class=md-nav__item> <a href=#two-way-light-switches-without-mqtt class=md-nav__link> <span class=md-ellipsis> Two-way light switches without MQTT </span> </a> </li> <li class=md-nav__item> <a href=#control-remote-light-on-switch-double-press class=md-nav__link> <span class=md-ellipsis> Control remote light on switch double press </span> </a> </li> <li class=md-nav__item> <a href=#roller-shutter-push-button-toggle class=md-nav__link> <span class=md-ellipsis> Roller shutter push-button toggle </span> </a> </li> <li class=md-nav__item> <a href=#control-a-dimmer-with-one-switch class=md-nav__link> <span class=md-ellipsis> Control a dimmer with one switch </span> </a> </li> <li class=md-nav__item> <a href=#watchdog-for-wi-fi-router-or-modem class=md-nav__link> <span class=md-ellipsis> Watchdog for Wi-Fi router or modem </span> </a> </li> <li class=md-nav__item> <a href=#simple-thermostat-example class=md-nav__link> <span class=md-ellipsis> Simple Thermostat Example </span> </a> </li> <li class=md-nav__item> <a href=#solar-heater-control class=md-nav__link> <span class=md-ellipsis> Solar heater control </span> </a> </li> <li class=md-nav__item> <a href=#energy-saving-switch class=md-nav__link> <span class=md-ellipsis> Energy Saving Switch </span> </a> </li> <li class=md-nav__item> <a href=#use-of-variables-and-tele-in-domoticz class=md-nav__link> <span class=md-ellipsis> Use of variables and tele- in Domoticz </span> </a> </li> <li class=md-nav__item> <a href=#publish-maximum-value-from-sensor-in-a-time-period class=md-nav__link> <span class=md-ellipsis> Publish Maximum Value from sensor in a time period </span> </a> </li> <li class=md-nav__item> <a href=#rf-repeater-ir-repeater class=md-nav__link> <span class=md-ellipsis> RF Repeater / IR Repeater </span> </a> </li> <li class=md-nav__item> <a href=#power-led-brightness-indicates-power-load class=md-nav__link> <span class=md-ellipsis> Power LED brightness indicates Power Load </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Scripting-Language/ class=md-nav__link> <span class=md-ellipsis> Scripting Language </span> </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ class=md-nav__link> <span class=md-ellipsis> Shutters and Blinds </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_21> <label class=md-nav__link for=__nav_2_21 id=__nav_2_21_label tabindex=0> <span class=md-ellipsis> Protocol Bridging </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_21_label aria-expanded=false> <label class=md-nav__title for=__nav_2_21> <span class="md-nav__icon md-icon"></span> Protocol Bridging </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../TasmotaClient/ class=md-nav__link> <span class=md-ellipsis> Arduino MCU </span> </a> </li> <li class=md-nav__item> <a href=../Bluetooth/ class=md-nav__link> <span class=md-ellipsis> BLE Gateway </span> </a> </li> <li class=md-nav__item> <a href=../DALI/ class=md-nav__link> <span class=md-ellipsis> DALI </span> </a> </li> <li class=md-nav__item> <a href=../HDMI_CEC/ class=md-nav__link> <span class=md-ellipsis> HDMI CEC </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ class=md-nav__link> <span class=md-ellipsis> IR Communication </span> </a> </li> <li class=md-nav__item> <a href=../Projector/ class=md-nav__link> <span class=md-ellipsis> LCD/DLP Projector Control </span> </a> </li> <li class=md-nav__item> <a href=../LoRa-and-LoRaWan-Bridge/ class=md-nav__link> <span class=md-ellipsis> LoRa and LoRaWan Bridge </span> </a> </li> <li class=md-nav__item> <a href=../Modbus-Bridge/ class=md-nav__link> <span class=md-ellipsis> Modbus Bridge </span> </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> <span class=md-ellipsis> OpenTherm </span> </a> </li> <li class=md-nav__item> <a href=../RF-Protocol/ class=md-nav__link> <span class=md-ellipsis> RF Communication </span> </a> </li> <li class=md-nav__item> <a href=../Serial-to-TCP-Bridge/ class=md-nav__link> <span class=md-ellipsis> Serial to TCP Bridge </span> </a> </li> <li class=md-nav__item> <a href=../TWAI/ class=md-nav__link> <span class=md-ellipsis> TWAI </span> </a> </li> <li class=md-nav__item> <a href=../Telegram/ class=md-nav__link> <span class=md-ellipsis> Telegram </span> </a> </li> <li class=md-nav__item> <a href=../Zigbee/ class=md-nav__link> <span class=md-ellipsis> Zigbee </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ class=md-nav__link> <span class=md-ellipsis> Smart Meter Interface </span> </a> </li> <li class=md-nav__item> <a href=../Thermostat/ class=md-nav__link> <span class=md-ellipsis> Thermostat </span> </a> </li> <li class=md-nav__item> <a href=../Timers/ class=md-nav__link> <span class=md-ellipsis> Timers </span> </a> </li> <li class=md-nav__item> <a href=../TLS/ class=md-nav__link> <span class=md-ellipsis> TLS Secured MQTT </span> </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ class=md-nav__link> <span class=md-ellipsis> TuyaMCU </span> </a> </li> <li class=md-nav__item> <a href=../UFS/ class=md-nav__link> <span class=md-ellipsis> Universal File System </span> </a> </li> <li class=md-nav__item> <a href=../Range-Extender/ class=md-nav__link> <span class=md-ellipsis> Wi-Fi Range Extender </span> </a> </li> <li class=md-nav__item> <a href=../Wireguard/ class=md-nav__link> <span class=md-ellipsis> Wireguard VPN </span> </a> </li> <li class=md-nav__item> <a href=../Tutorials/ class=md-nav__link> <span class=md-ellipsis> Projects and Tutorials </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> ESP32 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> ESP32 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ESP32/ class=md-nav__link> <span class=md-ellipsis> Tasmota32 Features </span> </a> </li> <li class=md-nav__item> <a href=../Berry/ class=md-nav__link> <span class=md-ellipsis> Berry </span> </a> </li> <li class=md-nav__item> <a href=../Bluetooth_ESP32/ class=md-nav__link> <span class=md-ellipsis> Bluetooth Low Energy </span> </a> </li> <li class=md-nav__item> <a href=../LVGL/ class=md-nav__link> <span class=md-ellipsis> LVGL </span> </a> </li> <li class=md-nav__item> <a href=../HASPmota/ class=md-nav__link> <span class=md-ellipsis> HASPmota </span> </a> </li> <li class=md-nav__item> <a href=../Matter/ class=md-nav__link> <span class=md-ellipsis> Matter </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-Extension/ class=md-nav__link> <span class=md-ellipsis> Tasmota Extension </span> </a> </li> <li class=md-nav__item> <a href=../Tasmota-Application/ class=md-nav__link> <span class=md-ellipsis> Tasmota Application Files </span> </a> </li> <li class=md-nav__item> <a href=../TFL/ class=md-nav__link> <span class=md-ellipsis> TensorFlow Lite </span> </a> </li> <li class=md-nav__item> <a href=../TouchPin/ class=md-nav__link> <span class=md-ellipsis> Touch GPIOs </span> </a> </li> <li class=md-nav__item> <a href=../Safeboot/ class=md-nav__link> <span class=md-ellipsis> Safeboot Partition Layout </span> </a> </li> <li class=md-nav__item> <a href=https://templates.blakadder.com/esp32 class=md-nav__link> <span class=md-ellipsis> Supported Devices </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Smart Home Integrations </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../Alexa/ class=md-nav__link> <span class=md-ellipsis> Alexa </span> </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ class=md-nav__link> <span class=md-ellipsis> AWS IoT </span> </a> </li> <li class=md-nav__item> <a href=../Domoticz/ class=md-nav__link> <span class=md-ellipsis> Domoticz </span> </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ class=md-nav__link> <span class=md-ellipsis> Home Assistant </span> </a> </li> <li class=md-nav__item> <a href=../Homebridge/ class=md-nav__link> <span class=md-ellipsis> Homebridge </span> </a> </li> <li class=md-nav__item> <a href=https://homey.app/en-us/app/com.paveld.tasmota/Tasmota-MQTT/ class=md-nav__link> <span class=md-ellipsis> Homey </span> </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ class=md-nav__link> <span class=md-ellipsis> HomeSeer </span> </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ class=md-nav__link> <span class=md-ellipsis> IP Symcon </span> </a> </li> <li class=md-nav__item> <a href=../KNX/ class=md-nav__link> <span class=md-ellipsis> KNX </span> </a> </li> <li class=md-nav__item> <a href=../NodeRed/ class=md-nav__link> <span class=md-ellipsis> NodeRed </span> </a> </li> <li class=md-nav__item> <a href=../nymea/ class=md-nav__link> <span class=md-ellipsis> nymea </span> </a> </li> <li class=md-nav__item> <a href=../Octoprint/ class=md-nav__link> <span class=md-ellipsis> OctoPrint </span> </a> </li> <li class=md-nav__item> <a href=../openHAB/ class=md-nav__link> <span class=md-ellipsis> openHAB </span> </a> </li> <li class=md-nav__item> <a href=../otto/ class=md-nav__link> <span class=md-ellipsis> Otto </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 class=md-nav__link> <span class=md-ellipsis> IOBroker </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter class=md-nav__link> <span class=md-ellipsis> Mozilla WebThings Adapter </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/hongtat/tasmota-connect class=md-nav__link> <span class=md-ellipsis> SmartThings </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/Gifford47/tasmohab/blob/master/README.md class=md-nav__link> <span class=md-ellipsis> Tasmohab </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Supported-Peripherals/ class=md-nav__link> <span class=md-ellipsis> Peripherals </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Supported Devices </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-nav__link> <span class=md-ellipsis> Configure Unknown Device </span> </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' class=md-nav__link> <span class=md-ellipsis> All Supported Devices </span> </a> </li> <li class=md-nav__item> <a href=../Pinouts/ class=md-nav__link> <span class=md-ellipsis> Wi-Fi Module Pinouts </span> </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ class=md-nav__link> <span class=md-ellipsis> Supported Modules </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Help </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ class=md-nav__link> <span class=md-ellipsis> FAQ </span> </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ class=md-nav__link> <span class=md-ellipsis> Device Recovery </span> </a> </li> <li class=md-nav__item> <a href="https://discord.gg/Ks2Kzd4 " target='_blank""' class=md-nav__link> <span class=md-ellipsis> Discord Support </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=http://tasmota.github.io/install class=md-nav__link> <span class=md-ellipsis> Web Installer </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#rule-syntax class=md-nav__link> <span class=md-ellipsis> Rule Syntax </span> </a> <nav class=md-nav aria-label="Rule Syntax"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rule-trigger class=md-nav__link> <span class=md-ellipsis> Rule Trigger </span> </a> </li> <li class=md-nav__item> <a href=#rule-command class=md-nav__link> <span class=md-ellipsis> Rule Command </span> </a> </li> <li class=md-nav__item> <a href=#rule-variables class=md-nav__link> <span class=md-ellipsis> Rule Variables </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#conditional-rules class=md-nav__link> <span class=md-ellipsis> Conditional Rules </span> </a> </li> <li class=md-nav__item> <a href=#expressions-in-rules class=md-nav__link> <span class=md-ellipsis> Expressions in Rules </span> </a> </li> <li class=md-nav__item> <a href=#rule-cookbook class=md-nav__link> <span class=md-ellipsis> Rule Cookbook </span> </a> <nav class=md-nav aria-label="Rule Cookbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#long-press-on-a-switch class=md-nav__link> <span class=md-ellipsis> Long press on a switch </span> </a> </li> <li class=md-nav__item> <a href=#send-mqtt-message-on-button-press class=md-nav__link> <span class=md-ellipsis> Send MQTT message on button press </span> </a> </li> <li class=md-nav__item> <a href=#usage-of-one-shot-once class=md-nav__link> <span class=md-ellipsis> Usage of one-shot (once) </span> </a> </li> <li class=md-nav__item> <a href=#use-a-potentiometer class=md-nav__link> <span class=md-ellipsis> Use a potentiometer </span> </a> </li> <li class=md-nav__item> <a href=#use-a-rotary-encoder class=md-nav__link> <span class=md-ellipsis> Use a rotary encoder </span> </a> </li> <li class=md-nav__item> <a href=#use-zigbee-to-control-tasmota-devices class=md-nav__link> <span class=md-ellipsis> Use Zigbee to control Tasmota devices </span> </a> </li> <li class=md-nav__item> <a href=#button-single-press-double-press-and-hold class=md-nav__link> <span class=md-ellipsis> Button single press, double press and hold </span> </a> </li> <li class=md-nav__item> <a href=#disable-switch-single-press-and-use-long-press class=md-nav__link> <span class=md-ellipsis> Disable switch single press and use long press </span> </a> </li> <li class=md-nav__item> <a href=#execute-several-commands-when-a-timer-expires class=md-nav__link> <span class=md-ellipsis> Execute several commands when a Timer expires </span> </a> </li> <li class=md-nav__item> <a href=#setting-variables class=md-nav__link> <span class=md-ellipsis> Setting variables </span> </a> </li> <li class=md-nav__item> <a href=#time-delayed-auto-off-switch class=md-nav__link> <span class=md-ellipsis> Time-delayed Auto-off Switch </span> </a> </li> <li class=md-nav__item> <a href=#time-delay-after-switch-off class=md-nav__link> <span class=md-ellipsis> Time-delay After Switch Off </span> </a> </li> <li class=md-nav__item> <a href=#auto-off-motion-sense-switch class=md-nav__link> <span class=md-ellipsis> Auto-off Motion Sense Switch </span> </a> </li> <li class=md-nav__item> <a href=#auto-off-if-or-when-current-is-idle class=md-nav__link> <span class=md-ellipsis> Auto-off if or when current is idle </span> </a> </li> <li class=md-nav__item> <a href=#control-timers-from-a-switch class=md-nav__link> <span class=md-ellipsis> Control Timers from a Switch </span> </a> </li> <li class=md-nav__item> <a href=#toggle-relay-when-holding-button-for-2-seconds class=md-nav__link> <span class=md-ellipsis> Toggle Relay when holding button for 2 seconds </span> </a> </li> <li class=md-nav__item> <a href=#make-sure-light-is-on-at-night class=md-nav__link> <span class=md-ellipsis> Make sure Light is on at night </span> </a> </li> <li class=md-nav__item> <a href=#turn-on-light-before-dawn-and-at-dusk class=md-nav__link> <span class=md-ellipsis> Turn On Light Before Dawn and At Dusk </span> </a> </li> <li class=md-nav__item> <a href=#turn-on-light-before-dawn-and-at-dusk_1 class=md-nav__link> <span class=md-ellipsis> Turn On Light Before Dawn and At Dusk </span> </a> </li> <li class=md-nav__item> <a href=#enable-a-pir-switch-only-at-night class=md-nav__link> <span class=md-ellipsis> Enable a PIR Switch only at night </span> </a> </li> <li class=md-nav__item> <a href=#control-luminance-switch-with-timer class=md-nav__link> <span class=md-ellipsis> Control luminance switch with Timer </span> </a> </li> <li class=md-nav__item> <a href=#automatically-vary-the-color-temperature-of-a-cct-light class=md-nav__link> <span class=md-ellipsis> Automatically vary the color temperature of a CCT light </span> </a> </li> <li class=md-nav__item> <a href=#perform-any-action-on-singledouble-press-for-switches-and-buttons class=md-nav__link> <span class=md-ellipsis> Perform any action on single/double press (for switches AND buttons) </span> </a> </li> <li class=md-nav__item> <a href=#enable-or-disable-relay-with-a-switch-in-domoticz class=md-nav__link> <span class=md-ellipsis> Enable or disable relay with a switch in Domoticz </span> </a> </li> <li class=md-nav__item> <a href=#force-automatic-re-connection-to-mqtt-server-via-sd-dns class=md-nav__link> <span class=md-ellipsis> Force automatic re-connection to MQTT server via SD DNS </span> </a> </li> <li class=md-nav__item> <a href=#change-distance-to-percentage class=md-nav__link> <span class=md-ellipsis> Change distance to percentage </span> </a> </li> <li class=md-nav__item> <a href=#distinguish-switch1-and-switch2-without-the-use-of-relay1-and-relay2 class=md-nav__link> <span class=md-ellipsis> Distinguish Switch1 and Switch2 (without the use of Relay1 and Relay2) </span> </a> </li> <li class=md-nav__item> <a href=#receiving-state-of-anything-that-triggers-switch-more-than-one-time class=md-nav__link> <span class=md-ellipsis> Receiving state of anything that triggers SWITCH more than one time </span> </a> </li> <li class=md-nav__item> <a href=#prevent-wemos-d1-mini-load-overcurrent class=md-nav__link> <span class=md-ellipsis> Prevent Wemos D1 mini load overcurrent </span> </a> </li> <li class=md-nav__item> <a href=#using-dummy-gpio-to-send-serial-codes-to-an-mcu class=md-nav__link> <span class=md-ellipsis> Using dummy GPIO to send Serial codes to an MCU </span> </a> </li> <li class=md-nav__item> <a href=#arithmetic-commands-used-with-var class=md-nav__link> <span class=md-ellipsis> Arithmetic commands used with VAR </span> </a> </li> <li class=md-nav__item> <a href=#transmit-sensor-value-only-when-a-delta-is-reached class=md-nav__link> <span class=md-ellipsis> Transmit sensor value only when a delta is reached </span> </a> </li> <li class=md-nav__item> <a href=#adjust-a-value-and-send-it-over-mqtt class=md-nav__link> <span class=md-ellipsis> Adjust a value and send it over MQTT </span> </a> </li> <li class=md-nav__item> <a href=#control-relays-via-serial class=md-nav__link> <span class=md-ellipsis> Control relays via serial </span> </a> </li> <li class=md-nav__item> <a href=#processing-json-received-from-softwareserialbridge class=md-nav__link> <span class=md-ellipsis> Processing JSON received from (Software)SerialBridge </span> </a> </li> <li class=md-nav__item> <a href=#using-break-to-simulate-ifelseifelseendif class=md-nav__link> <span class=md-ellipsis> Using BREAK to simulate IF..ELSEIF..ELSE..ENDIF </span> </a> </li> <li class=md-nav__item> <a href=#adjust-powerdelta-according-to-current-power-values class=md-nav__link> <span class=md-ellipsis> Adjust PowerDelta according to current Power values </span> </a> </li> <li class=md-nav__item> <a href=#forward-ir-signals class=md-nav__link> <span class=md-ellipsis> Forward IR signals </span> </a> </li> <li class=md-nav__item> <a href=#garage-door-opener class=md-nav__link> <span class=md-ellipsis> Garage Door Opener </span> </a> </li> <li class=md-nav__item> <a href=#ir-remote-button-multi-press class=md-nav__link> <span class=md-ellipsis> IR Remote Button Multi-press </span> </a> </li> <li class=md-nav__item> <a href=#two-way-light-switches-without-mqtt class=md-nav__link> <span class=md-ellipsis> Two-way light switches without MQTT </span> </a> </li> <li class=md-nav__item> <a href=#control-remote-light-on-switch-double-press class=md-nav__link> <span class=md-ellipsis> Control remote light on switch double press </span> </a> </li> <li class=md-nav__item> <a href=#roller-shutter-push-button-toggle class=md-nav__link> <span class=md-ellipsis> Roller shutter push-button toggle </span> </a> </li> <li class=md-nav__item> <a href=#control-a-dimmer-with-one-switch class=md-nav__link> <span class=md-ellipsis> Control a dimmer with one switch </span> </a> </li> <li class=md-nav__item> <a href=#watchdog-for-wi-fi-router-or-modem class=md-nav__link> <span class=md-ellipsis> Watchdog for Wi-Fi router or modem </span> </a> </li> <li class=md-nav__item> <a href=#simple-thermostat-example class=md-nav__link> <span class=md-ellipsis> Simple Thermostat Example </span> </a> </li> <li class=md-nav__item> <a href=#solar-heater-control class=md-nav__link> <span class=md-ellipsis> Solar heater control </span> </a> </li> <li class=md-nav__item> <a href=#energy-saving-switch class=md-nav__link> <span class=md-ellipsis> Energy Saving Switch </span> </a> </li> <li class=md-nav__item> <a href=#use-of-variables-and-tele-in-domoticz class=md-nav__link> <span class=md-ellipsis> Use of variables and tele- in Domoticz </span> </a> </li> <li class=md-nav__item> <a href=#publish-maximum-value-from-sensor-in-a-time-period class=md-nav__link> <span class=md-ellipsis> Publish Maximum Value from sensor in a time period </span> </a> </li> <li class=md-nav__item> <a href=#rf-repeater-ir-repeater class=md-nav__link> <span class=md-ellipsis> RF Repeater / IR Repeater </span> </a> </li> <li class=md-nav__item> <a href=#power-led-brightness-indicates-power-load class=md-nav__link> <span class=md-ellipsis> Power LED brightness indicates Power Load </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/Rules.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1>Rules</h1> <div class="admonition info"> <p class=admonition-title>Rules expand the functionality of Tasmota with user configurable flexible logic</p> </div> <p>Tasmota provides a Rule feature heavily inspired by the <em>ESPEasy</em> implementation while maintaining a small memory footprint. Automation solutions can be implemented without having to add dedicated code or use external solutions. </p> <p>Rules perform actions based on triggers (e.g., switch state change, temperature threshold, events like system boot, a defined timer elapsing, custom defined events, etc.) They are stored in flash and therefore will survive a reboot.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Most pre-compiled <a href=../Firmware-Builds/ >builds</a> have the Rules feature enabled. <em>If you are &gt;compiling your own firmware, in order to use rules, include <code>#define USE_RULES</code> in <code>user_config_override.h</code>.</em></p> </div> <p><strong>List of <a href=../Commands/#rules>Rules Commands</a></strong> </p> <h2 id=rule-syntax>Rule Syntax<a class=headerlink href=#rule-syntax title="Permanent link">~</a></h2> <p>Rule definition syntax </p> <div class=highlight><pre><span></span><code><span class=kt>ON</span><span class=w> </span><span class=o>&lt;</span><span class=n>trigger</span><span class=o>&gt;</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=o>&lt;</span><span class=n>command</span><span class=o>&gt;</span><span class=w> </span><span class=p>[</span><span class=kt>ENDON</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=kt>BREAK</span><span class=p>]</span>
</code></pre></div> <ul> <li><strong><code>ON</code></strong> - marks the beginning of a rule </li> <li><strong><code>&lt;trigger&gt;</code></strong> - what condition needs to occur for the rule to trigger </li> <li><strong><code>DO</code></strong> - statement marking end of trigger and beginning of command part</li> <li><strong><code>&lt;command&gt;</code></strong> - command that is executed if the <code>&lt;trigger&gt;</code> condition is met </li> <li><strong><code>ENDON</code></strong> - marks the end of a rule. It can be followed by another rule.</li> <li><strong><code>BREAK</code></strong> - marks the end of a rule. <code>BREAK</code> will stop the execution of the remaining rules that follow this rule within the rule set. If a rule that ends with <code>BREAK</code> is triggered, the following rules in that rule set will not be executed. This allows the rules to somewhat simulate an "IF/ELSE" statement. </li> </ul> <p>Rule sets are defined by using the <a href=../Commands/#rule><code>Rule&lt;x&gt;</code></a> command. After defining a rule set, you have to enable it (turn it on) using <code>Rule&lt;x&gt; 1</code>. Similarly you can disable the rule set using <code>Rule&lt;x&gt; 0</code>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>If bootloops are detected all rules will be disabled as a precaution. See <a href=../Commands/#setoption36>SetOption36</a>.</p> </div> <p>There are three separate <strong>rule sets</strong> called <code>Rule1</code>, <code>Rule2</code> and <code>Rule3</code>. Each rule set can contain many rules. The number of rules that can fit in a rule set varies, but expect at least 1000 characters available per set. Additionally, rules are dynamically compressed, meaning they will be compressed automatically when doing so is required, but left uncompressed until that point.</p> <p>Whenever a rule set is enabled all the rules in it will be active. If the character count of the rules in one set actually exceeds the limit, start using the next rule set. If you have a long list of rules, verify the rules have all fit by inspecting the resulting log.</p> <p>Rules inside a rule set <code>Rule&lt;x&gt;</code> are concatenated and entered as a single statement. </p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=o>&lt;</span><span class=n>x</span><span class=o>&gt;</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=o>&lt;</span><span class=n>trigger1</span><span class=o>&gt;</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=o>&lt;</span><span class=n>command</span><span class=o>&gt;</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=o>&lt;</span><span class=n>trigger2</span><span class=o>&gt;</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=o>&lt;</span><span class=n>command</span><span class=o>&gt;</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span><span class=o>...</span>
</code></pre></div> <p>Spaces after <code>ON</code>, around <code>DO</code>, and before <code>ENDON</code> or <code>BREAK</code> are mandatory. A rule is <strong>not</strong> case sensitive. </p> <h3 id=rule-trigger>Rule Trigger<a class=headerlink href=#rule-trigger title="Permanent link">~</a></h3> <p>Rule trigger names are derived from the JSON message displayed in the console. Each JSON level (all values enclosed in <code>{...}</code>) is separated in the trigger with a <code>#</code>. Top level JSON fields are referenced without any <code>#</code>, except when the JSON has only one field, where you need <code>#Data</code>.</p> <p>A rule trigger can consist of: </p> <ul> <li><code>[TriggerName]#[ValueName]</code></li> <li><code>[TriggerName]#[ValueName][comparison][value]</code></li> <li><code>[SensorName]#[ValueName]</code></li> <li><code>[SensorName]#[ValueName][comparison][value]</code></li> <li><code>Tele-[SensorName]#[ValueName]</code></li> <li><code>[TriggerName1]#[TriggerName2]#[ValueName]</code></li> <li><code>[TriggerName1]#?#[ValueName]</code></li> <li><code>[ValueName]</code></li> <li><code>[ValueName#Data]</code></li> </ul> <p>Use <code>?</code> as a wildcard for a single trigger level. Rule will trigger on <code>[TriggerName]#?#[Value]</code> where <code>?</code> is any value.</p> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Rule with a trigger of <code>ZBReceived#?#Power=0</code> will trigger on <code>{"ZBReceived":{"0x4773":{"Power":0}}}</code> and on <code>{"ZBReceived":{"aqara_switch":{"Power":0}}}</code> both.</p> </div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Same trigger may be used in more than one rule. This may be required for some cases of using <code>IF/ELSE</code> since an <code>IF</code> statement cannot be used within a <code>Backlog</code>.</p> </div> <h4 id=rule-trigger-comparison-operators>Rule Trigger Comparison Operators<a class=headerlink href=#rule-trigger-comparison-operators title="Permanent link">~</a></h4> <table> <thead> <tr> <th style="text-align: center;">Operator</th> <th style="text-align: left;">Function</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;"><code>=</code></td> <td style="text-align: left;">equal to (used for string comparison)</td> </tr> <tr> <td style="text-align: center;"><code>==</code></td> <td style="text-align: left;">equal to (used for numerical comparison)</td> </tr> <tr> <td style="text-align: center;"><code>&gt;</code></td> <td style="text-align: left;">greater than</td> </tr> <tr> <td style="text-align: center;"><code>&lt;</code></td> <td style="text-align: left;">lesser than</td> </tr> <tr> <td style="text-align: center;"><code>!=</code></td> <td style="text-align: left;">number not equal to (for string see below)</td> </tr> <tr> <td style="text-align: center;"><code>&gt;=</code></td> <td style="text-align: left;">greater than or equal to</td> </tr> <tr> <td style="text-align: center;"><code>&lt;=</code></td> <td style="text-align: left;">lesser than or equal to</td> </tr> <tr> <td style="text-align: center;"><code>$&lt;</code></td> <td style="text-align: left;">string starts with</td> </tr> <tr> <td style="text-align: center;"><code>$&gt;</code></td> <td style="text-align: left;">string ends with</td> </tr> <tr> <td style="text-align: center;"><code>$|</code></td> <td style="text-align: left;">string contains</td> </tr> <tr> <td style="text-align: center;"><code>$!</code></td> <td style="text-align: left;">string is not equal to</td> </tr> <tr> <td style="text-align: center;"><code>$^</code></td> <td style="text-align: left;">string does not contain</td> </tr> <tr> <td style="text-align: center;"><code>|</code></td> <td style="text-align: left;">used for <a href=https://en.wikipedia.org/wiki/Modulo_operation>modulo operation</a> with remainder = 0 (exact division)</td> </tr> </tbody> </table> <h4 id=examples-of-available-triggers>Examples of Available Triggers<a class=headerlink href=#examples-of-available-triggers title="Permanent link">~</a></h4> <p><em>This is just a sampling of available triggers to showcase what is possible and not a definitive list</em></p> <table> <thead> <tr> <th style="text-align: left;">Trigger</th> <th style="text-align: left;">When it occurs</th> </tr> </thead> <tbody> <tr> <td style="text-align: left;">Analog#A0div10<a id=Analog></a></td> <td style="text-align: left;">when the <code>A0</code> input changes by more than 1% it provides a value between 0 and 100</td> </tr> <tr> <td style="text-align: left;">Button2#State<a id=ButtonState></a></td> <td style="text-align: left;">when a button changes state:<br><code>0</code> = OFF<br><code>1</code> = ON<br><code>2</code> = TOGGLE<br><code>3</code> = HOLD</td> </tr> <tr> <td style="text-align: left;">Clock#Timer=3<a id=ClockTimer></a></td> <td style="text-align: left;">when global <code>Timer3</code> is activated</td> </tr> <tr> <td style="text-align: left;">Dimmer#Boot<a id=DimmerBoot></a></td> <td style="text-align: left;">occurs after Tasmota starts<a id=ADC0></a></td> </tr> <tr> <td style="text-align: left;">Dimmer#State<a id=DimmerState></a></td> <td style="text-align: left;">when the value for Dimmer is changed</td> </tr> <tr> <td style="text-align: left;">Eth#Connected<a id=EthConnected></a></td> <td style="text-align: left;">when Ethernet is connected (ESP32 only)</td> </tr> <tr> <td style="text-align: left;">Eth#Disconnected<a id=EthDisconnected></a></td> <td style="text-align: left;">when Ethernet is disconnected (ESP32 only)</td> </tr> <tr> <td style="text-align: left;">Event#eventName<a id=EventeventName></a></td> <td style="text-align: left;">when command <code>Event eventName</code> is executed. You can define your own event values and trigger them with the <a href=../Commands/#event><code>Event</code></a> command. An event with a <code>=</code> will provide a <code>%value%</code> to use in the execution part of the rule. Example: Command <code>Event speed=2</code> in rule trigger <code>on event#speed</code> will have the <code>%value%</code> of <code>2</code>.</td> </tr> <tr> <td style="text-align: left;">FanSpeed#Data=3</td> <td style="text-align: left;">when the fan speed is set to <code>3</code></td> </tr> <tr> <td style="text-align: left;">Mem&lt;x&gt;#State<a id=MemState></a></td> <td style="text-align: left;">when the value for Mem&lt;x&gt; is changed</td> </tr> <tr> <td style="text-align: left;">Http#Initialized<a id=HttpInitialized></a></td> <td style="text-align: left;"></td> </tr> <tr> <td style="text-align: left;">Mqtt#Connected<a id=MqttConnected></a></td> <td style="text-align: left;">when MQTT is connected</td> </tr> <tr> <td style="text-align: left;">Mqtt#Disconnected<a id=MqttDisconnected></a></td> <td style="text-align: left;">when MQTT is disconnected</td> </tr> <tr> <td style="text-align: left;">Power1#Boot<a id=PowerBoot></a></td> <td style="text-align: left;"><code>Relay1</code> state before Wi-Fi and MQTT are connected and before Time sync but after <code>PowerOnState</code> is executed. Power#Boot triggers before System#Boot.<br>This trigger's value will be the last state of <code>Relay1</code> if <a href=../Commands/#poweronstate><code>PowerOnState</code></a> is set to its default value (<code>3</code>).</td> </tr> <tr> <td style="text-align: left;">Power1#State<a id=PowerState></a></td> <td style="text-align: left;">when a power output is changed<br>use <code>Power1#state=0</code> and <code>Power1#state=1</code> for comparison, not =off or =on<br>Power2 for Relay2, etc.</td> </tr> <tr> <td style="text-align: left;">Rotary1#Pos1<a id=Rotary></a></td> <td style="text-align: left;">when rotary encoder change. See <a href=#use-a-rotary-encoder>Use a rotary encoder</a>.</td> </tr> <tr> <td style="text-align: left;">Rules#Timer=&lt;x&gt;</td> <td style="text-align: left;">when countdown <code>RuleTimer&lt;x&gt;</code> expires (x = <code>1..8</code>).</td> </tr> <tr> <td style="text-align: left;">Switch1#Boot<a id=SwitchBoot></a></td> <td style="text-align: left;">occurs after Tasmota starts before it is initializated.</td> </tr> <tr> <td style="text-align: left;">Switch1#State<a id=SwitchState></a></td> <td style="text-align: left;">when a switch changes to state. Will not trigger if SwitchTopic is set.<br>use <code>Switch1#state=0</code> and <code>Switch1#state=1</code> for comparison, not =off or =on<br><code>0</code> = OFF<br><code>1</code> = ON<br><code>2</code> = TOGGLE<br><code>3</code> = HOLD (<code>SwitchTopic 0</code> must be set for this to trigger)<br><code>4</code> = INC_DEC (increment or decrement dimmer)<br><code>5</code> = INV (change from increment to decrement dimmer and vice versa)<br><code>6</code> = CLEAR (button released for the time set with <code>SetOption32</code>)</td> </tr> <tr> <td style="text-align: left;">System#Boot<a id=SystemBoot></a></td> <td style="text-align: left;">occurs once after Tasmota is fully initialized (after the INFO1, INFO2 and INFO3 console messages). <code>System#Boot</code> triggers after Wi-Fi and MQTT (if enabled) are connected. If you need a trigger prior to every service being initialized, use <code>Power1#Boot</code></td> </tr> <tr> <td style="text-align: left;">System#Init<a id=SystemInit></a></td> <td style="text-align: left;">occurs once after restart before Wi-Fi and MQTT are initialized</td> </tr> <tr> <td style="text-align: left;">System#Save<a id=SystemSave></a></td> <td style="text-align: left;">executed just before a planned restart</td> </tr> <tr> <td style="text-align: left;">Time#Initialized<a id=TimeInitialized></a></td> <td style="text-align: left;">once when NTP is initialized and time is in sync</td> </tr> <tr> <td style="text-align: left;">Time#Minute<a id=TimeMinute></a></td> <td style="text-align: left;">every minute</td> </tr> <tr> <td style="text-align: left;">Time#Minute|5</td> <td style="text-align: left;">every five minutes</td> </tr> <tr> <td style="text-align: left;">Time#Minute=241</td> <td style="text-align: left;">every day once at 04:01 (241 minutes after midnight)</td> </tr> <tr> <td style="text-align: left;">Time#Set<a id=TimeSet></a></td> <td style="text-align: left;">every hour when NTP makes time in sync</td> </tr> <tr> <td style="text-align: left;">Var&lt;x&gt;#State<a id=VarState></a></td> <td style="text-align: left;">when the value for Var&lt;x&gt; is changed (triggers whenever a value is written to <code>Var&lt;x&gt;</code> even if it's the same value)</td> </tr> <tr> <td style="text-align: left;">Wifi#Connected<a id=WifiConnected></a></td> <td style="text-align: left;">when Wi-Fi is connected</td> </tr> <tr> <td style="text-align: left;">Wifi#Disconnected<a id=WifiDisconnected></a></td> <td style="text-align: left;">when Wi-Fi is disconnected</td> </tr> <tr> <td style="text-align: left;">Tele-Heap<a id=tele-Heap></a></td> <td style="text-align: left;">when a teleperiod message is sent with available heap memory (example of top-level JSON)</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#AP<a id=tele-Wifi-AP></a></td> <td style="text-align: left;">when a teleperiod message is sent with the number of the used AP</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#Ssid<a id=tele-Wifi-Ssid></a></td> <td style="text-align: left;">when a teleperiod message is sent with the name of the used AP</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#Bssid<a id=tele-Wifi-Bssid></a></td> <td style="text-align: left;">when a teleperiod message is sent with the name of the bSSID</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#Channel<a id=tele-Wifi-Channel></a></td> <td style="text-align: left;">when a teleperiod message is sent with the number of the wifi channel used</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#RSSI<a id=tele-Wifi-RSSI></a></td> <td style="text-align: left;">when a teleperiod message is sent with the RSSI LEVEL</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#LinkCount<a id=tele-Wifi-LinkCount></a></td> <td style="text-align: left;">when a teleperiod message is sent with the number of wifi disconnections</td> </tr> <tr> <td style="text-align: left;">Tele-Wifi#Downtime<a id=tele-Wifi-Downtime></a></td> <td style="text-align: left;">when a teleperiod message is sent with the total seconds of wifi disconnections</td> </tr> </tbody> </table> <p>Every <a href=../Commands/ >command</a> with a JSON payload response has an associated rule trigger, with the exception of Power<x>#Data and Switch<x>, which are superseded by by the Power<x>#State and Switch<x>#State trigger.</p> <table> <thead> <tr> <th>Trigger</th> <th>When it occurs</th> </tr> </thead> <tbody> <tr> <td>&lt;command&gt;#Data</td> <td>A one level JSON payload such as <code>{"Command":"value"}</code>. For example, for {"Fanspeed":3}, the trigger is<code>Fanspeed#Data</code>.</td> </tr> <tr> <td>level1#level2#levelN</td> <td>A multi-level JSON payload such as <code>{"TriggerLevel1":{"TriggerLevel2":{"ValueName":"value"}}}</code> does <strong>NOT</strong> have the <code>#Data</code> trigger. Instead, the trigger for these responses is <code>TriggerLevel1#TriggerLevel2#ValueName</code>.</td> </tr> </tbody> </table> <div class="admonition note"> <p class=admonition-title>When the JSON payload response is produced by a command executed by a rule i.e. <code>on time=120 do status 8 endon</code>, the <code>StatusSNS#Data</code> trigger will not fire unless the command is wrapped in <code>backlog</code> i.e. <code>on time=120 do backlog status 8 endon</code></p> </div> <div class="admonition example"> <p class=admonition-title>Example</p> <p>For <code>{"PulseTime2":{"Set":0,"Remaining":0}}</code>, the triggers are <code>PulseTime2#Set</code> and <code>PulseTime2#Remaining</code>.|</p> <p>For a 3 level JSON message such as <code>{"ZbReceived":{"test_switch":{"Device":"0x0C94","Power":1,"Endpoint":8,"LinkQuality":70}}}</code> one possible trigger is <code>ZbReceived#test_switch#Power</code> or another <code>ZbReceived#test_switch#LinkQuality</code> </p> </div> <p>Connected sensors can be a trigger in the form as they are represented in the <code>TelePeriod</code> and <code>Status 8</code> JSON payloads. </p> <table> <thead> <tr> <th>Trigger</th> <th>When it occurs</th> </tr> </thead> <tbody> <tr> <td>DS18B20#Temperature</td> <td>whenever the temperature of sensor DS18B20 updates (also unchanged)</td> </tr> <tr> <td>DS18B20#Temperature&lt;20</td> <td>whenever the temperature of sensor DS18B20 is below 20 degrees</td> </tr> <tr> <td>BME280#Humidity==55.5</td> <td>whenever the humidity of sensor BEM280 equals 55.5%</td> </tr> <tr> <td>INA219#Current&gt;0.100</td> <td>whenever the current drawn is more than 0.1A</td> </tr> <tr> <td>Energy#Power&gt;100</td> <td>whenever the power used is more than 100W</td> </tr> </tbody> </table> <p>When the payload consists of an array of data eg: <code>"ENERGY":{"Current":[1.320,2.100]}</code></p> <table> <thead> <tr> <th>Trigger</th> <th>When it occurs</th> </tr> </thead> <tbody> <tr> <td>Energy#Current[N]</td> <td>N = Number of the field. 1 for the first <code>1.320</code>, 2 for the second <code>2.100</code> etc.</td> </tr> <tr> <td>Energy#Current[1]&gt;1.000</td> <td>whenever the first value of Energy#Current is higher than 1.000.</td> </tr> </tbody> </table> <p>To trigger only at TelePeriod time, prefix the sensor with the word <code>Tele-</code>. </p> <table> <thead> <tr> <th>Trigger</th> <th>When it occurs</th> </tr> </thead> <tbody> <tr> <td>Tele-AM2301#Temperature</td> <td>sensor AM2301 Temperature value when the TelePeriod JSON payload is output</td> </tr> </tbody> </table> <p>Hardware and software serial interface, RF, IR and TuyaMCU are also supported based on their <a href=../JSON-Status-Responses/ >JSON</a> status message: </p> <table> <thead> <tr> <th>Trigger</th> <th>When it occurs</th> </tr> </thead> <tbody> <tr> <td>TuyaReceived#Data=&lt;hex_string&gt;<a id=TuyaReceivedData></a></td> <td>whenever &lt;hex_string&gt; is received with <a href=../TuyaMCU/ >TuyaMCU</a> component</td> </tr> <tr> <td>SerialReceived#Data=&lt;string&gt;<a id=SerialReceivedData></a></td> <td>whenever &lt;string&gt; is received via hardware serial</td> </tr> <tr> <td>SSerialReceived#Data=&lt;string&gt;</td> <td>whenever &lt;string&gt; is received via software serial</td> </tr> <tr> <td>IrReceived#Data=801<a id=IrReceivedData></a></td> <td>whenever an IR signal for a RC5 remote control button 1 is received</td> </tr> <tr> <td>IrReceived#Data=0x00FF9867</td> <td>whenever an IR signal with hex code 0x00FF9867 is received</td> </tr> <tr> <td>RfReceived#RfKey=4<a id=RfReceivedRfKey></a></td> <td>whenever the <a href=../devices/Sonoff-RF-Bridge-433/ >RF Bridge</a> receives a recognized RfKey 4 signal</td> </tr> <tr> <td>RfReceived#Data=0xE8329E<a id=RfReceivedData></a></td> <td>whenever an RF signal with hex code 0xE8329E is received</td> </tr> </tbody> </table> <h3 id=rule-command>Rule Command<a class=headerlink href=#rule-command title="Permanent link">~</a></h3> <p>A rule command can be any command listed in the <a href=../Commands/ >Commands list</a>. The command's <code>&lt;parameter&gt;</code> can be replaced with <code>%value%</code> which will use the value of the trigger, strings are folded to uppercase. </p> <p><code>ON Switch1#State DO Power %value% ENDON</code></p> <p>To accomplish a rule with one trigger but several commands, you need to use <code>Backlog</code>:</p> <p><code>ON &lt;trigger&gt; DO Backlog &lt;command1&gt;; &lt;command2&gt;; &lt;command3&gt; ENDON</code></p> <p><strong>Appending new rule onto an existing rule set</strong><br> Use the <code>+</code> character to append a new rule to the rule set. For example:</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;Existing Rule1: <code>ON Rules#Timer=1 DO Mem2 %time% ENDON</code></p> <p>&nbsp;&nbsp;&nbsp;&nbsp;Rule to append: <code>ON Button1#state DO POWER TOGGLE ENDON</code></p> <p>&nbsp;&nbsp;&nbsp;&nbsp;Command: <code>Rule1 + ON button1#state DO POWER TOGGLE ENDON</code></p> <p>&nbsp;&nbsp;&nbsp;&nbsp;Resulting in <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Mem2</span><span class=w> </span><span class=o>%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>Button1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>POWER</span><span class=w> </span><span class=kt>TOGGLE</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>You can repeate the same trigger in rules. </p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <h3 id=rule-variables>Rule Variables<a class=headerlink href=#rule-variables title="Permanent link">~</a></h3> <p>There are thirty-two (32) available variables (single precision reals) in Tasmota: <code>Var1..Var16</code> and <code>Mem1..Mem16</code>. They provide a means to store the trigger <code>%value%</code> to be used in any rule. <br> All <code>Var</code> will be empty strings when the program starts. The value of all <code>Mem</code> persists after a reboot. </p> <p>The value of a <code>Var&lt;x&gt;</code> and <code>Mem&lt;x&gt;</code> can be: </p> <ul> <li>any number</li> <li>any text</li> <li>%var1% to %var16%</li> <li>%mem1% to %mem16% </li> <li>%color%</li> <li>%deviceid%</li> <li>%macaddr%</li> <li>%power1% to number of power channels</li> <li>%sunrise%</li> <li>%sunset%</li> <li>%switch1% to number of switch gpios</li> <li>%time%</li> <li>%timer1% to %timer16%</li> <li>%timestamp%</li> <li>%topic%</li> <li>%uptime%</li> <li>%utctime%</li> <li>%zbdevice%</li> <li>%zbgroup%</li> <li>%zbcluster%</li> <li>%zbendpoint%</li> </ul> <p>To set the value for <code>Var&lt;x&gt;</code> and <code>Mem&lt;x&gt;</code> use the command </p> <ul> <li><code>Var&lt;x&gt; &lt;value&gt;</code></li> <li><code>Mem&lt;x&gt; &lt;value&gt;</code></li> </ul> <p>The <code>&lt;value&gt;</code> can also be the value of the trigger of the rule. </p> <ul> <li>Set Var2 to the temperature of the AM2301 sensor - <code>ON AM2301#Temperature DO Var2 %value% ENDON</code></li> <li>Set Var4 to Var2's value - <code>ON Event#temp DO Var4 %Var2% ENDON</code></li> <li>Set Mem2 to the current time (minutes elapsed since midnight) - <code>ON Rules#Timer=1 DO Mem2 %time% ENDON</code></li> <li>After a Wi-Fi reconnect event, publish a payload containing timestamps of when Wi-Fi was disconnected in <em>From:</em> and when Wi-Fi re-connected in <em>To:</em> to <code>stat/topic/BLACKOUT</code>.</li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>wifi</span><span class=o>#</span><span class=n>disconnected</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=o>%</span><span class=n>timestamp</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>wifi</span><span class=o>#</span><span class=n>connected</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var2</span><span class=w> </span><span class=o>%</span><span class=n>timestamp</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>mqtt</span><span class=o>#</span><span class=n>connected</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>topic</span><span class=o>/</span><span class=kt>BLACKOUT</span><span class=w> </span><span class=p>{</span><span class=s>&quot;From&quot;</span><span class=kt>:</span><span class=s>&quot;%Var1%&quot;</span><span class=p>,</span><span class=s>&quot;To&quot;</span><span class=kt>:</span><span class=s>&quot;%Var2%&quot;</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>To see the values of used <code>Var&lt;x&gt;</code> and <code>Mem&lt;x&gt;</code> at the WebUI, add <code>#define USE_VIEW_RULE_MEMS_AND_VARS</code> to your <code>user_config_override.h</code> and <a href=../Compile-your-build/ >recompile</a>.</p> </div> <h4 id=delete-rule>Delete rule<a class=headerlink href=#delete-rule title="Permanent link">~</a></h4> <p>To <a href=../Commands/#rule>clear / delete</a> use double quote(s):</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=s>&quot;</span>
</code></pre></div> <h2 id=conditional-rules>Conditional Rules<a class=headerlink href=#conditional-rules title="Permanent link">~</a></h2> <div class="admonition note"> <p class=admonition-title>Note</p> <p>This feature is now included in ESP32 builds as well as in ESP8266 builds since v13.3.0.4.</p> </div> <hr> <h4 id=major-features>Major features<a class=headerlink href=#major-features title="Permanent link">~</a></h4> <ul> <li>Support IF, ELSEIF, ELSE </li> <li>Support for <code>&lt;comparison&gt;</code> and <code>&lt;logical expression&gt;</code> as condition </li> <li>Support for executing multiple commands </li> <li>Available free RAM is the only limit for logical operators and parenthesis. </li> </ul> <h4 id=grammar>Grammar<a class=headerlink href=#grammar title="Permanent link">~</a></h4> <p><code>&lt;if-statement&gt;</code> </p> <ul> <li><code>IF (&lt;logical-expression&gt;) &lt;statement-list&gt; {ELSEIF (&lt;logical-expression&gt;) &lt;statement-list&gt;} [ELSE &lt;statement-list&gt;] ENDIF</code> </li> </ul> <p><code>(&lt;logical-expression&gt;)</code><br> Parentheses must enclose the expression. They can also be used to explicitly control the order of evaluation. </p> <ul> <li><code>&lt;comparison-expression&gt;</code> </li> <li><code>(</code> <code>&lt;comparison-expression&gt;</code> | <code>&lt;logical-expression&gt;</code> <code>)</code> {{<code>AND</code> | <code>OR</code>} <code>&lt;logical-expression&gt;</code>} </li> <li><code>(</code> <code>&lt;logical-expression&gt;</code> <code>)</code> {<code>AND</code> | <code>OR</code>} <code>&lt;logical expression&gt;</code>} </li> </ul> <p><code>&lt;comparison-expression&gt;</code> </p> <ul> <li><code>&lt;expression&gt;</code> {<code>=</code> | <code>&lt;</code> | <code>&gt;</code> | <code>|</code> | <code>==</code> | <code>&lt;=</code> | <code>&gt;=</code> | <code>!=</code>} <code>&lt;expression&gt;</code> </li> </ul> <p><code>&lt;statement-list&gt;</code> </p> <ul> <li><code>&lt;statement&gt;</code> {<code>;</code> <code>&lt;statement&gt;</code>} </li> </ul> <p><code>&lt;statement&gt;</code> </p> <ul> <li>{<code>&lt;Tasmota-command&gt;</code> | <code>&lt;if-statement&gt;</code>} </li> </ul> <h4 id=syntax>Syntax<a class=headerlink href=#syntax title="Permanent link">~</a></h4> <p>IF statement supports 3 formats: </p> <ul> <li><code>IF (&lt;logical-expression&gt;) &lt;statement-list&gt; ENDIF</code> </li> <li><code>IF (&lt;logical-expression&gt;) &lt;statement-list&gt; ELSE &lt;statement-list&gt; ENDIF</code> </li> <li><code>IF (&lt;logical-expression&gt;) &lt;statement-list&gt; [ELSEIF (&lt;logical-expression&gt;) &lt;statement-list&gt; ] ELSE &lt;statement-list&gt; ENDIF</code> </li> </ul> <p>When the <code>&lt;if-statement&gt;</code> directly follows the trigger the standard 'Do' syntax applies, however, it is not necessary to use 'Backlog' within the chain <code>Rule1 ON Power1#State DO IF (%value%==1) Backlog Power2 1;Power3 1 ENDIF ENDON</code> is <strong>permitted</strong> <code>Rule1 ON Power1#State DO IF (%value%==1) Power2 1;Power3 1 ENDIF ENDON</code> is also <strong>permitted</strong></p> <p>When the <code>&lt;if-statement&gt;</code> is preceded by other Tasmota commands you should use <code>Backlog</code> along with <code>Do</code> , e.g.<br> <code>Rule1 ON ENERGY#Current&gt;10 DO Backlog Power1 0; IF (%var1%==1) Power1 1 ENDIF;Power 2 0;Power3 1 ENDON</code> <strong>and not</strong> <code>Rule1 ON ENERGY#Current&gt;10 DO Power1 0; IF (%var1%==1) Power1 1 ENDIF ENDON</code> <strong>or</strong> <code>Rule1 ON ENERGY#Current&gt;10 Backlog Power1 0; IF (%var1%==1) Power1 1 ENDIF ENDON</code></p> <p><code>(&lt;logical-expression&gt;)</code> example: <code>(VAR1&gt;=10)</code><br> - Multiple comparison expressions with logical operator <code>AND</code> or <code>OR</code> between them. <code>AND</code> has higher priority than <code>OR</code>. For example:<br> <code>((UPTIME&gt;100) AND (MEM1==1) OR (MEM2==1))</code><br> - Parenthesis can be used to change the priority of the logical expression evaluation. For example:<br> <code>((UPTIME&gt;100) AND ((MEM1==1) OR (MEM2==1)))</code> </p> <ul> <li>Following variables can be used in <code>&lt;condition&gt;</code>: </li> </ul> <table> <thead> <tr> <th>Symbol</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>VAR&lt;x&gt;</td> <td>variable (&lt;x&gt; = <code>1..MAX_RULE_VARS</code>, e.g., <code>VAR2</code>)</td> </tr> <tr> <td>MEM&lt;x&gt;</td> <td>persistent variable (&lt;x&gt; = <code>1..MAX_RULE_MEMS</code>, e.g., <code>MEM3</code>)</td> </tr> <tr> <td>TIME</td> <td>minutes past midnight</td> </tr> <tr> <td>UPTIME</td> <td>uptime minutes</td> </tr> <tr> <td>UTCTIME</td> <td>UTC time, UNIX timestamp, seconds since 01/01/1970</td> </tr> <tr> <td>LOCALTIME</td> <td>local time, UNIX timestamp</td> </tr> <tr> <td>SUNRISE</td> <td>current sunrise time (minutes past midnight)</td> </tr> <tr> <td>SUNSET</td> <td>current sunset time (minutes past midnight)</td> </tr> <tr> <td>COLOR</td> <td>current color</td> </tr> </tbody> </table> <p><code>&lt;statement-list&gt;</code><br> - A Tasmota command (e.g.,<code>LedPower on</code>)<br> - Another IF statement (<code>IF ... ENDIF</code>)<br> - Multiple Tasmota commands or IF statements separated by <code>;</code>. For example:<br> <code>Power1 off; LedPower on; IF (Mem1==0) Var1 Var1+1; Mem1 1 ENDIF; Delay 10; Power1 on</code><br> <code>Backlog</code> is implied and is not required (saves rule set buffer space). </p> <p>But not like this: <code>Power1 off; LedPower on; IF (Mem1==0) Var1 Var1+1; Mem1 1 ENDIF; Delay 10; Power1 on</code></p> <p>You should split it in two lines like: <code>ON Power2#state=1 DO Power1 off; LedPower on; ENDON</code> <code>ON Power2#state=1 DO IF (Mem1==0) Var1 Var1+1; Mem1 1 ENDIF; Delay 10; Power1 on ENDON</code></p> <div class="admonition example"> <p class=admonition-title>Example</p> <p>Rule used to control pressure cooker with a Sonoff S31. Once it is finished cooking, wait for 10 minutes and then shut off the power.</p> </div> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>energy</span><span class=o>#</span><span class=n>power</span><span class=o>&gt;</span><span class=mi>100</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=o>!=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>endif</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>energy</span><span class=o>#</span><span class=n>power</span><span class=o>&lt;</span><span class=mi>100</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>600</span><span class=w> </span><span class=n>endif</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>rules</span><span class=o>#</span><span class=n>timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>power</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span><span class=w>  </span>
</code></pre></div> <h2 id=expressions-in-rules>Expressions in Rules<a class=headerlink href=#expressions-in-rules title="Permanent link">~</a></h2> <div class="admonition note"> <p class=admonition-title>Note</p> <p>This feature is now included in ESP32 builds as well as in ESP8266 builds since v13.3.0.4.</p> </div> <hr> <p>Beginning with Tasmota version 6.4.1.14, an optional feature for using mathematical expressions in rules was introduced. </p> <h4 id=supported-commands>Supported Commands<a class=headerlink href=#supported-commands title="Permanent link">~</a></h4> <p>Once the feature is enabled, the use of expressions is supported in the following commands:</p> <ul> <li>Var</li> <li>Mem</li> <li>RuleTimer</li> <li><a href=#conditional-rules>If conditional statement</a> (requires <code>#define SUPPORT_IF_STATEMENT</code>)</li> </ul> <h4 id=syntax_1>Syntax<a class=headerlink href=#syntax_1 title="Permanent link">~</a></h4> <p>Expressions can use of the following operators. They are listed by the order of operations priority, from higher to lower.</p> <ul> <li><code>( )</code> (parentheses can be used to explicitly control the order of operations)</li> <li><code>^</code> (power)</li> <li><code>%</code> (modulo, division by zero returns modulo "0")</li> <li><code>*</code> and <code>/</code> (multiplication and division; division by zero returns "0")</li> <li><code>+</code> and <code>-</code> (addition and subtraction)</li> </ul> <div class="admonition example"> <p class=admonition-title>Example</p> <ul> <li><code>1+2*2</code> results in 5.0 as the multiplication is done first due to its higher priority</li> <li><code>(1+2)*2</code> results in 6.0</li> </ul> </div> <p>In addition to numeric constants, the following symbolic values can be used: </p> <table> <thead> <tr> <th>Symbol</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>VAR&lt;x&gt;</td> <td>variable (&lt;x&gt; = <code>1..MAX_RULE_VARS</code>, e.g., <code>VAR2</code>)</td> </tr> <tr> <td>MEM&lt;x&gt;</td> <td>persistent variable (&lt;x&gt; = <code>1..MAX_RULE_MEMS</code>, e.g., <code>MEM3</code>)</td> </tr> <tr> <td>TIME</td> <td>minutes past midnight</td> </tr> <tr> <td>UPTIME</td> <td>uptime minutes</td> </tr> <tr> <td>UTCTIME</td> <td>UTC time, UNIX timestamp, seconds since 01/01/1970</td> </tr> <tr> <td>LOCALTIME</td> <td>local time, UNIX timestamp</td> </tr> <tr> <td>SUNRISE</td> <td>current sunrise time (minutes past midnight)</td> </tr> <tr> <td>SUNSET</td> <td>current sunset time (minutes past midnight)</td> </tr> <tr> <td>COLOR</td> <td>current color</td> </tr> </tbody> </table> <div class="admonition example"> <p class=admonition-title>Example</p> <p><code>Mem1=((0.5*Var1)+10)*0.7</code></p> </div> <p>To use expressions in the <code>Var</code>, <code>Mem</code> and <code>RuleTimer</code> commands, an equal sign (<code>=</code>) character has to be used after the command. If not, the traditional syntax interpretation is used. </p> <table> <thead> <tr> <th>Statement</th> <th>Var1 Result</th> </tr> </thead> <tbody> <tr> <td><code>Var1=42</code></td> <td>42</td> </tr> <tr> <td><code>Var1 1+1</code></td> <td>"1+1" (the literal string)</td> </tr> <tr> <td><code>Var1=1+1</code></td> <td>2</td> </tr> <tr> <td><code>Var1=sunset-sunrise</code></td> <td>duration of daylight in minutes</td> </tr> </tbody> </table> <h2 id=rule-cookbook>Rule Cookbook<a class=headerlink href=#rule-cookbook title="Permanent link">~</a></h2> <h3 id=long-press-on-a-switch>Long press on a switch<a class=headerlink href=#long-press-on-a-switch title="Permanent link">~</a></h3> <div class="admonition note"> <p class=admonition-title>This example is for GPIOs defined as switches not buttons</p> </div> <p>Activate long press action with <code>Switchmode 5</code> and shorten long press time to 2 seconds (<code>Setoption32 20</code>).</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchMode</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span>
<span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>tasmota02</span><span class=o>/</span><span class=kt>POWER</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Long pressing on switch1 sends <code>POWER 2</code> (toggle action) command to the <code>tasmota02</code> device</p> <p>Notice we use <code>Rule</code> which edits <code>Rule1</code> rule set. They can be used interchangeably. If your rule does not trigger there could some constraints, in this case if SwitchTopic has a value it will override rules for switches and will need to be disabled: <code>SwitchTopic 0</code>.</p> <hr> <h3 id=send-mqtt-message-on-button-press>Send MQTT message on button press<a class=headerlink href=#send-mqtt-message-on-button-press title="Permanent link">~</a></h3> <p>When a button is pressed the user has the possibility to send a MQTT message based on FullTopic and ButtonTopic. This MQTT message is going to be received by the MQTT broker and if there is any other device(s) subscribed to that Topic, it will receive also that message. So this approach can be used for sending messages/commands to MQTT Broker to Home Automation System, and/or sending messages/commands to MQTT Broker to other device(s).</p> <p>A problem with this solution is that on a Sonoff 4CH all four buttons will be sending the same MQTT topic using only a different Power index number like <code>cmnd/ButtonTopic/Power3 toggle</code>.</p> <p>By using a rule a single button can send any MQTT message allowing for more flexibility.</p> <p>Disable ButtonTopic as it overrides rules for buttons: <code>ButtonTopic 0</code></p> <h4 id=rule>Rule<a class=headerlink href=#rule title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>ring2</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button2</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>strip1</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>You will need to enable this rule if it's the first time you've used rule with <code>Rule1 1</code></p> <h4 id=result>Result<a class=headerlink href=#result title="Permanent link">~</a></h4> <p>When Button1 is pressed the rule kicks in and sends a MQTT message substituting variable <code>%value%</code> with the button state, f.e <code>cmnd/ring2/Power 2</code>. When Button2 is pressed an MQTT message <code>cmnd/strip1/Power 2</code> will be sent.</p> <hr> <h3 id=usage-of-one-shot-once>Usage of one-shot (once)<a class=headerlink href=#usage-of-one-shot-once title="Permanent link">~</a></h3> <p>The rule command once option provides the possibility to trigger only once ON a slow change while the change is still within the bounds of the test.</p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Current</span><span class=o>&gt;</span><span class=mf>0.100</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>tool</span><span class=o>/</span><span class=n>tablesaw</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Current</span><span class=o>&lt;</span><span class=mf>0.100</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>tool</span><span class=o>/</span><span class=n>tablesaw</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>This creates a rule to publish MQTT commands whenever a Sonoff POW has current passing through it. Used as is, it will publish MQTT commands repeatedly, over and over, while current is &gt;0.100 ... but, executing another command:</p> <p><code>Rule 5</code></p> <p>Now the MQTT message will be sent once, and only once, while the condition is met. This is perfect for thermostat on/off depending on temperature, bathroom extractor fan on/off depending on humidity, workshop dust collector on/off depending on whether some dust-producing machine is running.</p> <p>It meets the 'hard thermostat' requests that have been common.</p> <h3 id=use-a-potentiometer>Use a potentiometer<a class=headerlink href=#use-a-potentiometer title="Permanent link">~</a></h3> <p>Connecting a potentiometer to the Analog A0 input and a rule can be used to control the dimmer state of any device.</p> <p>Hardware - Wemos D1 mini - Potentiometer of 2k2 connected to Gnd, A0 and 3V3 - WS2812 LED</p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>analog</span><span class=o>#</span><span class=n>a0div10</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <h4 id=result_1>Result<a class=headerlink href=#result_1 title="Permanent link">~</a></h4> <p>Turning the potentiometer the voltage on the analog input will change resulting in a value change of 0 (Off) to 100 for the trigger. Using this value to control the dimmer of the WS2812 will control the brightness of the led(s)</p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>analog</span><span class=o>#</span><span class=n>a0div10</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>grouplight</span><span class=o>/</span><span class=n>dimmer</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Result This time all lights configured with GroupTopic <code>grouplight</code> will change their brightness according to the potentiometer position.</p> <p>NOTE: You might want to execute command <code>SaveData 2</code> to reduce flash writes ;-)</p> <h3 id=use-a-rotary-encoder>Use a rotary encoder<a class=headerlink href=#use-a-rotary-encoder title="Permanent link">~</a></h3> <p>You can capture in rules the value of a rotary encoder connected to 2 GPIOs configured as <code>Rotary_a|&lt;n&gt;</code> and <code>Rotary_b|&lt;n&gt;</code>. Optionally the button of the rotary encoder can be connected to another GPIO configured as <code>Button|&lt;n&gt;</code>. <code>&lt;n&gt;</code> must be the same to allow the encoder to manage 2 absolute counters from the same rotary encoder.</p> <p>To get triggers from the rotary encoder into rules, you must enable <a href=../Commands/#setoption98><code>SetOption98 1</code></a>. The rotary encoder <code>&lt;n&gt;</code> provides a JSON in the form of <code>{'Rotary&lt;n&gt;': {'Pos1': value, 'Pos2': value}}</code>. You can use the following rules triggers:</p> <div class=highlight><pre><span></span><code><span class=kt>SetOption98</span><span class=w> </span><span class=mi>1</span>
<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rotary1</span><span class=o>#</span><span class=kt>Pos1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>something_with</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rotary1</span><span class=o>#</span><span class=kt>Pos2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>something_with</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <h4 id=result_2>Result<a class=headerlink href=#result_2 title="Permanent link">~</a></h4> <p><code>Pos1</code> is changed when the rotary encoder is turned while button is not pressed. <code>Pos2</code> is changed while button is pressed. Both <code>Pos1</code> and <code>Pos2</code> are published whatever is the button position, so both trig at the same time.</p> <p>The button will still have its default action (such as toggling power). If you want to avoid that, you need to capture the button into a dummy rule such as <code>ON Button1#state DO Delay 0 ENDON</code>.</p> <p>The step range of the rotary encoder can be selected using <a href=../Commands/#setoption43><code>SetOption43</code></a>, and the default is hardcoded in <code>#define ROTARY_MAX_STEPS 10</code>. To change the default range, set it in your <code>user_config_override.h</code> and <a href=../Compile-your-build/ >recompile</a>.</p> <hr> <h3 id=use-zigbee-to-control-tasmota-devices>Use Zigbee to control Tasmota devices<a class=headerlink href=#use-zigbee-to-control-tasmota-devices title="Permanent link">~</a></h3> <p>This setup uses a <a href=../Zigbee/ >Zigbee</a> gateway with an <a href=https://zigbee.blakadder.com/Ikea_E1743.html>Ikea remote switch</a> paired. </p> <p>Ikea switch's name was set with <code>ZbName</code> to make it more user friendly.</p> <h4 id=rule_1>Rule<a class=headerlink href=#rule_1 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>zbreceived</span><span class=o>#</span><span class=n>ikea_switch</span><span class=o>#</span><span class=n>power</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>backyard</span><span class=o>/</span><span class=kt>POWER</span><span class=w> </span><span class=kt>TOGGLE</span><span class=w> </span><span class=n>endon</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>zbreceived</span><span class=o>#</span><span class=n>ikea_switch</span><span class=o>#</span><span class=n>power</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>hall_light</span><span class=o>/</span><span class=kt>POWER</span><span class=w> </span><span class=kt>TOGGLE</span><span class=w> </span><span class=n>endon</span>
</code></pre></div> <h4 id=result_3>Result<a class=headerlink href=#result_3 title="Permanent link">~</a></h4> <p>Pressing <code>I</code> on the Ikea switch will toggle <code>backyard</code> device and pressing <code>O</code> toggles <code>hall_light</code> device.</p> <hr> <h3 id=button-single-press-double-press-and-hold>Button single press, double press and hold<a class=headerlink href=#button-single-press-double-press-and-hold title="Permanent link">~</a></h3> <p>This example show how to assign different behavior to a button <strong>other than Button1</strong>. Button1 has special multi-press behaviors associated with it (see <em>Note</em> in <a href=../Buttons-and-Switches/#multi-press-functions>Multi-Press Functions</a>), examples 1 and 2 cannot be applied to Button1.</p> <h4 id=1st-example>1st example:<a class=headerlink href=#1st-example title="Permanent link">~</a></h4> <p><em>[assuming Button2 (or &gt;2) and Setoption73 0]</em></p> <ul> <li>single press: Toggle Power2 <em>(or &gt;2)</em></li> <li>double press: send a mqtt message </li> <li>hold 2 secs: send a different mqtt message</li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>ButtonTopic</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption11</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span>
<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>topicHOLD</span><span class=o>/</span><span class=n>power2</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>topicDOUBLEPRESS</span><span class=o>/</span><span class=n>power2</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <h4 id=2nd-example-with-setoption11-1>2nd example with <code>Setoption11 1</code>:<a class=headerlink href=#2nd-example-with-setoption11-1 title="Permanent link">~</a></h4> <p><em>[assuming Button2 (or &gt;2) and Setoption73 0]</em></p> <ul> <li>single press: send MQTT message</li> <li>double press: Toggle Power2 <em>(or &gt;2)</em> (SetOption11 swaps single and double press)</li> <li>hold 2 secs: send another mqtt message </li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>ButtonTopic</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption11</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span><span class=w>  </span>
<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>topicHOLD</span><span class=o>/</span><span class=n>power2</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>topicSINGLEPRESS</span><span class=o>/</span><span class=n>power2</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <h4 id=3rd-example-for-button1>3rd example for Button1:<a class=headerlink href=#3rd-example-for-button1 title="Permanent link">~</a></h4> <p>For assigning different actions to multi-press on Button1, it is mandatory to detach buttons from their default function using <code>SetOption73 1</code>. With <code>SetOption73 1</code> buttons only publish a MQTT message (<code>stat/tasmota/BUTTON&lt;x&gt; = {"ACTION":"xxxx"}</code>). To re-assign a specific action, rules must be used like below:</p> <ul> <li>single press: Toggle Power1</li> <li>double press: send a mqtt message </li> <li>hold 2 secs: send a different mqtt message</li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>ButtonTopic</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span><span class=kt>SetOption73</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span>
<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>10</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>topicHOLD</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>11</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>topicDOUBLEPRESS</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p><code>SetOption73 1</code> detaches ALL buttons. If you have more than 1 button, you must create rules for each buttons where you want an action (other than publishing <code>stat/tasmota/BUTTON&lt;x&gt; = {"ACTION":"xxxx"}</code>)</p> </div> <hr> <h3 id=disable-switch-single-press-and-use-long-press>Disable switch single press and use long press<a class=headerlink href=#disable-switch-single-press-and-use-long-press title="Permanent link">~</a></h3> <p><code>SetOption11 0</code> </p> <p><strong>Switches do not have double press feature</strong> </p> <p><em>[assuming a connected pushbutton configured as Switch1]</em></p> <ul> <li>single press: Does nothing (empty <code>Delay</code> commands) </li> <li>hold 2 secs: Toggle Power1</li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchTopic1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode1</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span><span class=w>  </span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Delay</span><span class=w> </span><span class=kt>ENDON</span><span class=w>  </span>
</code></pre></div> <p><code>Rule1 1</code></p> <hr> <h3 id=execute-several-commands-when-a-timer-expires>Execute several commands when a Timer expires<a class=headerlink href=#execute-several-commands-when-a-timer-expires title="Permanent link">~</a></h3> <p>The default Timer1..16 functionality allows for controlling one output to either off, on, toggle or blink. When rules are enabled the blink option will be replaced by rule functionality allowing much more flexibility.</p> <p>Configure timer5 for rule execution when activated: </p> <div class=highlight><pre><span></span><code><span class=kt>Timer5</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;16:00&quot;</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>3</span><span class=p>}</span>
</code></pre></div> <h4 id=rule_2>Rule<a class=headerlink href=#rule_2 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>clock</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>5</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Power2</span><span class=w> </span><span class=n>on</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>off</span><span class=p>;</span><span class=w> </span><span class=kt>Power3</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <h4 id=result_4>Result<a class=headerlink href=#result_4 title="Permanent link">~</a></h4> <p>When the timer expires the rule kicks in and set Power1 to OFF, Power2 to ON and Power3 TOGGLE.</p> <p>If you want to have blink functionality define a rule like <code>ON clock#Timer=5 DO power 3 ENDON</code></p> <hr> <h3 id=setting-variables>Setting variables<a class=headerlink href=#setting-variables title="Permanent link">~</a></h3> <p>Demonstrate the use of variables. Make sure to execute commands <code>Rule 4</code>(Disable one-shot detection) first when trying the following example.</p> <p>Set a variable</p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>setvar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Command: <code>event setvar1=1</code></p> <p>View a variable <div class=highlight><pre><span></span><code><span class=nf>rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>getvar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>Command: <code>event getvar1</code></p> <ul> <li>Toggle a variable</li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Rule</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>togglevar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>toggling1</span><span class=o>=%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=o>&lt;</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>setvar1</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=o>&gt;</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>setvar1</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>setvar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Command: <code>event togglevar1</code></p> <p>Show Messages:</p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>message</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=p>[</span><span class=n>topic</span><span class=p>]</span><span class=o>/</span><span class=n>log</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Command: <code>event message=INIT</code></p> <p>All event commands can be executed from:</p> <ul> <li>console: <code>event anyname=number</code></li> <li>mqtt: <code>cmnd/[topic]/event anyname=number</code></li> </ul> <p>Everything together: </p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>togglevar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>toggling1</span><span class=o>=%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=o>&lt;</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>setvar1</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=o>&gt;</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>setvar1</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>setvar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>getvar1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>message</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>mqttTopic</span><span class=o>/</span><span class=n>log</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>The following won't work:</p> <p><code>Rule1 ON event#setvar1 DO Backlog var1 %value%; Power1 %var1% ENDON</code></p> <p>At least not as you probably would expect. The <code>var1</code> value used by the <code>Power1</code> command will be the value present before the <code>Backlog</code> command is executed. This is so, because the rule will replace <code>%var1%</code> BEFORE the <code>Backlog</code> commands are put in the <code>Backlog</code> command stream.</p> </div> <hr> <!-- ### Control device LEDs with Relays
If a device has more than one relay and LEDs ON different GPIOs (not connected to the relay) you need to use rules to display current relay status on LEDs. This example is a 3 gang wall switch. Instead of LEDs you need to assign 3 dummy relays that will be controlled when the real relays are switched to reflect their status.

<div class="highlight"><pre><span></span><code><span class="kt">Backlog</span><span class="w"> </span><span class="kt">LedMask</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">;</span><span class="w"> </span><span class="n">setoption13</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">seriallog</span><span class="w"> </span><span class="mi">0</span>

<span class="kt">Rule1</span><span class="w"> </span>
<span class="w">  </span><span class="kt">ON</span><span class="w"> </span><span class="kt">Power1</span><span class="o">#</span><span class="n">state</span><span class="w"> </span><span class="kt">DO</span><span class="w"> </span><span class="kt">Power4</span><span class="w"> </span><span class="o">%</span><span class="n">value</span><span class="o">%</span><span class="w"> </span><span class="kt">ENDON</span><span class="w"> </span>
<span class="w">  </span><span class="kt">ON</span><span class="w"> </span><span class="kt">Power2</span><span class="o">#</span><span class="n">state</span><span class="w"> </span><span class="kt">DO</span><span class="w"> </span><span class="kt">Power5</span><span class="w"> </span><span class="o">%</span><span class="n">value</span><span class="o">%</span><span class="w"> </span><span class="kt">ENDON</span><span class="w"> </span>
<span class="w">  </span><span class="kt">ON</span><span class="w"> </span><span class="kt">Power3</span><span class="o">#</span><span class="n">state</span><span class="w"> </span><span class="kt">DO</span><span class="w"> </span><span class="kt">Power6</span><span class="w"> </span><span class="o">%</span><span class="n">value</span><span class="o">%</span><span class="w"> </span><span class="kt">ENDON</span>

<span class="kt">Rule1</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
Note: This method doubles the number of flash writes. [Link to the device](https://templates.blakadder.com/DS-102_3.html)


------------------------------------------------------------------------------ --> <h3 id=time-delayed-auto-off-switch>Time-delayed Auto-off Switch<a class=headerlink href=#time-delayed-auto-off-switch title="Permanent link">~</a></h3> <h4 id=rule_3>Rule<a class=headerlink href=#rule_3 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>600</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <h4 id=result_5>Result<a class=headerlink href=#result_5 title="Permanent link">~</a></h4> <p><code>on button1#state do Backlog Power1 %value%;</code><br> On Button press the Light will toggle on/off </p> <p><code>RuleTimer1 600 ENDON</code><br> Additionally RuleTimer1 will begin to countdown 10 minutes </p> <p><code>ON Rules#Timer=1 DO Power1 off ENDON</code><br> After the RuleTimer1 expires the light will be turned off (if you forgot to turn it off) </p> <hr> <h3 id=time-delay-after-switch-off>Time-delay After Switch Off<a class=headerlink href=#time-delay-after-switch-off title="Permanent link">~</a></h3> <h4 id=rule_4>Rule<a class=headerlink href=#rule_4 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=n>switchmode1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>on</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>300</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>rules</span><span class=o>#</span><span class=n>timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <h4 id=result_6>Result<a class=headerlink href=#result_6 title="Permanent link">~</a></h4> <p><code>ruletimer1 300</code> sets a 5 minute timer. After that time, fan will be switched off. If during the defined 5 minutes (or in general - when timer is counting) you the switch on, the timer will be canceled.</p> <p><code>switchmode1 1</code> sets the switch in follow mode (LOW=off, HIGH=on)<br> If you have inverted switch (LOW=on, HIGH=off) then use <code>switchmode1 2</code> </p> <hr> <h3 id=auto-off-motion-sense-switch>Auto-off Motion Sense Switch<a class=headerlink href=#auto-off-motion-sense-switch title="Permanent link">~</a></h3> <p>Example works fine on a Wemos D1 Mini. Used as night light with motion sensor or as ambient light on floor or kitchen.</p> <p>Connect an LED Strip WS2812 on D1 and the PIR on D2 and a LDR on A0 (voltage divider with 10k ohm resistor)</p> <p><code>SwitchMode1 1</code></p> <h4 id=rule_5>Rule<a class=headerlink href=#rule_5 title="Permanent link">~</a></h4> <p><div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>analog</span><span class=o>#</span><span class=n>a0</span><span class=o>&lt;</span><span class=mi>400</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Rule3</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>analog</span><span class=o>#</span><span class=n>a0</span><span class=o>&gt;</span><span class=mi>500</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule3</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule2</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <div class=highlight><pre><span></span><code><span class=kt>Rule3</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Activate Rule1 with one shot detection<br> <code>Backlog Rule1 1; Rule1 6</code> </p> <p>Optional<br> <code>Backlog Rule2 4; Rule3 4</code> </p> <h4 id=result_7>Result<a class=headerlink href=#result_7 title="Permanent link">~</a></h4> <p><code>on analog#a0&gt;400</code><br> disable Rule3 and activate Rule2</p> <p><code>on analog#a0&gt;500</code><br> disable Rule2 and activate Rule3</p> <p>Rule2 activates the LEDs for RuleTimer1 30 seconds on each trigger from PIR the RuleTimer start again. </p> <p><code>on Rules#Timer=1 do Power1 off</code><br> The LEDs turn off after the RuleTimer expires </p> <p>Rule3 is active on daylight and pipe the PIR signal in a Power1 off signal. The LEDs stay off. </p> <hr> <h3 id=auto-off-if-or-when-current-is-idle>Auto-off if or when current is idle<a class=headerlink href=#auto-off-if-or-when-current-is-idle title="Permanent link">~</a></h3> <p>The example is used on a Sonoff POWR316D.</p> <p>It assumes an idle current of less than 0.1 amps and a grace period of 10 minutes to get consumption above the idle level.</p> <p>If the consumer uses less than 0.1 amps for more than 10 minutes, then it will be turned off.</p> <p>This works with either manually turning on power, using a timer or whatever.</p> <h4 id=rule_6>Rule<a class=headerlink href=#rule_6 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Current</span><span class=o>==</span><span class=mf>0.0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=o>!=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>endif</span><span class=w> </span><span class=kt>BREAK</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Current</span><span class=o>&gt;=</span><span class=mf>0.1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=o>!=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>endif</span><span class=w> </span><span class=kt>BREAK</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Current</span><span class=o>&lt;</span><span class=mf>0.1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kr>if</span><span class=w> </span><span class=p>(</span><span class=n>var1</span><span class=o>!=</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>600</span><span class=p>;</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>endif</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=control-timers-from-a-switch>Control Timers from a Switch<a class=headerlink href=#control-timers-from-a-switch title="Permanent link">~</a></h3> <p>Assuming that your switch is on <code>GPIO00</code> and configured as <code>Switch1</code>:</p> <p><a href=../Commands/#switchmode><code>Switchmode1 1</code></a> will make Switch1#state be 1 when ON and 0 when OFF</p> <p>If you don't set <code>Switchmode1</code> or it is equal 0, it will only have <code>Switch1#state=2</code> (toggle) and the rule will not work.</p> <h4 id=rule_7>Rule<a class=headerlink href=#rule_7 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Timers</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Timers</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=toggle-relay-when-holding-button-for-2-seconds>Toggle Relay when holding button for 2 seconds<a class=headerlink href=#toggle-relay-when-holding-button-for-2-seconds title="Permanent link">~</a></h3> <p>The following example is to explain how to catch and use the HOLD feature for buttons.</p> <p>Behavior: Disable Button1 Short Press and Toggle Relay1 only when holding button1 for 2 Seconds.</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>ButtonTopic</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span>
</code></pre></div> <p><div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>button1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div></p> <p><strong>Commands Explanation</strong></p> <p><code>ButtonTopic 0</code> : (default) To not use topics for buttons<br> <code>SetOption1 1</code> : Allow only single, double and hold press button actions<br> <code>SetOption32 20</code> : Set key hold time from 0.1 to 10 seconds (20 = 2 seconds)<br> <code>Rule ON button1#state=3 DO Power1 2 ENDON</code> : When holding the button1 for 2 seconds it will toggle relay 1 (state = 3 means HOLD)<br> <code>ON button1#state=2 DO delay ENDON</code> : Do nothing when short pressing the button1 (state = 2 means TOGGLE)<br> <code>Rule1 1</code> : To enable rules </p> <p>NOTE: There is no state value for "double press" for Buttons. It is designed that double press will toggle the relay. See <a href=../Buttons-and-Switches/#multi-press-functions>Multi-Press Functions</a> for more information.</p> <p>In the case you do not want the double press feature you can configure your button as switch and also set <code>SwitchMode</code> that fits your use case (such as <code>SwitchMode 5</code> to make the switch behave like a pushbutton) [SWITCH does not support double press] </p> <p><strong>Another example but using switch instead of button:</strong></p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchTopic1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode1</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>20</span>

<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <hr> <h3 id=make-sure-light-is-on-at-night>Make sure Light is on at night<a class=headerlink href=#make-sure-light-is-on-at-night title="Permanent link">~</a></h3> <p>Using Timers, you can set a light to turn on and off to illuminate a street/patio by night. But if the device has no power at the trigger time, then, when it powers up, the light will be off all night. So, as a fail-safe, implement a conditional control to be checked at Tasmota Startup.</p> <p>Set Timers to turn on your light at Sunset and Turn off at sunrise. Use <code>poweronstate 0</code> in order to start with lights off when powering up your device. Set the following rules:</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Initialized</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checksunrise</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checksunset</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checksunset</span><span class=o>&gt;%</span><span class=n>sunset</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checksunrise</span><span class=o>&lt;%</span><span class=n>sunrise</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>The previous rules are conditionals that represent the following logic:</p> <p>IF %time%&gt;%sunset DO Power1 1 / IF %time%&lt;%sunrise DO Power1 1</p> <hr> <h3 id=turn-on-light-before-dawn-and-at-dusk>Turn On Light Before Dawn and At Dusk<a class=headerlink href=#turn-on-light-before-dawn-and-at-dusk title="Permanent link">~</a></h3> <p>Turn on light at dusk until your nighttime and again in the morning before dawn.<br> <em>(memory variable method)</em></p> <p>What if the sun sets after your nighttime, as in during the summer? Then the timer will turn off the light at "night", but then the Sunset timer will turn it on again, so it stays on all night. </p> <h4 id=rule_8>Rule<a class=headerlink href=#rule_8 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Initialized</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSun</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>=%</span><span class=n>sunset</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSun</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>=%</span><span class=n>mem2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSun</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>=%</span><span class=n>sunrise</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSun</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>=%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSun</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule2</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>chkSun</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSunrise</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkSunset</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chkmorn</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>chknight</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>setPower</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>chkSunrise</span><span class=o>&lt;%</span><span class=n>sunrise</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>chkSunset</span><span class=o>&gt;=%</span><span class=n>sunset</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>chkmorn</span><span class=o>&lt;%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>chknight</span><span class=o>&gt;=%</span><span class=n>mem2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>setPower</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>360</span><span class=p>;</span><span class=w> </span><span class=n>mem2</span><span class=w> </span><span class=mi>1350</span><span class=p>;</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <h4 id=result_8>Result<a class=headerlink href=#result_8 title="Permanent link">~</a></h4> <ul> <li> <p>When device restarts, calculate if the light should be on or off<br> <code>ON Time#Initialized DO event chkSun ENDON</code></p> </li> <li> <p>Calculate if the light should be on or off<br> <code>ON Time#Minute=%sunset% DO event chkSun ENDON</code> <code>ON Time#Minute=%mem2% DO event chkSun ENDON</code> <code>ON Time#Minute=%sunrise% DO event chkSun ENDON</code> <code>ON Time#Minute=%mem1% DO event chkSun ENDON</code></p> </li> <li> <p>Calculate if the light should be on or off<br> <code>on event#chkSun do Backlog</code></p> </li> <li> <p>Assume off<br> <code>var1 0;</code></p> </li> <li> <p>Trigger each event with the current time<br> <code>event chkSunrise=%time%; event chkSunset=%time%; event chkmorn=%time%; event chknight=%time%; event setPower</code></p> </li> <li> <p>End rule <br> <code>ENDON</code></p> </li> <li> <p>If before sunrise, turn on<br> <code>ON event#chkSunrise&lt;%sunrise% DO var1 1 ENDON</code></p> </li> <li> <p>If past sunset, turn on<br> <code>ON event#chkSunset&gt;=%sunset% DO var1 1 ENDON</code></p> </li> <li> <p>But if before Morning time (<code>mem1</code>), do not turn on<br> <code>ON event#chkmorn&lt;%mem1% DO var1 0 ENDON</code></p> </li> <li> <p>Or if after Night time (<code>mem2</code>), do not turn on<br> <code>ON event#chknight&gt;=%mem2% DO var1 0 ENDON</code></p> </li> <li> <p>Perform on/off state<br> <code>ON event#setPower DO Power1 %var1% ENDON</code></p> </li> <li> <p>Set variables for Morning (06h00) and Night (22h30) times<br> <code>Backlog mem1 360; mem2 1350</code></p> </li> <li> <p>Turn on the rule sets<br> <code>Backlog Rule1 1; Rule2 1</code></p> </li> </ul> <hr> <h3 id=turn-on-light-before-dawn-and-at-dusk_1>Turn On Light Before Dawn and At Dusk<a class=headerlink href=#turn-on-light-before-dawn-and-at-dusk_1 title="Permanent link">~</a></h3> <p>Turn on light at dusk until your nighttime and again in the morning before dawn.<br> <em>(Web UI timer method)</em></p> <p>What if the sun sets after your nighttime, as in during the summer? Then the timer will turn off the light at "night", but then the Sunset timer will turn it on again, so it stays on all night. This version uses the timers to set the actual time, using the %timerN% variables made availible in Tasmota V11. As a result, while the rule still needs to be applied by a skilled user, a less savvy family member can next choose or modify the desired times.</p> <h4 id=rule_9>Rule<a class=headerlink href=#rule_9 title="Permanent link">~</a></h4> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Initialized</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checktime</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=kt>Clock</span><span class=o>#</span><span class=kt>Timer</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checktime</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=o>%</span><span class=n>var10</span><span class=o>%</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=o>&gt;=%</span><span class=n>timer1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=o>&gt;=%</span><span class=n>timer2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=o>&gt;=%</span><span class=n>timer3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=o>&gt;=%</span><span class=n>timer4</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var10</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>You do need to make sure the timers are set to run rules instead of hard ON-OFF. Timer 1,3 are interpreted as ON, Timer 2,4 as OFF. Here are some example timers, on at 06h00, off at 23h00, but you can also set these in the Web UI <br> <div class=highlight><pre><span></span><code><span class=kt>Timer1</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;06:00&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>2</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>3</span><span class=p>}</span>
<span class=kt>Timer2</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;00:00&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>2</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>3</span><span class=p>}</span>
<span class=kt>Timer3</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>2</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;00:00&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>2</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>3</span><span class=p>}</span>
<span class=kt>Timer4</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;23:00&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>2</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>3</span><span class=p>}</span>
</code></pre></div></p> <p>The basic rule above works for all situations where the sun (with or without offset) or scheduled time does not pass midnight. The more advanced version below works (from <a href=https://github.com/arendst/Tasmota/pull/16914>#16914</a> onward) also if the sunset or scheduled time is after midnight, or even if there is no sunset at all (permanent daylight or night in north scandinavia) <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Initialized</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checktime</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=kt>Clock</span><span class=o>#</span><span class=kt>Timer</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checktime</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checktime</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>timer1</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>%</span><span class=n>timer2</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>%</span><span class=n>timer3</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=o>%</span><span class=n>timer4</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var6</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checknoon</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>var1</span><span class=o>#</span><span class=n>state</span><span class=o>&gt;</span><span class=mi>1140</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>sub1</span><span class=w> </span><span class=mi>1440</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>var2</span><span class=o>#</span><span class=n>state</span><span class=o>&gt;</span><span class=mi>1140</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>sub2</span><span class=w> </span><span class=mi>1440</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>var5</span><span class=o>#</span><span class=n>state</span><span class=o>&gt;</span><span class=mi>1140</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>sub5</span><span class=w> </span><span class=mi>1440</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>var3</span><span class=o>#</span><span class=n>state</span><span class=o>&lt;=</span><span class=mi>420</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>add3</span><span class=w> </span><span class=mi>1440</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>var4</span><span class=o>#</span><span class=n>state</span><span class=o>&lt;=</span><span class=mi>420</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>add4</span><span class=w> </span><span class=mi>1440</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>var6</span><span class=o>#</span><span class=n>state</span><span class=o>&lt;=</span><span class=mi>420</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>add6</span><span class=w> </span><span class=mi>1440</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checknoon</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checkafternoon</span><span class=o>=%</span><span class=n>var6</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checknoon</span><span class=o>&lt;=</span><span class=mi>780</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checkmorning</span><span class=o>=%</span><span class=n>var5</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>settime</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checknoon</span><span class=o>&gt;</span><span class=mi>780</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checkafternoon</span><span class=o>=%</span><span class=n>var6</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>settime</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checkmorning</span><span class=o>&gt;=%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checkmorning</span><span class=o>&gt;=%</span><span class=n>var2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checkafternoon</span><span class=o>&gt;=%</span><span class=n>var3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checkafternoon</span><span class=o>&gt;=%</span><span class=n>var4</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var10</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>settime</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var10</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <em>For an attempted explanation of above advanced rule, please refer to the design and test XLS in <a href=https://github.com/arendst/Tasmota/pull/16914>#16914</a></em></p> <hr> <h3 id=enable-a-pir-switch-only-at-night>Enable a PIR Switch only at night<a class=headerlink href=#enable-a-pir-switch-only-at-night title="Permanent link">~</a></h3> <p>Latitude and Longitude need to be set in config. Use PulseTime to specify the duration the light should remains on. Every PIR trigger will restart for that amount of time.</p> <div class=highlight><pre><span></span><code><span class=kt>SwitchMode1</span><span class=w> </span><span class=mi>14</span>
<span class=kt>PulseTime</span><span class=w> </span><span class=mi>60</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checksunrise</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checksunset</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checksunrise</span><span class=o>&lt;%</span><span class=n>sunrise</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checksunset</span><span class=o>&gt;%</span><span class=n>sunset</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=control-luminance-switch-with-timer>Control luminance switch with Timer<a class=headerlink href=#control-luminance-switch-with-timer title="Permanent link">~</a></h3> <p><strong>Background:</strong> Tasmota powers a Sonoff Basic attached to a TS-2561 Luminance Sensor. This switch toggles a lamp ON or OFF. The switch should work as below: i) during daytime (sunrise-sunset): ON when it is too dark (&lt;150 lx) and OFF when it gets brighter (&gt;175 lx). ii) during evenings it ignores the sensor and turns on at sunset and turns off after about 5 hours </p> <p><strong>Approach:</strong> Used a combination of Clock Timers and Rule to do this. </p> <p><strong>Timer 1:</strong> Power ON switch at Sunset<br> Powers on the switch at sunset with an offset of 20 minutes. Repeats every day.<br> <div class=highlight><pre><span></span><code><span class=kt>Timer1</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>2</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;-00:20&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>}</span>
</code></pre></div></p> <p><strong>Timer 2:</strong> Power OFF switch at Night.<br> Turns power OFF at 23.00hrs. Repeats every day.<br> <div class=highlight><pre><span></span><code><span class=kt>Timer2</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;23:00&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>}</span>
</code></pre></div></p> <p><strong>Timer 3:</strong> Trigger Luminance Rule at Sunrise<br> Start watching the Lux sensor 15 minutes after sunrise.<br> <div class=highlight><pre><span></span><code><span class=kt>Timer3</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Enable&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Mode&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;00:15&quot;</span><span class=p>,</span><span class=s>&quot;Window&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>,</span><span class=s>&quot;Days&quot;</span><span class=kt>:</span><span class=s>&quot;1111111&quot;</span><span class=p>,</span><span class=s>&quot;Repeat&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Output&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Action&quot;</span><span class=kt>:</span><span class=mi>3</span><span class=p>}</span>
</code></pre></div></p> <p><strong>Rule 1:</strong> Main Rule to check Luminance<br> If Luminance is less than 150lx, power ON. If it goes beyond 175lx, power OFF.<br> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=kt>TSL2561</span><span class=o>#</span><span class=kt>Illuminance</span><span class=o>&lt;</span><span class=mi>150</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=kt>TSL2561</span><span class=o>#</span><span class=kt>Illuminance</span><span class=o>&gt;</span><span class=mi>175</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
<span class=p>```</span><span class=n>haskell</span>

<span class=o>**</span><span class=kt>Rule</span><span class=w> </span><span class=mi>2</span><span class=kt>:**</span><span class=w> </span><span class=kt>Trigger</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=n>only</span><span class=w> </span><span class=kr>in</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=kt>Mornings</span><span class=w>  </span>
<span class=kt>This</span><span class=w> </span><span class=n>ensures</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>triggered</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=kt>Timer3</span><span class=w> </span><span class=n>starts</span><span class=w> </span><span class=p>(</span><span class=kr>in</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>morning</span><span class=p>)</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>stops</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=kt>Timer1</span><span class=w> </span><span class=n>starts</span><span class=w> </span><span class=p>(</span><span class=kr>in</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>evenings</span><span class=p>)</span><span class=o>.</span><span class=w>  </span>
<span class=p>```</span><span class=n>haskell</span>
<span class=kt>Rule2</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Clock</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Clock</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule2</span><span class=w> </span><span class=mi>1</span>
</code></pre></div></p> <h3 id=automatically-vary-the-color-temperature-of-a-cct-light>Automatically vary the color temperature of a CCT light<a class=headerlink href=#automatically-vary-the-color-temperature-of-a-cct-light title="Permanent link">~</a></h3> <p><strong>Background:</strong> Tasmota powers a CCT light which is adjustable from cool white to warm white. You want the color temperature to automatically vary between cool (CT=153) at midday to warm (CT=500) at midnight.</p> <p><strong>Approach:</strong> Check that your timezone and DST (if applicable) are set correctly and the time is correctly set on your light using NTP. Create the two rules to scale the CT based on the time of day. If Wifi is unavailable or NTP can't determine the time of day then the light will default to the mid point for neutral white (CT=326). Adjusting the CT will switch the light on so Rule 2 disables and enables Rule 1 according to the state of the light.</p> <p><strong>Rule 1:</strong> Set the CT according to the time of day.</p> <p><div class=highlight><pre><span></span><code><span class=nf>rule1</span><span class=w> </span>
<span class=w>    </span><span class=n>on</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=kt>Boot</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>CT</span><span class=w> </span><span class=mi>326</span><span class=w> </span><span class=n>endon</span>
<span class=w>    </span><span class=n>on</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Initialized</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>myCT</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=n>endon</span>
<span class=w>    </span><span class=n>on</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>myCT</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=n>endon</span>
<span class=w>    </span><span class=n>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>myCT</span><span class=o>&lt;=</span><span class=mi>720</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=n>scale1</span><span class=w> </span><span class=o>%</span><span class=n>time</span><span class=o>%</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>720</span><span class=p>,</span><span class=mi>500</span><span class=p>,</span><span class=mi>153</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>updateCT</span><span class=w> </span><span class=n>endon</span>
<span class=w>    </span><span class=n>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>myCT</span><span class=o>&gt;</span><span class=mi>720</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=n>scale1</span><span class=w> </span><span class=o>%</span><span class=n>time</span><span class=o>%</span><span class=p>,</span><span class=mi>720</span><span class=p>,</span><span class=mi>1440</span><span class=p>,</span><span class=mi>153</span><span class=p>,</span><span class=mi>500</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>updateCT</span><span class=w> </span><span class=n>endon</span>
<span class=w>    </span><span class=n>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>updateCT</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>CT</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=n>endon</span>
<span class=nf>rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <strong>Rule 2:</strong> Toggle rule 1 on and off with the light and also update the CT for the current time when the light is switched on.</p> <p><div class=highlight><pre><span></span><code><span class=kt>Rule2</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>myCT</span><span class=o>=%</span><span class=n>time</span><span class=o>%</span><span class=w> </span><span class=n>endon</span>
<span class=kt>Rule2</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> Notes:</p> <p>When the light is powered up on it should change to neutral white for a few seconds while Wifi, MQTT and NTP are initialised then switch to the correct color temperature for the time of day. If the light is switched off in software then it will come back on with the previous CT then update to the current CT after a few seconds.</p> <p>If you have a RGBCCT light then the CT light may be Power2 rather than Power1.</p> <p>It is possible to use %sunrise% and %sunset% to adjust the CT if you set your latitude, longitude and elevation but it's much more complex especially at extreme Northern and Southern latitudes. </p> <hr> <h3 id=perform-any-action-on-singledouble-press-for-switches-and-buttons>Perform any action on single/double press (for switches AND buttons)<a class=headerlink href=#perform-any-action-on-singledouble-press-for-switches-and-buttons title="Permanent link">~</a></h3> <h4 id=rule_10>Rule<a class=headerlink href=#rule_10 title="Permanent link">~</a></h4> <p><code>SwitchMode 5</code></p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=o>==</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=o>==</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>var1</span><span class=o>#</span><span class=n>state</span><span class=o>!=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=mi>6</span><span class=p>;</span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>var1</span><span class=o>#</span><span class=n>state</span><span class=o>==</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>othertasmota</span><span class=o>/</span><span class=kt>POWER</span><span class=w> </span><span class=n>toggle</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p><code>Rule1 on</code></p> <h4 id=result_9>Result<a class=headerlink href=#result_9 title="Permanent link">~</a></h4> <ul> <li>each toggle of the switch triggers first condition and adds 1 to our variable (var1 in the example),</li> <li>each toggle of the switch toggles the associated relay (<code>Power1 2</code> - but can do anything else instead, <code>Publish</code> for example)</li> <li>when var1 changes to non zero, we set it back to 0 but after a <code>Delay</code> (arbitrarily chosen 6 here - 0.6 seconds)</li> <li>when var1 reaches 2 (i.e. the switch has been toggled twice within the last 0.6 seconds), desired action is triggered (here: <code>Publish</code> to <code>othertasmota</code>)</li> </ul> <p>Every time you press the switch, your light toggles state (as it should). If you do press the switch twice in a rapid succession (i.e., double-click), you can trigger a different action (e.g., on a remote device).</p> <hr> <h3 id=enable-or-disable-relay-with-a-switch-in-domoticz>Enable or disable relay with a switch in Domoticz<a class=headerlink href=#enable-or-disable-relay-with-a-switch-in-domoticz title="Permanent link">~</a></h3> <p>When you want to send MQTT messages ( we use domoticz in this example ) and choose when you want the relay on or off, by simply sending HTTP commands to trigger an event. </p> <p><strong>Initial Config:</strong></p> <ul> <li>PushButton Doorbell</li> <li>(Sonoff Basic R1) GPIO14 - Switch4 (12)</li> </ul> <p>Connect the Switch to GND and the GPIO on your device. Be sure put a 4.7k resistor between VCC(3.3v) and the GPIO. This prevents ghost switching (capacitor is optional) See: <a href="https://www.youtube.com/watch?v=aq8_os6g13s">YouTube</a> </p> <p><em>Dont forget to change the IDX value</em></p> <p><strong>Commands:</strong></p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchTopic</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode4</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption0</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>PowerOnState</span><span class=w> </span><span class=mi>0</span>

<span class=nf>var1</span><span class=w> </span><span class=mi>1</span>

<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>doorbell</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch4</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>domoticz</span><span class=o>/</span><span class=kr>in</span><span class=w> </span><span class=p>{</span><span class=s>&quot;idx&quot;</span><span class=kt>:</span><span class=mi>11</span><span class=p>,</span><span class=s>&quot;nvalue&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch4</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch4</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>domoticz</span><span class=o>/</span><span class=kr>in</span><span class=w> </span><span class=p>{</span><span class=s>&quot;idx&quot;</span><span class=kt>:</span><span class=mi>11</span><span class=p>,</span><span class=s>&quot;nvalue&quot;</span><span class=kt>:</span><span class=mi>0</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch4</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <p><strong>Usage:</strong> </p> <p>Turn off the relay by calling the event using HTTP:<br> <code>http://&lt;tasmotaIP&gt;/cm?cmnd=event%20doorbell=0</code> </p> <p>Turn on the relay by calling the event using HTTP:<br> <code>http://&lt;tasmotaIP&gt;/cm?cmnd=event%20doorbell=1</code> </p> <p>If your Tasmota device is password protected, which is most common, then use the following HTTP commands instead. Make sure you change <code>&lt;tasmotaUsername&gt;</code> and <code>&lt;tasmotaPassword&gt;</code> </p> <p>Off:<br> <code>http://&lt;tasmotaIP&gt;/cm?&amp;user=&lt;tasmotaUsername&gt;&amp;password=&lt;tasmotaPassword&gt;&amp;cmnd=event%20doorbell=0</code><br> On:<br> <code>http://&lt;tasmotaIP&gt;/cm?&amp;user=&lt;tasmotaUsername&gt;&amp;password=&lt;tasmotaPassword&gt;&amp;cmnd=event%20doorbell=1</code></p> <hr> <h3 id=force-automatic-re-connection-to-mqtt-server-via-sd-dns>Force automatic re-connection to MQTT server via SD DNS<a class=headerlink href=#force-automatic-re-connection-to-mqtt-server-via-sd-dns title="Permanent link">~</a></h3> <p>In order to search for the MQTT server using SD-DNS service (a.k.a. Bonjour or Zero Network Configuration) the suggested configuration is to leave the MQTT Host field blank.</p> <p>The standard behavior of Tasmota is </p> <ul> <li>searches for _mqtt._tcp service</li> <li>resolve that to the proper IP address</li> <li>connect to it </li> <li>in case the connection is successful, retain the IP address and use that in the subsequent connections</li> </ul> <p>The above is not proper, though, in case you have a redundant MQTT (e.g., two MQTT server synchronized). In such case, when the active MQTT fails for any reason, the expected behavior is to achieve automatic re-connection to the other MQTT server.</p> <p>That can be easily configured defining the following rule on the device console:</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>Mqtt</span><span class=o>#</span><span class=kt>Disconnected</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>MqttHost</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <p>If the MqttHost field already contains an IP, you have to delete it using the web interface or the following MQTT command:</p> <div class=highlight><pre><span></span><code><span class=go>mosquitto_pub -h mqtt_server.local -t &quot;cmnd/mqttTopic/MqttHost&quot; -m &#39;&#39;</span>
</code></pre></div> <hr> <h3 id=change-distance-to-percentage>Change distance to percentage<a class=headerlink href=#change-distance-to-percentage title="Permanent link">~</a></h3> <p>When measuring distance and you have the need to see it in percentage of distance. In the example 100% is everything below 69cm and 0% is everything above 128cm. This is used for showing fill percentage of a wood pellets storage.</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=kt>SR04</span><span class=o>#</span><span class=n>distance</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>checklimit</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>senddistance</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checklimit</span><span class=o>&gt;</span><span class=mi>128</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>128</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>checklimit</span><span class=o>&lt;</span><span class=mi>69</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>68</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>senddistance</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>SCALE1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=p>,</span><span class=w> </span><span class=mi>128</span><span class=p>,</span><span class=w> </span><span class=mi>69</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>pubdata</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>pubdata</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>tele</span><span class=o>/</span><span class=n>pannrum</span><span class=o>-</span><span class=n>temp</span><span class=o>/</span><span class=kt>SENSOR</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <hr> <h3 id=distinguish-switch1-and-switch2-without-the-use-of-relay1-and-relay2>Distinguish Switch1 and Switch2 (without the use of Relay1 and Relay2)<a class=headerlink href=#distinguish-switch1-and-switch2-without-the-use-of-relay1-and-relay2 title="Permanent link">~</a></h3> <p>When two (or more) switches are defined as input and you want to distinguish these in the RESULT topic without the use of Relays, then consider the following rules. </p> <ul> <li> <p>SwitchMode1 1 will make Switch1#state to be 1 when ON and 0 when OFF<br> <code>SwitchMode1 1</code></p> </li> <li> <p>SwitchMode2 1 will make Switch2#state to be 1 when ON and 0 when OFF<br> <code>SwitchMode2 1</code></p> </li> <li> <p>Publish json with key POWER1 and value %value% <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>wemos</span><span class=o>-</span><span class=mi>4</span><span class=o>/</span><span class=kt>RESULT</span><span class=w> </span><span class=p>{</span><span class=s>&quot;POWER1&quot;</span><span class=kt>:</span><span class=s>&quot;%value%&quot;</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> </li> <li> <p>Publish json with key POWER2 and value %value%<br> <div class=highlight><pre><span></span><code><span class=kt>Rule2</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>switch2</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>wemos</span><span class=o>-</span><span class=mi>4</span><span class=o>/</span><span class=kt>RESULT</span><span class=w> </span><span class=p>{</span><span class=s>&quot;POWER2&quot;</span><span class=kt>:</span><span class=s>&quot;%value%&quot;</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> </li> <li> <p>Enable Rules <code>Backlog Rule1 1; Rule2 1</code></p> </li> </ul> <p>Output:</p> <div class=highlight><pre><span></span><code>RUL: SWITCH1#STATE performs &quot;publish stat/wemos-4/RESULT {&quot;POWER1&quot;:&quot;1&quot;}&quot;
MQT: stat/wemos-4/RESULT = {&quot;POWER1&quot;:&quot;1&quot;}
RUL: SWITCH2#STATE performs &quot;publish stat/wemos-4/RESULT {&quot;POWER2&quot;:&quot;1&quot;}&quot;
MQT: stat/wemos-4/RESULT = {&quot;POWER2&quot;:&quot;1&quot;}
RUL: SWITCH1#STATE performs &quot;publish stat/wemos-4/RESULT {&quot;POWER1&quot;:&quot;0&quot;}&quot;
MQT: stat/wemos-4/RESULT = {&quot;POWER1&quot;:&quot;0&quot;}
RUL: SWITCH2#STATE performs &quot;publish stat/wemos-4/RESULT {&quot;POWER2&quot;:&quot;0&quot;}&quot;
MQT: stat/wemos-4/RESULT = {&quot;POWER2&quot;:&quot;0&quot;}
RUL: SWITCH1#STATE performs &quot;publish stat/wemos-4/RESULT {&quot;POWER1&quot;:&quot;1&quot;}&quot;
MQT: stat/wemos-4/RESULT = {&quot;POWER1&quot;:&quot;1&quot;}
RUL: SWITCH1#STATE performs &quot;publish stat/wemos-4/RESULT {&quot;POWER1&quot;:&quot;0&quot;}&quot;
MQT: stat/wemos-4/RESULT = {&quot;POWER1&quot;:&quot;0&quot;}
</code></pre></div> <hr> <h3 id=receiving-state-of-anything-that-triggers-switch-more-than-one-time>Receiving state of anything that triggers SWITCH more than one time<a class=headerlink href=#receiving-state-of-anything-that-triggers-switch-more-than-one-time title="Permanent link">~</a></h3> <p>With analog intercom doorbells you can take out info about ringing from speaker voltage. You can connect GPIO to it via opto-isolator and resistor to take out state. But even with those speaker voltage is dropping so it switches the device multiple times. <div class=highlight><pre><span></span><code>MQT: cmnd/doorbell/POWER2 = OFF (retained)
MQT: cmnd/doorbell/POWER2 = ON (retained)
MQT: cmnd/doorbell/POWER2 = OFF (retained)
MQT: cmnd/doorbell/POWER2 = ON (retained)
MQT: cmnd/doorbell/POWER2 = OFF (retained)
</code></pre></div></p> <p>To solve it we can use rules. <div class=highlight><pre><span></span><code><span class=kt>SwitchTopic</span><span class=w> </span><span class=mi>0</span>

<span class=kt>Rule1</span>
<span class=w>  </span><span class=n>on</span><span class=w> </span><span class=kt>System</span><span class=o>#</span><span class=kt>Boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch2</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>START</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>START</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>BELL</span><span class=o>=%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>BELL</span><span class=ow>=</span><span class=mf>1.000</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>bell</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=n>on</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>BELL</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>bell</span><span class=o>/</span><span class=n>power</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>BELL</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div></p> <p>description:</p> <ul> <li>Disable SwitchTopic as it overrides rules for switches: <code>SwitchTopic 0</code></li> <li>on system boot set var1 to 0</li> <li>on switch2 click (person pushing doorbell) - var1 += 1; trigger event START</li> <li>on START - set event BELL equal to var1</li> <li>if event#BELL=1 (triggered first time) publish mqtt message ON and trigger RulesTimer1 for 60 seconds</li> <li>if event#BELL=0 publish mqtt message OFF </li> <li>on RulesTimer1 - reset var1 to 0, and call event#BELL.</li> <li>enable rule 1</li> </ul> <p>In this case we have lock for 60 seconds for multiple people calls or to be resistant for speaker voltage drops.</p> <hr> <h3 id=prevent-wemos-d1-mini-load-overcurrent>Prevent Wemos D1 mini load overcurrent<a class=headerlink href=#prevent-wemos-d1-mini-load-overcurrent title="Permanent link">~</a></h3> <p>As a WS2812 24 led ring draws approximately 24x3x20 mA = 1.44A and the Wemos D1 mini powered from a PC's USB port can only provide up to 0.5A it would be nice to have some kind of mechanism in place to limit the amount of current to the WS2812 LEDring to 0.1A. This is still enough to light all 24 leds up to color 202020.</p> <p>Hardware</p> <ul> <li>Wemos D1 mini</li> <li>INA219 I<sup>2</sup>C sensor</li> <li>WS2812 LEDring with 24 LEDs powered by the Wemos D1 mini 5V thru the INA219 sensor</li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>INA219</span><span class=o>#</span><span class=kt>Current</span><span class=o>&gt;</span><span class=mf>0.100</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Dimmer</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=kt>Color</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>Rule1</span><span class=w> </span><span class=n>on</span>
</code></pre></div> <p>Result - When a user raises brightness to a level using more than 0.1A the rule kicks in and lowers the current by executing command <code>Dimmer 10</code> and changes the color to Red with command <code>Color 10,0,0</code>.</p> <hr> <h3 id=using-dummy-gpio-to-send-serial-codes-to-an-mcu>Using dummy GPIO to send Serial codes to an MCU<a class=headerlink href=#using-dummy-gpio-to-send-serial-codes-to-an-mcu title="Permanent link">~</a></h3> <p>By having a device that controls all its features through an MCU and reports the states in serial codes to the ESP8266 we have to create some rules to control it using the Web UI or standard Power commands.</p> <p><div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=kt>AA00060005020400010213</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=kt>AA00060005020400010011</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=kt>AA00060005060400010217</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=kt>AA00060005060400010015</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> Power1 controls the device, Power2 turn on and off the light on the device.</p> <p>Another rule was created to issue commands on boot so the serial interface works every time and to control the built in fan using Event triggers and have its state retained in an MQTT message for Home Assistant.</p> <div class=highlight><pre><span></span><code><span class=kt>Rule2</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>baudrate</span><span class=w> </span><span class=mi>9600</span><span class=p>;</span><span class=w> </span><span class=n>seriallog</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=n>aa000300010306</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>high</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=kt>AA00060005650400010175</span><span class=p>;</span><span class=w> </span><span class=n>publish2</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>diffuser</span><span class=o>/</span><span class=kt>FAN</span><span class=w> </span><span class=n>high</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>low</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>serialsend5</span><span class=w> </span><span class=mi>55</span><span class=kt>AA00060005650400010074</span><span class=p>;</span><span class=w> </span><span class=n>publish2</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>diffuser</span><span class=o>/</span><span class=kt>FAN</span><span class=w> </span><span class=n>low</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=arithmetic-commands-used-with-var>Arithmetic commands used with VAR<a class=headerlink href=#arithmetic-commands-used-with-var title="Permanent link">~</a></h3> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The arithmetic is done using single point precision floating point. This means calculations involving values larger than approximately 16 million (ex: <code>%utctime%</code>) will not be precise.</p> </div> <h4 id=add>ADD<a class=headerlink href=#add title="Permanent link">~</a></h4> <p><code>ADD1</code> to <code>ADD16</code>: Add a value to <code>VARx</code><br> Syntax: <code>ADDx value</code><br> Usage: <code>ADD1 15</code><br> Result: <code>VAR1 = VAR1 + 15</code> </p> <h4 id=subtract>SUBTRACT<a class=headerlink href=#subtract title="Permanent link">~</a></h4> <p><code>SUB1</code>to <code>SUB16</code>: Subtract a value from <code>VARx</code><br> Syntax: <code>SUBx value</code><br> Usage: <code>SUB1 15</code><br> Result: <code>VAR1 = VAR1 - 15</code> </p> <h4 id=multiply>MULTIPLY<a class=headerlink href=#multiply title="Permanent link">~</a></h4> <p><code>MULT1</code>to <code>MULT16</code>: Multiply a value to <code>VARx</code><br> Syntax: <code>MULTx value</code><br> Usage: <code>MULT1 15</code><br> Result: <code>VAR1 = VAR1 * 15</code> </p> <h4 id=scale-a-value>SCALE A VALUE<a class=headerlink href=#scale-a-value title="Permanent link">~</a></h4> <p><code>SCALE1</code>to <code>SCALE16</code>: Scale a value from a low and high limit to another low and high limit and store it in <code>VARx</code> (directly equivalent to MAP arduino command) </p> <p>Syntax: <code>SCALEx value, fromLow, fromHigh, toLow, toHigh</code> </p> <p>where, </p> <p><em>value</em>: the number to scale<br> <em>fromLow</em>: the lower bound of the values current range<br> <em>fromHigh</em>: the upper bound of the values current range<br> <em>toLow</em>: the lower bound of the values target range<br> <em>toHigh</em>: the upper bound of the values target range </p> <p><em>(omitted values are taken as zero)</em> </p> <p>Usage: <code>SCALE1 15, 0, 100, 0, 1000</code><br> Result: <code>VAR1 = 150</code> </p> <hr> <h3 id=transmit-sensor-value-only-when-a-delta-is-reached>Transmit sensor value only when a delta is reached<a class=headerlink href=#transmit-sensor-value-only-when-a-delta-is-reached title="Permanent link">~</a></h3> <p>Send only when the sensor value changes by a certain amount. </p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>SI7021</span><span class=o>#</span><span class=n>temperature</span><span class=o>&gt;%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>mqttTopic</span><span class=o>/</span><span class=n>temp</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=n>sub2</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>SI7021</span><span class=o>#</span><span class=n>temperature</span><span class=o>&lt;%</span><span class=n>var2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>mqttTopic</span><span class=o>/</span><span class=n>temp</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=n>sub2</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>This example explains expands on the above example while matching typical sensor data. Helpful for HA tasmota integration sensors when polling and adding in delta value changes.</p> <p>Normal polling data below <div class=highlight><pre><span></span><code><span class=mi>23</span><span class=kt>:</span><span class=mi>58</span><span class=kt>:</span><span class=mi>41</span><span class=w> </span><span class=kt>MQT:</span><span class=w> </span><span class=n>tele</span><span class=o>/</span><span class=n>ds1820</span><span class=o>/</span><span class=kt>SENSOR</span><span class=w> </span><span class=ow>=</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;2021-01-13T23:58:41&quot;</span><span class=p>,</span><span class=s>&quot;DS18B20&quot;</span><span class=kt>:</span><span class=p>{</span><span class=s>&quot;Id&quot;</span><span class=kt>:</span><span class=s>&quot;030597946B04&quot;</span><span class=p>,</span><span class=s>&quot;Temperature&quot;</span><span class=kt>:</span><span class=mf>20.9</span><span class=p>},</span><span class=s>&quot;TempUnit&quot;</span><span class=kt>:</span><span class=s>&quot;C&quot;</span><span class=p>}</span>
</code></pre></div> The matching rule.</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>DS18B20</span><span class=o>#</span><span class=n>temperature</span><span class=o>&gt;%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>tele</span><span class=o>/</span><span class=n>ds1820</span><span class=o>/</span><span class=kt>SENSOR</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;%timestamp%&quot;</span><span class=p>,</span><span class=s>&quot;DS18B20&quot;</span><span class=kt>:</span><span class=p>{</span><span class=s>&quot;Id&quot;</span><span class=kt>:</span><span class=s>&quot;030597946B04&quot;</span><span class=p>,</span><span class=s>&quot;Temperature&quot;</span><span class=kt>:%</span><span class=n>value</span><span class=o>%</span><span class=p>},</span><span class=s>&quot;TempUnit&quot;</span><span class=kt>:</span><span class=s>&quot;C&quot;</span><span class=p>};</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mf>0.5</span><span class=p>;</span><span class=w> </span><span class=n>sub2</span><span class=w> </span><span class=mf>0.5</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>DS18B20</span><span class=o>#</span><span class=n>temperature</span><span class=o>&lt;%</span><span class=n>var2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>tele</span><span class=o>/</span><span class=n>ds1820</span><span class=o>/</span><span class=kt>SENSOR</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Time&quot;</span><span class=kt>:</span><span class=s>&quot;%TIMESTAMP%&quot;</span><span class=p>,</span><span class=s>&quot;DS18B20&quot;</span><span class=kt>:</span><span class=p>{</span><span class=s>&quot;Id&quot;</span><span class=kt>:</span><span class=s>&quot;030597946B04&quot;</span><span class=p>,</span><span class=s>&quot;Temperature&quot;</span><span class=kt>:%</span><span class=n>value</span><span class=o>%</span><span class=p>},</span><span class=s>&quot;TempUnit&quot;</span><span class=kt>:</span><span class=s>&quot;C&quot;</span><span class=p>};</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mf>0.5</span><span class=p>;</span><span class=w> </span><span class=n>sub2</span><span class=w> </span><span class=mf>0.5</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=adjust-a-value-and-send-it-over-mqtt>Adjust a value and send it over MQTT<a class=headerlink href=#adjust-a-value-and-send-it-over-mqtt title="Permanent link">~</a></h3> <p>This example adds 2 degrees to the measured temperature and then sends that value to an MQTT topic.</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=kt>SI7021</span><span class=o>#</span><span class=n>temperature</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add1</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>sendtemp</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>sendtemp</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=n>mqttTopic</span><span class=o>/</span><span class=n>temp</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=control-relays-via-serial>Control relays via serial<a class=headerlink href=#control-relays-via-serial title="Permanent link">~</a></h3> <p>This example switches connected relays over the software serial on and off.</p> <p>Write the following rules:</p> <div class=highlight><pre><span></span><code><span class=nf>rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>SSerialReceived</span><span class=o>#</span><span class=kt>Data</span><span class=ow>=</span><span class=n>on</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>SSerialReceived</span><span class=o>#</span><span class=kt>Data</span><span class=ow>=</span><span class=n>off</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>receiving <code>on</code> and <code>off</code> results in</p> <div class=highlight><pre><span></span><code>MQT: tele/mqttTopic/RESULT = {&quot;SSerialReceived&quot;:&quot;on&quot;}
RUL: SSERIALRECEIVED#DATA=ON performs &quot;Power1 1&quot;
MQT: stat/mqttTopic/RESULT = {&quot;POWER&quot;:&quot;ON&quot;}
MQT: stat/mqttTopic/POWER = ON
MQT: tele/mqttTopic/RESULT = {&quot;SSerialReceived&quot;:&quot;off&quot;}
RUL: SSERIALRECEIVED#DATA=OFF performs &quot;Power1 0&quot;
MQT: stat/mqttTopic/RESULT = {&quot;POWER&quot;:&quot;OFF&quot;}
MQT: stat/mqttTopic/POWER = OFF
</code></pre></div> <hr> <h3 id=processing-json-received-from-softwareserialbridge>Processing JSON received from (Software)SerialBridge<a class=headerlink href=#processing-json-received-from-softwareserialbridge title="Permanent link">~</a></h3> <p>When using SerialBridge <em>(or SoftwareSerialBridge)</em>, the received string will be published to Rules as SerialReceived <em>(or SSerialReceived)</em>. If the string starts with a <code>{</code> then Tasmota will parse the string as a JSON and make the different keys available for Rules. For example with the following string <code>{"DeviceID":"TM182","Temp":25.3,"Hum":50}</code>, it is possible to use any of the keys in the trigger. <div class=highlight><pre><span></span><code>rule1
  ON SSerialReceived#DeviceID DO var1 %value% ENDON
  ON SSerialReceived#Temp DO var2 %value% ENDON
  ON SSerialReceived#Hum DO publish /some/topic/%var1% {&quot;Temperature&quot;:%var2%,&quot;Humidity&quot;:%value%} ENDON
</code></pre></div></p> <p>The 1st and 2nd rules store the values for <code>Device</code> and <code>Temp</code> into variables. The last key triggers the 3rd rule, here re-publication on a different topic.</p> <p>Execution: <div class=highlight><pre><span></span><code>12:51:48.050 MQT: tele/nodemcu/SSERIALRECEIVED = {&quot;SSerialReceived&quot;:{&quot;DeviceID&quot;:&quot;TM182&quot;,&quot;Temp&quot;:25.3,&quot;Hum&quot;:50}}
12:51:48.064 RUL: SSERIALRECEIVED#DEVICEID performs &quot;var1 TM182&quot;
12:51:48.071 MQT: stat/nodemcu/VAR = {&quot;Var1&quot;:&quot;TM182&quot;}
12:51:48.083 RUL: SSERIALRECEIVED#TEMP performs &quot;var2 25.3&quot;
12:51:48.091 MQT: stat/nodemcu/VAR = {&quot;Var2&quot;:&quot;25.3&quot;}
12:51:48.104 RUL: SSERIALRECEIVED#HUM performs &quot;publish /some/topic/TM182 {&quot;Temperature&quot;:25.3,&quot;Humidity&quot;:50}&quot;
12:51:48.110 MQT: /some/topic/TM182 = {&quot;Temperature&quot;:25.3,&quot;Humidity&quot;:50}
</code></pre></div></p> <div class="admonition note"> <p class=admonition-title>Note</p> </div> <p>It is important that the receive string strictly starts with the opening <code>{</code>. If other characters, such as spaces or new line are inserted before, Tasmota will not par as a JSON. Characters after the closing <code>}</code> are not a problem.</p> <hr> <h3 id=using-break-to-simulate-ifelseifelseendif>Using BREAK to simulate IF..ELSEIF..ELSE..ENDIF<a class=headerlink href=#using-break-to-simulate-ifelseifelseendif title="Permanent link">~</a></h3> <p><code>BREAK</code> is an alternative to <code>ENDON</code>. <code>BREAK</code> will stop the execution for the triggers that follow. If a trigger that ends with <code>BREAK</code> fires, then the following triggers of that rule will not be executed. This allows to simulate <code>IF..ELSEIF..ELSE..ENDIF</code></p> <p><strong>Example:</strong> <div class=highlight><pre><span></span><code><span class=go>IF temp &gt; 85 then</span>
<span class=go>  VAR1 more85</span>
<span class=go>ELSEIF temp &gt; 83 then</span>
<span class=go>  VAR1 more83</span>
<span class=go>ELSEIF temp &gt; 81 then</span>
<span class=go>  VAR1 more81</span>
<span class=go>ELSEIF temp = 81 then</span>
<span class=go>  VAR1 equal81</span>
<span class=go>ELSE</span>
<span class=go>  VAR1 less81</span>
<span class=go>ENDIF</span>
</code></pre></div></p> <p>With the actual rules, if we use a set like the following: <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>85</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>more85</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>83</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>more83</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>81</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>more81</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=ow>=</span><span class=mi>81</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>equal81</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&lt;</span><span class=mi>81</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>less81</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>This is the output in the console: <div class=highlight><pre><span></span><code>CMD: rule
MQT: stat/living/RESULT = {&quot;Rule1&quot;:&quot;ON&quot;,&quot;Once&quot;:&quot;ON&quot;,&quot;StopOnError&quot;:&quot;OFF&quot;,&quot;Free&quot;:322,&quot;Rules&quot;:&quot;ON event#temp&gt;85 do VAR1 more85 ENDON ON event#temp&gt;83 do VAR1 more83 ENDON on event#temp&gt;81 do VAR1 more81 ENDON on event#temp=81 do VAR1 equal81 ENDON on event#temp&lt;81 DO VAR1 less81 ENDON&quot;}
CMD: event temp=10
MQT: stat/living/RESULT = {&quot;Event&quot;:&quot;Done&quot;}
RUL: EVENT#TEMP&lt;81 performs &quot;VAR1 less81&quot;
MQT: stat/living/RESULT = {&quot;Var1&quot;:&quot;less81&quot;}
CMD: event temp=100
MQT: stat/living/RESULT = {&quot;Event&quot;:&quot;Done&quot;}
RUL: EVENT#TEMP&gt;85 performs &quot;VAR1 more85&quot;
MQT: stat/living/RESULT = {&quot;Var1&quot;:&quot;more85&quot;}
RUL: EVENT#TEMP&gt;83 performs &quot;VAR1 more83&quot;
MQT: stat/living/RESULT = {&quot;Var1&quot;:&quot;more83&quot;}
RUL: EVENT#TEMP&gt;81 performs &quot;VAR1 more81&quot;
MQT: stat/living/RESULT = {&quot;Var1&quot;:&quot;more81&quot;}
</code></pre></div> So, all the triggers where TEMP&gt;100, are firing. With the <code>BREAK</code> statement the rule set can be changed to: <div class=highlight><pre><span></span><code><span class=kt>Rule</span>
<span class=w>  </span><span class=n>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>85</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>more85</span><span class=w> </span><span class=n>break</span>
<span class=w>  </span><span class=n>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>83</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>more83</span><span class=w> </span><span class=n>break</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>81</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>more81</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=ow>=</span><span class=mi>81</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>equal81</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=o>&lt;</span><span class=mi>81</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>VAR1</span><span class=w> </span><span class=n>less81</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>Which will result in the following output: <div class=highlight><pre><span></span><code>CMD: rule
RSL: RESULT = {&quot;Rule1&quot;:&quot;ON&quot;,&quot;Once&quot;:&quot;OFF&quot;,&quot;StopOnError&quot;:&quot;OFF&quot;,&quot;Free&quot;:321,&quot;Rules&quot;:&quot;ON event#temp&gt;85 do VAR1 more85 break ON event#temp&gt;83 do VAR1 more83 break on event#temp&gt;81 do VAR1 more81 ENDON on event#temp=81 do VAR1 equal81 ENDON on event#temp&lt;81 DO VAR1 less81 ENDON&quot;}
CMD: event temp=10
RSL: RESULT = {&quot;Event&quot;:&quot;Done&quot;}
RUL: EVENT#TEMP&lt;81 performs &quot;VAR1 less81&quot;
RSL: RESULT = {&quot;Var1&quot;:&quot;less81&quot;}
CMD: event temp=100
RSL: RESULT = {&quot;Event&quot;:&quot;Done&quot;}
RUL: EVENT#TEMP&gt;85 performs &quot;VAR1 more85&quot;
RSL: RESULT = {&quot;Var1&quot;:&quot;more85&quot;}
CMD: event temp=83
RSL: RESULT = {&quot;Event&quot;:&quot;Done&quot;}
RUL: EVENT#TEMP&gt;81 performs &quot;VAR1 more81&quot;
RSL: RESULT = {&quot;Var1&quot;:&quot;more81&quot;}
</code></pre></div></p> <hr> <h3 id=adjust-powerdelta-according-to-current-power-values>Adjust PowerDelta according to current Power values<a class=headerlink href=#adjust-powerdelta-according-to-current-power-values title="Permanent link">~</a></h3> <p>Power sensor reporting thresholds are set by a percentage change in the Power value by setting <a href=../Commands/#powerdelta>PowerDelta</a>. Power changes from 10W to 11W (10%) may not be very interesting. But power changes from 1000W to 1100W (also 10%) could be very important. To avoid getting reports for small changes but ensuring that larger power swings are reported, a rule set can be used to create a gradient threshold based on the absolute power values.</p> <p>This rule also uses the <a href=#usage-of-one-shot-once>one-shot feature of rules</a> to avoid reporting of every small change within a threshold window. The rule (a ON/DO/ENDON rule in this the set) will trigger only once when a threshold is crossed.</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>5</span>

<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&gt;=</span><span class=mi>35</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=kt>Status</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=kt>BREAK</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&gt;=</span><span class=mi>15</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>25</span><span class=p>;</span><span class=w> </span><span class=kt>Status</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=kt>BREAK</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&gt;</span><span class=mi>5</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>35</span><span class=p>;</span><span class=w> </span><span class=kt>Status</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=kt>BREAK</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&lt;=</span><span class=mi>5</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <p>Which translates (pseudo code): <div class=highlight><pre><span></span><code><span class=kt>IF</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&gt;=</span><span class=mi>35</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=w> </span><span class=kt>GE</span><span class=w> </span><span class=mi>35</span>
<span class=w>  </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=kt>Status</span><span class=w> </span><span class=mi>8</span>
<span class=kt>ELSE</span><span class=w> </span><span class=kt>IF</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&gt;=</span><span class=mi>15</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=w> </span><span class=kt>GE</span><span class=w> </span><span class=mi>15</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=kt>LT</span><span class=w> </span><span class=mi>35</span>
<span class=w>  </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>25</span><span class=p>;</span><span class=w> </span><span class=kt>Status</span><span class=w> </span><span class=mi>8</span>
<span class=kt>ELSE</span><span class=w> </span><span class=kt>IF</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=o>&gt;</span><span class=mi>5</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=w> </span><span class=kt>GT</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=kt>LT</span><span class=w> </span><span class=mi>15</span>
<span class=w>  </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>35</span><span class=p>;</span><span class=w> </span><span class=kt>Status</span><span class=w> </span><span class=mi>8</span>
<span class=kt>ELSE</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=w> </span><span class=n>changed</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>e</span><span class=o>.</span><span class=w> </span><span class=kt>LE</span><span class=w> </span><span class=mi>5</span><span class=p>)</span>
<span class=w>  </span><span class=kt>DO</span><span class=w> </span><span class=kt>PowerDelta</span><span class=w> </span><span class=mi>100</span>
</code></pre></div></p> <hr> <h3 id=forward-ir-signals>Forward IR signals<a class=headerlink href=#forward-ir-signals title="Permanent link">~</a></h3> <p>Using one IR receiver and one sender (or both extender) you can simply forward signals from one to another using the following rule <div class=highlight><pre><span></span><code><span class=nf>rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>IRreceived</span><span class=o>#</span><span class=kt>Data</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/</span><span class=n>irsideboard</span><span class=o>/</span><span class=n>irsend</span><span class=w> </span><span class=p>{</span><span class=kt>Protocol:NEC</span><span class=p>,</span><span class=kt>Bits:</span><span class=mi>32</span><span class=p>,</span><span class=kt>Data:%</span><span class=n>value</span><span class=o>%</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <hr> <h3 id=garage-door-opener>Garage Door Opener<a class=headerlink href=#garage-door-opener title="Permanent link">~</a></h3> <p>(<a href=https://github.com/arendst/Tasmota/issues/3942#issue-365226844>#3942</a>)</p> <p>// Set the relay on time to signal the opener<br> <code>PulseTime 7</code></p> <p>// Send ON and OFF as the switch is ON or OFF<br> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchMode1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode2</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode3</span><span class=w> </span><span class=mi>1</span>
</code></pre></div></p> <p>//No need to save changes on power cycle<br> <code>SetOption0 0</code></p> <p>//Dont blindly run the door on power up<br> <code>PowerOnState 0</code></p> <p>//One shot Detection off<br> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>4</span>
</code></pre></div></p> <p>//Set Counter to measure the period between on and off, check if it's blinking because of an obstruction <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>CounterType</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>CounterDebounce</span><span class=w> </span><span class=mi>100</span>
</code></pre></div></p> <p>//So the door doesn't close if you send it an Open when it's already Opened, etc.<br> <div class=highlight><pre><span></span><code>// var1=1 Only When OPEN  
// var2=1 Only When CLOSED  
// var3=1 Only When OPENING  
// var4=1 Only When CLOSING  
</code></pre></div> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>Boot</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=mi>99</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>Opened</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch2</span><span class=o>#</span><span class=kt>Boot</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=mi>99</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>Closed</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>EVENT</span><span class=o>#</span><span class=kt>OPEN</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var2</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>EVENT</span><span class=o>#</span><span class=kt>CLOSE</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>EVENT</span><span class=o>#</span><span class=kt>STOP</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var3</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var4</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PState</span><span class=ow>=</span><span class=kt>STOP</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>Opened</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch2</span><span class=o>#</span><span class=kt>State</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>Closed</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>Closing</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch2</span><span class=o>#</span><span class=kt>State</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>Opening</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule2</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>Opened</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PState</span><span class=ow>=</span><span class=kt>OPEN</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>Closed</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PState</span><span class=ow>=</span><span class=kt>CLOSE</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>Opening</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>15</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PState</span><span class=ow>=</span><span class=kt>OPENING</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>Closing</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>ruletimer1</span><span class=w> </span><span class=mi>15</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PState</span><span class=ow>=</span><span class=kt>CLOSING</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule3</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>counter</span><span class=o>#</span><span class=n>c1</span><span class=o>&gt;</span><span class=mi>1000</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PObstr</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>counter</span><span class=o>#</span><span class=n>c1</span><span class=o>&lt;</span><span class=mi>1000</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PObstr</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>PObstr</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=kt>GarageDoor</span><span class=o>/</span><span class=kt>OBSTR</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=kt>PState</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/</span><span class=kt>GarageDoor</span><span class=o>/</span><span class=kt>STATE</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>rules</span><span class=o>#</span><span class=n>timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=kt>PState</span><span class=ow>=</span><span class=kt>STOP</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>//Turn on Rules<br> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>Rule2</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>Rule3</span><span class=w> </span><span class=mi>1</span>
</code></pre></div></p> <hr> <h3 id=ir-remote-button-multi-press>IR Remote Button Multi-press<a class=headerlink href=#ir-remote-button-multi-press title="Permanent link">~</a></h3> <p>For example, a remote control with one button to change speed. This rules simulates pressing the button three times to set the receiving device to the third speed setting. </p> <p>Specify the rule set </p> <ul> <li>The <code>&lt;trigger&gt;</code> can be a condition or an event sent from another device or home automation hub.</li> <li><code>&lt;topic&gt;</code> corresponds to the device transmitting the code (e.g., <a href=../devices/YTF-IR-Bridge/ >YTF IR Bridge</a>). This could also be modified to send an RF code from a <a href=../devices/Sonoff-RF-Bridge-433/ >Sonoff RF Bridge</a>. </li> <li>The <code>Delay</code> may not be necessary in your environment or may need to be adjusted according to your device characteristics. </li> </ul> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=mi>1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Event</span><span class=o>#</span><span class=n>tora</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Publish</span><span class=w> </span><span class=n>cmnd</span><span class=o>/&lt;</span><span class=n>topic</span><span class=o>&gt;/</span><span class=kt>IRSend</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Protocol&quot;</span><span class=kt>:</span><span class=s>&quot;NEC&quot;</span><span class=p>,</span><span class=s>&quot;Bits&quot;</span><span class=kt>:</span><span class=mi>32</span><span class=p>,</span><span class=s>&quot;Data&quot;</span><span class=kt>:</span><span class=s>&quot;0x00FF30CF&quot;</span><span class=p>};</span><span class=w> </span><span class=kt>Delay</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=o>&lt;</span><span class=n>trigger</span><span class=o>&gt;</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Event</span><span class=w> </span><span class=n>tora</span><span class=p>;</span><span class=w> </span><span class=kt>Event</span><span class=w> </span><span class=n>tora</span><span class=p>;</span><span class=w> </span><span class=kt>Event</span><span class=w> </span><span class=n>tora</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <ul> <li>Enable the Rule set<br> <code>Rule1 1</code></li> </ul> <hr> <h3 id=two-way-light-switches-without-mqtt>Two-way light switches without MQTT<a class=headerlink href=#two-way-light-switches-without-mqtt title="Permanent link">~</a></h3> <p>Two Sonoff T1 3-gang light switches can be used at either end of a room by setting up one the master and the other as the slave. The master performs the switching of the power to the lights, while the slave just asks the master to toggle the power state. The master also turns the slave's relays on and off so that the LED indicators follow the master's state.</p> <p>Using the <code>WebSend</code> command, the two switches can talk to each other without an MQTT broker. It remains to be seen how reliable this is.</p> <p>Starting with the slave, the rule to toggle the master is pretty simple:</p> <p><div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Event</span><span class=o>#</span><span class=n>sendPower</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>WebSend</span><span class=w> </span><span class=p>[</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>0.74</span><span class=p>]</span><span class=w> </span><span class=kt>POWER</span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>TOGGLE</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Button1</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Event</span><span class=w> </span><span class=n>sendPower</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Button2</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Event</span><span class=w> </span><span class=n>sendPower</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Button3</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Event</span><span class=w> </span><span class=n>sendPower</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <code>Rule1 1</code></p> <p>Note that having a rule for the Button#State disables the power toggling of the slave's relay(s). This is desirable because we want the master to control the slave's relay state(s) according to its own as follows:</p> <p><div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Event</span><span class=o>#</span><span class=n>sendPower</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>WebSend</span><span class=w> </span><span class=p>[</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>0.144</span><span class=p>]</span><span class=w> </span><span class=kt>POWER</span><span class=o>%</span><span class=kt>Var1</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=kt>Event</span><span class=w> </span><span class=n>sendPower</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power2</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=kt>Event</span><span class=w> </span><span class=n>sendPower</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Power3</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=kt>Event</span><span class=w> </span><span class=n>sendPower</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <code>Rule1 1</code></p> <hr> <h3 id=control-remote-light-on-switch-double-press>Control remote light on switch double press<a class=headerlink href=#control-remote-light-on-switch-double-press title="Permanent link">~</a></h3> <p>Toggling the switch controls local POWER state while toggling twice fast controls another device.</p> <p>Great with two SONOFF MINI in adjacent rooms, to control both rooms with either switch.</p> <div class=highlight><pre><span></span><code><span class=kt>SwitchMode</span><span class=w> </span><span class=mi>8</span>
<span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>websend</span><span class=w> </span><span class=p>[</span><span class=n>ip</span><span class=o>/</span><span class=n>hostname</span><span class=w> </span><span class=kr>of</span><span class=w> </span><span class=n>remote</span><span class=p>]</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=n>toggle</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <hr> <h3 id=roller-shutter-push-button-toggle>Roller shutter push-button toggle<a class=headerlink href=#roller-shutter-push-button-toggle title="Permanent link">~</a></h3> <p>With a two relay device (e.g., Shelly 2.5) configured for a roller shutter, you can also connect push-buttons (configured as switch components in this example) and set them for inverted toggle behavior. Pressing a push-button once makes the roller shutter move in one direction. Pressing it again stops it. These rules each use a variable to remember the shutter state where <code>0 == Stopped</code> and <code>1 == Moving</code>.</p> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchTopic</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode1</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=kt>SwitchMode2</span><span class=w> </span><span class=mi>4</span>

<span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Add1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var1</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>ShutterStop1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var1</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>ShutterClose1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var1</span><span class=o>#</span><span class=kt>State</span><span class=o>&gt;=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Shutter1</span><span class=o>#</span><span class=kt>Close</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch2</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Add2</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var2</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>ShutterStop1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var2</span><span class=o>#</span><span class=kt>State</span><span class=o>==</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>ShutterOpen1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var2</span><span class=o>#</span><span class=kt>State</span><span class=o>&gt;=</span><span class=mi>2</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var2</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Shutter1</span><span class=o>#</span><span class=kt>Open</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var2</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>

<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <h3 id=control-a-dimmer-with-one-switch>Control a dimmer with one switch<a class=headerlink href=#control-a-dimmer-with-one-switch title="Permanent link">~</a></h3> <div class="admonition note"> <p class=admonition-title>This example is for GPIOs defined as switches not buttons</p> </div> <p>Activate dimmer mode with <code>Switchmode 11</code> and shorten long press time to 1 second (<code>Setoption32 10</code>).</p> <p>A short press of the switch sends a <code>TOGGLE</code> message to toggle the dimmer. A long press sends repeated <code>INC_DEC</code> messages to increment the dimmer. If a second press of the switch follows the first press an <code>INV</code> message is sent to invert the function from increment to decrement and repeated <code>INC_DEC</code> messages are sent to decrement the dimmer. After releasing the switch a timeout message <code>CLEAR</code> resets the automation</p> <p><div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchMode</span><span class=w> </span><span class=mi>11</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption32</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>

<span class=kt>Rule1</span><span class=w> </span>
<span class=nf>on</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=kt>ENDON</span>
<span class=nf>on</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>2</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>POWER</span><span class=w> </span><span class=kt>TOGGLE</span><span class=w> </span><span class=kt>ENDON</span>
<span class=nf>on</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>4</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>DIMMER</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=nf>on</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>7</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>upordown</span><span class=o>=%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=nf>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>upordown</span><span class=o>=+</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=kt>ENDON</span>
<span class=nf>on</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>upordown</span><span class=o>=-</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> Restart Tasmota after creating the rule set. Notice we use <code>Rule</code> which edits <code>Rule1</code> rule set. They can be used interchangeably.</p> <hr> <h3 id=watchdog-for-wi-fi-router-or-modem>Watchdog for Wi-Fi router or modem<a class=headerlink href=#watchdog-for-wi-fi-router-or-modem title="Permanent link">~</a></h3> <div class="admonition note"> <p class=admonition-title>The ping method requires <code>#define USE_PING</code> and Tasmota version 8.2.0.3 or newer</p> </div> <div class="admonition note"> <p class=admonition-title>The WebQuery method requires Tasmota version 10.0.0 or newer</p> </div> <p>A Tasmota plug can check a remote host (router itself, something else connected to the router, or a site on the Internet) via an ICMP Ping or loading a URL and can power cycle the router or modem if the remote host isn't responding. In this example, an interval of 3 minutes is used. The simplest watchdog rule does not use variables:</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>|</span><span class=mi>3</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=kt>Ping4</span><span class=w> </span><span class=mf>192.168</span><span class=o>.</span><span class=mf>1.10</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Ping</span><span class=o>#</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>1.10</span><span class=o>#</span><span class=kt>Success</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Delay</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>ENDON</span>
<span class=kt>Rule1</span><span class=w> </span><span class=mi>1</span>
</code></pre></div> <p>However, if the endpoint becomes unreachable for a long time, the watchdog will keep cycling it every three minutes. This could reduce the watchdog's relay lifetime to months, at most years. A safer option would be to use an <strong>exponential backoff</strong> algorithm. <code>Var1</code> contains the current interval in minutes, which is tripled after each failed query, but limited to 1439 minutes (1 day).</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var1</span><span class=o>#</span><span class=kt>State</span><span class=o>&gt;</span><span class=mi>1439</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>1439</span><span class=w> </span><span class=kt>ENDON</span>

<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>|%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=kt>Ping4</span><span class=w> </span><span class=mf>192.168</span><span class=o>.</span><span class=mf>1.10</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Ping</span><span class=o>#</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>1.10</span><span class=o>#</span><span class=kt>Success</span><span class=o>==</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=kt>Mult1</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Delay</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Ping</span><span class=o>#</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>1.10</span><span class=o>#</span><span class=kt>Success</span><span class=o>&gt;</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>If your Tasmota doesn't have ping compiled in and your remote host has an HTTP server you can access, you can use WebQuery as below:</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Var1</span><span class=o>#</span><span class=kt>State</span><span class=o>&gt;</span><span class=mi>1439</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>1439</span><span class=w> </span><span class=kt>ENDON</span>

<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Time</span><span class=o>#</span><span class=kt>Minute</span><span class=o>|%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=kt>WebQuery</span><span class=w> </span><span class=n>http</span><span class=kt>://</span><span class=mf>192.168</span><span class=o>.</span><span class=mf>1.10</span><span class=o>/</span><span class=w> </span><span class=kt>GET</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>WebQuery</span><span class=o>#</span><span class=kt>Data</span><span class=o>$!</span><span class=kt>Done</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>backlog</span><span class=w> </span><span class=kt>Mult1</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Delay</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>WebQuery</span><span class=o>#</span><span class=kt>Data</span><span class=ow>=</span><span class=kt>Done</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Var1</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Triggering off the JSON response to webquery (and other commands) may require wrapping the command in backlog, as per example above</p> </div> <hr> <h3 id=simple-thermostat-example>Simple Thermostat Example<a class=headerlink href=#simple-thermostat-example title="Permanent link">~</a></h3> <p>As example, to be used on a Sonoff TH10 with Sensor Si7021</p> <p>This example turn on and off an output based on the temperature value and the upper set point and the lower set point. It waits until is enabled by pressing the button or by mqtt message 1 to mem1. This value is remembered. So if power cycle occurs, will resume operation. The set point values can be changed on the fly by mqtt or console commands If the Temperature sensor disconnects, the outputs will shutdown until the sensor is back again and will resume operation. When the device is power up, the thermostat also waits until the sensor value to resume operation.</p> <p>Initial Config:</p> <ul> <li>Available physical button as <strong>Switch1</strong></li> <li><strong>Relay1</strong> will be used the controller</li> <li><strong>Rules</strong> must be used to control Relay so the pushbutton must only control <strong>Switch1</strong> and not directly control the relay - For this we use SwitchMode1 3 as described below and create the necessary rules because the pushbutton control of the relay is only disabled when the rules are in place.</li> </ul> <p>Initial config on console:</p> <ul> <li><code>SwitchMode1 3</code> &lt;- Use the switch1 as pushbutton (It will allow us to disable the link between the button and the relay by inserting a rule to dictate what the pushbutton will do - <strong>NOTE: Until rules are created the pushbutton will still control the relay!</strong>)</li> <li><code>Rule1 1</code> &lt;- turn on rules</li> <li><code>Rule1 4</code> &lt;- turn off one-shot rule</li> <li><code>TelePeriod 60</code> &lt;- check temp every minute</li> <li><code>SetOption26 1</code> &lt;- use Power1 on mqtt messages</li> <li><code>SetOption0 0</code> &lt;- dont save relay status on eeprom</li> <li><code>PowerOnState 0</code> &lt;- start all relays off</li> <li><code>Mem1 0</code> &lt;- thermostat status: 0-off 1-enabled - View or set by MQTT cmnd/mqttTopic/mem1</li> <li><code>Mem2 25</code> &lt;- setpoint Temp upper limit - View or set by MQTT cmnd/mqttTopic/mem2</li> <li><code>Mem3 23</code> &lt;- setpoint Temp lower limit - View or set by MQTT cmnd/mqttTopic/mem3</li> <li><code>Var1 0</code> &lt;- thermostat actual status: 1-OK 0-NOT READY - View by MQTT cmnd/mqttTopic/var1</li> </ul> <h4 id=rules>Rules<a class=headerlink href=#rules title="Permanent link">~</a></h4> <p>On boot start a watchdog timer to check temp sensor connection.<br> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>An available button is configured as switch to set thermostat ON or OFF</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>toggling1</span><span class=o>=%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Check temp sensor connection. If fails, set to off and turn off thermostat. Also continue checking </p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Resets checking timer if temperature is connected </p> <div class=highlight><pre><span></span><code><span class=kt>Rule</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=kt>SI7021</span><span class=o>#</span><span class=n>temperature</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>30</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>ctrl_ready</span><span class=ow>=</span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>temp_demand</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Thermostat control - upper limit and lower limit and enabled </p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>ctrl_ready</span><span class=o>&gt;%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp_demand</span><span class=o>&gt;%</span><span class=n>mem2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp_demand</span><span class=o>&lt;%</span><span class=n>mem3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Thermostat can be turned On by: </p> <ul> <li>pushing button</li> <li>by command on local console: mem1 1</li> <li>by command on any other console: publish cmnd/mqttTopic/mem1 1</li> <li>or MQTT at: cmnd/mqttTopic/mem1 1</li> </ul> <p>Thermostat can be turned Off by: </p> <ul> <li>pushing button</li> <li>by command on local console: mem1 0</li> <li>by command on any other console: publish cmnd/mqttTopic/mem1 0</li> <li>or MQTT at: cmnd/mqttTopic/mem1 0</li> </ul> <p>To get the status: </p> <ul> <li><code>mem1</code> &lt;- thermostat status: 0-off 1-enabled - View or set by MQTT cmnd/mqttTopic/mem1</li> <li><code>mem2</code> &lt;- setpoint Temp upper limit - View or set by MQTT cmnd/mqttTopic/mem2</li> <li><code>mem3</code> &lt;- setpoint Temp lower limit - View or set by MQTT cmnd/mqttTopic/mem3</li> <li><code>var1</code> &lt;- thermostat actual status: 1-OK 0-NOT READY - View by MQTT cmnd/mqttTopic/var1</li> </ul> <p>Everything together:</p> <p>Initial config: </p> <div class="admonition note"> <p class=admonition-title>RuleTimer1 must be greater that TelePeriod for expected results</p> </div> <div class=highlight><pre><span></span><code><span class=kt>Backlog</span><span class=w> </span><span class=kt>SwitchMode1</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w> </span><span class=kt>Rule</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>Rule</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w> </span><span class=kt>TelePeriod</span><span class=w> </span><span class=mi>60</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption26</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>SetOption0</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>poweronstate</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>mem2</span><span class=w> </span><span class=mi>25</span><span class=p>;</span><span class=w> </span><span class=n>mem3</span><span class=w> </span><span class=mi>23</span><span class=p>;</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span>
</code></pre></div> <p>Rules</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>toggling1</span><span class=o>=%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=kt>SI7021</span><span class=o>#</span><span class=n>temperature</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>ctrl_ready</span><span class=ow>=</span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>temp_demand</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>ctrl_ready</span><span class=o>&gt;%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp_demand</span><span class=o>&gt;%</span><span class=n>mem2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp_demand</span><span class=o>&lt;%</span><span class=n>mem3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Example rules without temp sensor to test the thermostat rules</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>system</span><span class=o>#</span><span class=n>boot</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Switch1</span><span class=o>#</span><span class=kt>State</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>toggling1</span><span class=o>=%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>toggling1</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>mem1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>Rules</span><span class=o>#</span><span class=kt>Timer</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=kt>RuleTimer1</span><span class=w> </span><span class=mi>70</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>ctrl_ready</span><span class=ow>=</span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>temp_demand</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>ctrl_ready</span><span class=o>&gt;%</span><span class=n>mem1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp_demand</span><span class=o>&gt;%</span><span class=n>mem2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span><span class=w> </span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>temp_demand</span><span class=o>&lt;%</span><span class=n>mem3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>Tests: </p> <ul> <li>Push the button1. The thermostat changes to ENABLED (mem1=1)</li> <li>on console: event temp=20 (now the system receives like a tele message from temperature sensor) and will turn on the relay1 (to heat)</li> <li>on console: event temp=26 (the thermostat turn off the heater)</li> <li>on console: event temp=22 (the thermostat turn on the heater)</li> <li>wait more than a minute without using the event temp and the thermostat will turn off as there is no temperature value (like a sensor error or disconnection)</li> <li>will resume when using again the event temp</li> <li>console mem1 0, DISABLED, console mem1 1, ENABLED</li> </ul> <p>Timers:</p> <ul> <li>With the above the timers can be used to control mem1 and add a schedule to when the thermostat will be enabled<br> <code>Rule2 ON Clock#Timer=1 DO mem1 1 ENDON ON Clock#Timer=2 DO mem1 0 ENDON</code></li> </ul> <hr> <h3 id=solar-heater-control>Solar heater control<a class=headerlink href=#solar-heater-control title="Permanent link">~</a></h3> <p>In a swimming pool, a filter pump and a solar panel is installed. When the sun is shining, the pump should push water through the solar panel, to heat the pool. When it's night or cloudy, the pump should be off, to avoid cooling the pool water through the solar panel. The pump is controlled by a Sonoff TH10 with 2x DS18B20 sensors connected.</p> <p>3 rules:</p> <ul> <li>Pump should start when solar panel is more than 2 deg warmer than the pool water</li> <li>Pump should stop when solar panel is less than 1 deg warmer than the pool water</li> <li>Pump should not start if the solar panel is below 25 deg Celsius.</li> </ul> <p><code>t1</code>: pool temp<br> <code>t2</code>: panel temp<br> <code>var1</code>: in valid panel temp range?<br> <code>var2</code>: off threshold temp for panel<br> <code>var3</code>: on threshold temp for panel<br> <code>mem3</code>: lowest valid panel temp </p> <div class=highlight><pre><span></span><code><span class=nf>mem3</span><span class=w> </span><span class=mi>25</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=nf>rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>DS18B20</span><span class=o>-</span><span class=mi>1</span><span class=o>#</span><span class=n>temperature</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog0</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add2</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>;</span><span class=w> </span><span class=n>add3</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>DS18B20</span><span class=o>-</span><span class=mi>2</span><span class=o>#</span><span class=n>temperature</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>t2</span><span class=o>=%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>t2</span><span class=o>&gt;%</span><span class=n>mem3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>t2</span><span class=o>&lt;=%</span><span class=n>mem3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>t2</span><span class=o>&gt;%</span><span class=n>var3</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>event</span><span class=o>#</span><span class=n>t2</span><span class=o>&lt;%</span><span class=n>var2</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <p>To test the rule without having the sensors in place, simply enter the events for <code>t1</code> and <code>t2</code> in the console:<br> <code>Backlog event t1=21;event t2=30</code></p> <p>And watch the relay turn on and off based on the values.</p> <p>Please note that this example does not support manual override or handles missing sensor data. </p> <hr> <h3 id=energy-saving-switch>Energy Saving Switch<a class=headerlink href=#energy-saving-switch title="Permanent link">~</a></h3> <p>Example of a switch controlling a light with a condition of a required amount of lux.</p> <p>When the switch is on, the light will turn on but only when you have less than 100 lux in that room. While if the switch is off the light will be off.</p> <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>1</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>switch1</span><span class=o>#</span><span class=n>state</span><span class=ow>=</span><span class=mi>0</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Backlog</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>off</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=kt>APDS9960</span><span class=o>#</span><span class=kt>Ambient</span><span class=o>&lt;%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>Power1</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> <hr> <h3 id=use-of-variables-and-tele-in-domoticz>Use of variables and tele- in Domoticz<a class=headerlink href=#use-of-variables-and-tele-in-domoticz title="Permanent link">~</a></h3> <p>Using variables allows for storing sensor results to be used in composing a single HA message like used with Domoticz. To prevent flooding Domoticz with messages we only want to send a message at TelePeriod time. This is achieved by prefixing the <code>&lt;SensorName&gt;</code> with the label <code>tele-</code>. This example will use a variable storing the temperature to be used together with humidity in one Domoticz MQTT message.</p> <ul> <li>Domoticz configured with a virtual sensor Temp+Hum using Idx 134</li> </ul> <p>Rule <div class=highlight><pre><span></span><code><span class=kt>Rule</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=n>am2301</span><span class=o>-</span><span class=mi>12</span><span class=o>#</span><span class=n>temperature</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
<span class=w>  </span><span class=kt>ON</span><span class=w> </span><span class=n>tele</span><span class=o>-</span><span class=n>am2301</span><span class=o>-</span><span class=mi>12</span><span class=o>#</span><span class=n>humidity</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>domoticz</span><span class=o>/</span><span class=kr>in</span><span class=w> </span><span class=p>{</span><span class=s>&quot;idx&quot;</span><span class=kt>:</span><span class=mi>134</span><span class=p>,</span><span class=s>&quot;svalue&quot;</span><span class=kt>:</span><span class=s>&quot;%var1%;%value%;1&quot;</span><span class=p>}</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div></p> <p>Result - As a result of the <code>tele-</code> prefix the rules will be checked at TelePeriod time for sensor AM2301-12 Temperature and Humidity. The first rule will use the Temperature stored in <code>%value%</code> and save it in <code>%var1%</code> for future use. The second rule will use the Humidity stored in <code>%value%</code> and the Temperature stored in <code>%var1%</code> to compose a single MQTT message suitable for Domoticz. </p> <hr> <h3 id=publish-maximum-value-from-sensor-in-a-time-period>Publish Maximum Value from sensor in a time period<a class=headerlink href=#publish-maximum-value-from-sensor-in-a-time-period title="Permanent link">~</a></h3> <p>This rule stores the sensor value in <code>var1</code>. When the current value is greater than the previous, <code>var1</code> is updated. If the current value is smaller, <code>var1</code> remains unchanged. Then every minute, <code>var1</code> is published and reset. This results in publication of the maximum/peak value for the last minute. Useful, for example in a decibel meter, when the peak value is important, rather than the value that is occurring by chance at normal telemetry time.</p> <p>This example uses Analog Range mode (trigger <code>analog#range</code>) which is a scaled output value (the raw analog value would be <code>analog#a0</code>). On ESP32 which supports multiple ADC inputs, the ADC index must be appended such as <code>analog#range1</code> for ADC#1.</p> <div class=highlight><pre><span></span><code>Rule
  ON analog#range&gt;%var1% DO VAR1 %value% ENDON
  ON Time#Minute DO Backlog publish shed/tele/maxdb %var1%; var1 0 ENDON

Rule 1 1
</code></pre></div> <hr> <h3 id=rf-repeater-ir-repeater>RF Repeater / IR Repeater<a class=headerlink href=#rf-repeater-ir-repeater title="Permanent link">~</a></h3> <p>In some applications, an RF-Repeater may come in handy to increase the range of RF based devices. We need to use RF receiver and RF transmitter modules with tasmota powered controllers. The following rule looks for data received by the RF receiver and re transmits the same over the transmitter.</p> <p><div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=n>on</span><span class=w> </span><span class=kt>RfReceived</span><span class=o>#</span><span class=kr>data</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>RfSend</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Data&quot;</span><span class=kt>:%</span><span class=n>value</span><span class=o>%</span><span class=p>,</span><span class=s>&quot;Bits&quot;</span><span class=kt>:</span><span class=mi>24</span><span class=p>,</span><span class=s>&quot;Protocol&quot;</span><span class=kt>:</span><span class=mi>1</span><span class=p>,</span><span class=s>&quot;Pulse&quot;</span><span class=kt>:</span><span class=mi>454</span><span class=p>}</span><span class=w> </span><span class=n>endon</span>
</code></pre></div> Enable it with <code>Rule1 1</code></p> <p>A similar concept can also work for IR- Repeater. Connect IR receiver module and IR trnasmitter to Tasmotized device and the following rule retransmits any data over IR <div class=highlight><pre><span></span><code><span class=kt>Rule1</span>
<span class=w>  </span><span class=n>on</span><span class=w> </span><span class=kt>IrReceived</span><span class=o>#</span><span class=kt>Data</span><span class=w> </span><span class=kr>do</span><span class=w> </span><span class=kt>IRsend</span><span class=w> </span><span class=p>{</span><span class=s>&quot;Protocol&quot;</span><span class=kt>:</span><span class=s>&quot;NEC&quot;</span><span class=p>,</span><span class=s>&quot;Bits&quot;</span><span class=kt>:</span><span class=mi>32</span><span class=p>,</span><span class=s>&quot;Data&quot;</span><span class=kt>:%</span><span class=n>value</span><span class=o>%</span><span class=p>}</span><span class=w> </span><span class=n>endon</span>
</code></pre></div> Enable it with <code>Rule1 1</code></p> <p>The only catch is that the protocol needs to be setup in the rule. Most likely this can be taken care of by using a more complex rule maybe using variables. Would update in future</p> <hr> <h3 id=power-led-brightness-indicates-power-load>Power LED brightness indicates Power Load<a class=headerlink href=#power-led-brightness-indicates-power-load title="Permanent link">~</a></h3> <p>Uses the power LED to indicate the power load.</p> <ul> <li>Relay off - Power LED off</li> <li>Relay on - Power LED dimmed to minimum of 50% (<code>128</code>) which equals no power consumption (<code>0W</code>) the remaining possible brightness (50%-100%) correlates with the power consumption (100% = <code>255</code>, equals <code>200W</code>)</li> </ul> <p><div class=highlight><pre><span></span><code><span class=o>#</span><span class=w> </span><span class=n>enable</span><span class=w> </span><span class=kt>PWM</span><span class=w> </span><span class=n>mode</span>
<span class=kt>LedPwmMode1</span><span class=w> </span><span class=mi>1</span>

<span class=kt>Rule1</span><span class=w> </span><span class=kt>ON</span><span class=w> </span><span class=kt>ENERGY</span><span class=o>#</span><span class=kt>Power</span><span class=w> </span><span class=kt>DO</span><span class=w> </span><span class=kt>BACKLOG</span><span class=w> </span><span class=kt>Scale1</span><span class=w> </span><span class=o>%</span><span class=n>value</span><span class=o>%</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>200</span><span class=p>,</span><span class=mi>128</span><span class=p>,</span><span class=mi>255</span><span class=p>;</span><span class=w> </span><span class=kt>LedPwmOn</span><span class=w> </span><span class=o>%</span><span class=n>var1</span><span class=o>%</span><span class=w> </span><span class=kt>ENDON</span>
</code></pre></div> Enable it with <code>Rule1 1</code></p> <hr> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M256 8a248 248 0 1 0 0 496 248 248 0 1 0 0-496m115 168.7c-3.7 39.2-19.9 134.4-28.1 178.3-3.5 18.6-10.3 24.8-16.9 25.4-14.4 1.3-25.3-9.5-39.3-18.7-21.8-14.3-34.2-23.2-55.3-37.2-24.5-16.1-8.6-25 5.3-39.5 3.7-3.8 67.1-61.5 68.3-66.7.2-.7.3-3.1-1.2-4.4s-3.6-.8-5.1-.5c-2.2.5-37.1 23.5-104.6 69.1-9.9 6.8-18.9 10.1-26.9 9.9-8.9-.2-25.9-5-38.6-9.1-15.5-5-27.9-7.7-26.8-16.3.6-4.5 6.7-9 18.4-13.7 72.3-31.5 120.5-52.3 144.6-62.3 68.9-28.6 83.2-33.6 92.5-33.8 2.1 0 6.6.5 9.6 2.9 2 1.7 3.2 4.1 3.5 6.7.5 3.2.6 6.5.4 9.8z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "content.action.edit", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../assets/javascripts/bundle.79ae519e.min.js></script> <script src=https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js></script> <script src=../extra_javascript/tablesort.js></script> </body> </html>